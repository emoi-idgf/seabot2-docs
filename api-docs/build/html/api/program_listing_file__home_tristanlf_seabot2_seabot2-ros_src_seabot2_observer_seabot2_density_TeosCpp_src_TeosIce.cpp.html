

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Program Listing for File TeosIce.cpp &mdash; Seabot2 ROS2 API 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/collapsible-lists/css/tree_view.css?v=a885cde7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js?v=73120307"></script>
      <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js?v=660e4f45"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #1D8BC2" >

          
          
          <a href="../index.html" class="icon icon-home">
            Seabot2 ROS2 API
              <img src="../_static/seabot2_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="library_root.html">Seabot2 C++ API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #1D8BC2" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Seabot2 ROS2 API</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Program Listing for File TeosIce.cpp</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/api/program_listing_file__home_tristanlf_seabot2_seabot2-ros_src_seabot2_observer_seabot2_density_TeosCpp_src_TeosIce.cpp.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="program-listing-for-file-teosice-cpp">
<span id="program-listing-file-home-tristanlf-seabot2-seabot2-ros-src-seabot2-observer-seabot2-density-teoscpp-src-teosice-cpp"></span><h1>Program Listing for File TeosIce.cpp<a class="headerlink" href="#program-listing-for-file-teosice-cpp" title="Link to this heading"></a></h1>
<p>↰ <a class="reference internal" href="file__home_tristanlf_seabot2_seabot2-ros_src_seabot2_observer_seabot2_density_TeosCpp_src_TeosIce.cpp.html#file-home-tristanlf-seabot2-seabot2-ros-src-seabot2-observer-seabot2-density-teoscpp-src-teosice-cpp"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">/home/tristanlf/seabot2/seabot2-ros/src/seabot2_observer/seabot2_density/TeosCpp/src/TeosIce.cpp</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;TeosIce.h&quot;</span>

<span class="cm">/******************************************</span>
<span class="cm">  TeosIce.cpp      Version 1.06</span>
<span class="cm">  by Randall Kent Whited</span>
<span class="cm">  rkwhited@gmail.com</span>
<span class="cm">  ---------------------------------------</span>
<span class="cm">  All copyrights and all license issues</span>
<span class="cm">  are the same as previous versions</span>
<span class="cm">  ---------------------------------------</span>
<span class="cm">  OR converted from .m Matlab files in</span>
<span class="cm">  the Teos-10 Matlab version at</span>
<span class="cm">  http://www.teos-10.org</span>
<span class="cm">*******************************************/</span>

<span class="n">TeosIce</span><span class="o">::</span><span class="n">TeosIce</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="n">TeosBase</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">   </span><span class="k">try</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="n">statusOk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">catch</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="n">statusOk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">e</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">badBaseAlloc</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">catch</span><span class="w"> </span><span class="p">(...)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="n">statusOk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">TeosIce</span><span class="o">::~</span><span class="n">TeosIce</span><span class="p">()</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_pot_enthalpy_from_specvol_ice                 potential enthalpy from</span>
<span class="cm">%                                                    specific volume of ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE: gsw_pot_enthalpy_from_specvol_ice(specvol_ice,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the potential enthalpy of ice from the specific volume</span>
<span class="cm">%  of ice.  The reference sea pressure of the potential enthalpy is zero</span>
<span class="cm">%  dbar.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  specvol_ice  =  specific volume                               [ m^3/kg ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  pot_enthalpy_ice  =  potential enthalpy of ice                  [ J/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., and S.J. Wotherspoon, 2014: A simple modification of</span>
<span class="cm">%   Newton|s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pot_enthalpy_from_specvol_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">specvol_ice</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">rho_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">specvol_ice</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_from_rho_ice</span><span class="p">(</span><span class="n">rho_ice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pt0_from_t_ice</span><span class="p">(</span><span class="n">t_ice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">gsw_pot_enthalpy_from_pt_ice</span><span class="p">(</span><span class="n">pt0_ice</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_t_from_rho_ice                        temperature from density of ice</span>
<span class="cm">% =========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE: gsw_t_from_rho_ice(rho_ice,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the in-situ temperature of ice, for given values of its</span>
<span class="cm">%  density and sea pressure (in dbar).</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  rho_ice =  density of ice                                     [ kg/m^3 ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  t_ice  =  in-situ temperature of ice                           [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall &amp; Paul Barker                      [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%    See section 2.5 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., D.R. Jackett, D.G. Wright and R. Feistel, 2003:</span>
<span class="cm">%   Accurate and computationally efficient algorithms for potential</span>
<span class="cm">%   temperature and density of seawater.  J. Atmosph. Ocean. Tech., 20,</span>
<span class="cm">%   pp. 730-741.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling., 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_t_from_rho_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">rho_ice</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">v_t_ice</span><span class="p">,</span><span class="w"> </span><span class="n">t_ice</span><span class="p">,</span><span class="w"> </span><span class="n">v_freezing</span><span class="p">,</span><span class="w"> </span><span class="n">t_freezing</span><span class="p">,</span><span class="w"> </span><span class="n">v_173_15</span><span class="p">,</span><span class="n">v_93_15</span><span class="p">,</span><span class="n">v_63_15</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">t_ice_mean</span><span class="p">,</span><span class="w"> </span><span class="n">delta_v_ice</span><span class="p">,</span><span class="w"> </span><span class="n">t_ice_old</span><span class="p">,</span><span class="w"> </span><span class="n">specvol_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">rho_ice</span><span class="p">;</span>

<span class="w">   </span><span class="n">v_173_15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_specvol_ice</span><span class="p">(</span><span class="mf">-100.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<span class="w">   </span><span class="n">t_freezing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">   </span><span class="n">v_freezing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_specvol_ice</span><span class="p">(</span><span class="n">t_freezing</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">specvol_ice</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">v_173_15</span><span class="p">)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="n">v_93_15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_specvol_ice</span><span class="p">(</span><span class="mf">-180.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">      </span><span class="n">v_63_15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_specvol_ice</span><span class="p">(</span><span class="mf">-210.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">      </span><span class="n">t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-180.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">30.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">specvol_ice</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_93_15</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">v_93_15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_63_15</span><span class="p">);</span><span class="w">  </span><span class="c1">// initial estimate.</span>
<span class="w">      </span><span class="n">v_t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v_63_15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_93_15</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">-30.0</span><span class="p">);</span><span class="w"> </span><span class="c1">//initial estimate of v_t_ice, the t derivative of v</span>

<span class="w">      </span><span class="n">t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-100.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">80.0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">specvol_ice</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_173_15</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">v_173_15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_93_15</span><span class="p">);</span><span class="w">  </span><span class="c1">// initial estimate.</span>
<span class="w">      </span><span class="n">v_t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v_93_15</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_173_15</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">-80.0</span><span class="p">);</span><span class="w"> </span><span class="c1">//initial estimate of v_t_ice, the t derivative of v</span>

<span class="w">      </span><span class="n">t_ice</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">(</span><span class="mf">100.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t_freezing</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">specvol_ice</span><span class="w"> </span><span class="o">-</span>
<span class="w">                  </span><span class="n">v_freezing</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">v_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_173_15</span><span class="p">));</span><span class="w">  </span><span class="c1">// initial estimate.</span>

<span class="w">      </span><span class="n">v_t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_173_15</span><span class="p">)</span><span class="w"> </span><span class="o">/</span>
<span class="w">                  </span><span class="p">(</span><span class="mf">-100.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t_freezing</span><span class="p">);</span><span class="w"> </span><span class="c1">//initial estimate of v_t_ice, the t derivative of v</span>
<span class="w">   </span><span class="p">}</span>
<span class="w">   </span><span class="k">else</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="n">t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">100.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t_freezing</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">specvol_ice</span><span class="w"> </span><span class="o">-</span>
<span class="w">                  </span><span class="n">v_freezing</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">v_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_173_15</span><span class="p">);</span><span class="w">  </span><span class="c1">//% the initial estimate of t_ice</span>

<span class="w">      </span><span class="n">v_t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_173_15</span><span class="p">)</span><span class="w"> </span><span class="o">/</span>
<span class="w">                  </span><span class="p">(</span><span class="mf">-100.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t_freezing</span><span class="p">);</span><span class="w"> </span><span class="c1">//%initial estimate of v_t_ice, the t derivative of v</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w"> </span><span class="n">iter</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="c1">//Number_of_iterations = 1:3</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="n">t_ice_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_ice</span><span class="p">;</span>
<span class="w">      </span><span class="n">delta_v_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_specvol_ice</span><span class="p">(</span><span class="n">t_ice_old</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">specvol_ice</span><span class="p">;</span>
<span class="w">      </span><span class="n">t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">delta_v_ice</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">v_t_ice</span><span class="w"> </span><span class="p">;</span>

<span class="w">      </span><span class="c1">// this is half way through the modified</span>
<span class="w">      </span><span class="c1">// N-R method (McDougall and Wotherspoon, 2012)</span>

<span class="w">      </span><span class="n">t_ice_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">t_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t_ice_old</span><span class="p">);</span>
<span class="w">      </span><span class="n">v_t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t_ice_mean</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">      </span><span class="n">t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">delta_v_ice</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">v_t_ice</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">t_ice</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_specvol_ice                                    specific volume of ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  specvol_ice = gsw_specvol_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the specific volume of ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  specvol_ice  =  specific volume                               [ m^3/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_specvol_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_pot_enthalpy_ice_freezing_poly              potential enthalpy of ice</span>
<span class="cm">%                                                 at which seawater freezes</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_pot_enthalpy_ice_freezing(SA,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the potential enthalpy of ice at which seawater freezes.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  pot_enthalpy_ice_freezing = potential enthalpy of ice at freezing</span>
<span class="cm">%                              of seawater                         [ J/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pot_enthalpy_ice_freezing</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">pt0_ice</span><span class="p">,</span><span class="w"> </span><span class="n">t_freezing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>

<span class="w">    </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pt0_from_t_ice</span><span class="p">(</span><span class="n">t_freezing</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_pot_enthalpy_from_pt_ice</span><span class="p">(</span><span class="n">pt0_ice</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_pt0_from_t_ice                           potential temperature of ice</span>
<span class="cm">%                                       with a reference pressure of 0 dbar</span>
<span class="cm">% =========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_pt0_from_t_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates potential temperature of ice Ih with a reference pressure of</span>
<span class="cm">%  0 dbar, from in-situ temperature, t.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t   =  in-situ temperature  (ITS-90)                           [ deg C ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  pt0_ice  =  potential temperature of ice Ih with reference pressure of</span>
<span class="cm">%              zero dbar (ITS-90)                                 [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker.                   [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%    See appendix I of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall T. J. and S. J. Wotherspoon, 2013: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pt0_from_t_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dentropy</span><span class="p">,</span><span class="w"> </span><span class="n">dentropy_dt</span><span class="p">,</span><span class="w"> </span><span class="n">pt0_ice</span><span class="p">,</span>
<span class="w">             </span><span class="n">pt0_ice_old</span><span class="p">,</span><span class="w"> </span><span class="n">ptm_ice</span><span class="p">,</span><span class="w"> </span><span class="n">true_entropy</span><span class="p">,</span>
<span class="w">             </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.256611570832386e-4</span><span class="p">,</span>
<span class="w">             </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-6.045305921314694e-7</span><span class="p">,</span>
<span class="w">             </span><span class="n">s3</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">5.546699019612661e-9</span><span class="p">,</span>
<span class="w">             </span><span class="n">s4</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.795030639186685e-11</span><span class="p">,</span>
<span class="w">             </span><span class="n">s5</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.292346094030742e-9</span><span class="p">,</span>
<span class="w">             </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.259745637898635e-4</span><span class="p">,</span>
<span class="w">             </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.486236778150360e-9</span><span class="p">,</span>
<span class="w">             </span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">6.257869607978536e-12</span><span class="p">,</span>
<span class="w">             </span><span class="n">p4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.253795281359302e-7</span><span class="p">,</span>
<span class="w">             </span><span class="n">p5</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">6.752596995671330e-9</span><span class="p">,</span>
<span class="w">             </span><span class="n">p6</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.082992190070936e-11</span><span class="p">,</span>
<span class="w">             </span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.849191185294459e-15</span><span class="p">,</span>
<span class="w">             </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">9.330347971181604e-11</span><span class="p">,</span>
<span class="w">             </span><span class="n">q3</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">3.415888886921213e-13</span><span class="p">,</span>
<span class="w">             </span><span class="n">q4</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.064901553161811e-12</span><span class="p">,</span>
<span class="w">             </span><span class="n">q5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.454060359158787e-10</span><span class="p">,</span>
<span class="w">             </span><span class="n">q6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.323461372791532e-13</span><span class="p">;</span>

<span class="w">    </span><span class="n">true_entropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_part_t</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">-45.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">-273.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">p4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">p5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p6</span><span class="o">*</span><span class="n">t</span><span class="p">)));</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="p">)</span><span class="w"> </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">-273.0</span><span class="p">)</span><span class="w"> </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span>
<span class="w">        </span><span class="n">dentropy_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_pt0_pt0</span><span class="p">(</span><span class="n">pt0_ice</span><span class="p">);</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">                </span><span class="n">number_of_iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice</span><span class="p">;</span>
<span class="w">            </span><span class="n">dentropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_pt0</span><span class="p">(</span><span class="n">pt0_ice_old</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">true_entropy</span><span class="p">;</span>
<span class="w">            </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dentropy</span><span class="o">/</span><span class="n">dentropy_dt</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptm_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="p">);</span>
<span class="w">            </span><span class="n">dentropy_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_pt0_pt0</span><span class="p">(</span><span class="n">ptm_ice</span><span class="p">);</span>
<span class="w">            </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dentropy</span><span class="o">/</span><span class="n">dentropy_dt</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">s1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">s2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">s3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="n">s4</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">s5</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="n">dentropy_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_pt0_pt0</span><span class="p">(</span><span class="n">pt0_ice</span><span class="p">);</span>
<span class="w">        </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice</span><span class="p">;</span>
<span class="w">        </span><span class="n">dentropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_pt0</span><span class="p">(</span><span class="n">pt0_ice_old</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">true_entropy</span><span class="p">;</span>
<span class="w">        </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dentropy</span><span class="o">/</span><span class="n">dentropy_dt</span><span class="p">;</span>
<span class="w">        </span><span class="n">ptm_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">dentropy_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_pt0_pt0</span><span class="p">(</span><span class="n">ptm_ice</span><span class="p">);</span>
<span class="w">        </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dentropy</span><span class="o">/</span><span class="n">dentropy_dt</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">-273.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">q2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">q4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">q5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q6</span><span class="o">*</span><span class="n">t</span><span class="p">)));</span>
<span class="w">        </span><span class="n">dentropy_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_pt0_pt0</span><span class="p">(</span><span class="n">pt0_ice</span><span class="o">+</span><span class="mf">0.01</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">                </span><span class="n">number_of_iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice</span><span class="p">;</span>
<span class="w">            </span><span class="n">dentropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_pt0</span><span class="p">(</span><span class="n">pt0_ice_old</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">true_entropy</span><span class="p">;</span>
<span class="w">            </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dentropy</span><span class="o">/</span><span class="n">dentropy_dt</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptm_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="p">);</span>
<span class="w">            </span><span class="n">ptm_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptm_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.01</span><span class="p">;</span>
<span class="w">            </span><span class="n">dentropy_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_pt0_pt0</span><span class="p">(</span><span class="n">ptm_ice</span><span class="p">);</span>
<span class="w">            </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dentropy</span><span class="o">/</span><span class="n">dentropy_dt</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pt0_ice</span><span class="p">);</span>
<span class="p">}</span>



<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_gibbs_ice_part_t        part of the derivative of Gibbs energy of ice</span>
<span class="cm">% =========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_gibbs_ice_part_t(nt,np,t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  part of the the first temperature derivative of Gibbs energy of ice</span>
<span class="cm">%  that is the output is gibbs_ice(1,0,t,p) + S0</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t   =  in-situ temperature (ITS-90)                            [ deg C ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  gibbs_ice_part_t = part of temperature derivative       [ J kg^-1 K^-1 ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IAPWS, 2009: Revised Release on the Equation of State 2006 for H2O Ice</span>
<span class="cm">%   Ih. The International Association for the Properties of Water and</span>
<span class="cm">%   Steam. Doorwerth, The Netherlands, September 2009.</span>
<span class="cm">%</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See appendix I.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_gibbs_ice_part_t</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">dzi</span><span class="p">,</span><span class="w"> </span><span class="n">tau</span><span class="p">;</span>
<span class="w">    </span><span class="n">complex</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">tau_t1</span><span class="p">,</span><span class="w"> </span><span class="n">tau_t2</span><span class="p">,</span><span class="w"> </span><span class="n">r2</span><span class="p">;</span>

<span class="w">    </span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="p">)</span><span class="o">*</span><span class="n">gic</span><span class="p">.</span><span class="n">rec_tt</span><span class="p">;</span>
<span class="w">    </span><span class="n">dzi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">db2pa</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">gic</span><span class="p">.</span><span class="n">rec_pt</span><span class="p">;</span>
<span class="w">    </span><span class="n">tau_t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tau</span><span class="o">/</span><span class="n">t1</span><span class="p">;</span>
<span class="w">    </span><span class="n">tau_t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tau</span><span class="o">/</span><span class="n">t2</span><span class="p">;</span>
<span class="w">    </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r20</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dzi</span><span class="o">*</span><span class="p">(</span><span class="n">r21</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r22</span><span class="o">*</span><span class="n">dzi</span><span class="p">);</span>

<span class="w">    </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r1</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">((</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tau_t1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tau_t1</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">tau_t1</span><span class="p">)</span>
<span class="w">         </span><span class="o">+</span><span class="w"> </span><span class="n">r2</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">((</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tau_t2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tau_t2</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">tau_t2</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">real</span><span class="p">(</span><span class="n">g</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_gibbs_ice_part_pt0      part of the derivative of Gibbs energy of ice</span>
<span class="cm">% =========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_gibbs_ice_pt0(pt0)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  part of the the first temperature derivative of Gibbs energy of ice</span>
<span class="cm">%  that is the outout is &quot;gibbs_ice(1,0,pt0,0) + s0&quot;</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  pt0  =  potential temperature with reference sea pressure of zero dbar</span>
<span class="cm">%                                                                 [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  gibbs_ice_part_pt0 = part of temperature derivative     [ J kg^-1 K^-1 ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IAPWS, 2009: Revised Release on the Equation of State 2006 for H2O Ice</span>
<span class="cm">%   Ih. The International Association for the Properties of Water and</span>
<span class="cm">%   Steam. Doorwerth, The Netherlands, September 2009.</span>
<span class="cm">%</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See appendix I.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_gibbs_ice_pt0</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">pt0</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">tau</span><span class="p">;</span>
<span class="w">    </span><span class="n">complex</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">g</span><span class="p">,</span><span class="w"> </span><span class="n">tau_t1</span><span class="p">,</span><span class="w"> </span><span class="n">tau_t2</span><span class="p">;</span>

<span class="w">    </span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pt0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="p">)</span><span class="o">*</span><span class="n">gic</span><span class="p">.</span><span class="n">rec_tt</span><span class="p">;</span>
<span class="w">    </span><span class="n">tau_t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tau</span><span class="o">/</span><span class="n">t1</span><span class="p">;</span>
<span class="w">    </span><span class="n">tau_t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tau</span><span class="o">/</span><span class="n">t2</span><span class="p">;</span>

<span class="w">    </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r1</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">((</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tau_t1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tau_t1</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">tau_t1</span><span class="p">)</span>
<span class="w">         </span><span class="o">+</span><span class="w"> </span><span class="n">r20</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">((</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tau_t2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tau_t2</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">tau_t2</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">real</span><span class="p">(</span><span class="n">g</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_gibbs_ice_pt0_pt0       part of the derivative of Gibbs energy of ice</span>
<span class="cm">% =========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_gibbs_ice_pt0_pt0(pt0)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  The second temperature derivative of Gibbs energy of ice at the</span>
<span class="cm">%  potential temperature with reference sea pressure of zero dbar.  That is</span>
<span class="cm">%  the output is gibbs_ice(2,0,pt0,0).</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  pt0  =  potential temperature with reference sea pressure of zero dbar</span>
<span class="cm">%                                                                 [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  gibbs_ice_pt0_pt0 = temperature second derivative at pt0</span>
<span class="cm">%                                                          [ J kg^-1 K^-2 ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IAPWS, 2009: Revised Release on the Equation of State 2006 for H2O Ice</span>
<span class="cm">%   Ih. The International Association for the Properties of Water and</span>
<span class="cm">%   Steam. Doorwerth, The Netherlands, September 2009.</span>
<span class="cm">%</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See appendix I.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_gibbs_ice_pt0_pt0</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">pt0</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">tau</span><span class="p">;</span>
<span class="w">    </span><span class="n">complex</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">g</span><span class="p">;</span>

<span class="w">    </span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pt0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="p">)</span><span class="o">*</span><span class="n">gic</span><span class="p">.</span><span class="n">rec_tt</span><span class="p">;</span>

<span class="w">    </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r1</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tau</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">t1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tau</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="o">/</span><span class="n">t1</span><span class="p">)</span>
<span class="w">         </span><span class="o">+</span><span class="w"> </span><span class="n">r20</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tau</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">t2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tau</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0</span><span class="o">/</span><span class="n">t2</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">gic</span><span class="p">.</span><span class="n">rec_tt</span><span class="o">*</span><span class="n">real</span><span class="p">(</span><span class="n">g</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_entropy_ice                                   specific entropy of ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_entropy_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates specific entropy of ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  ice_entropy  =  specific entropy of ice                 [ J kg^-1 K^-1 ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_entropy_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_enthalpy_ice                                 specific enthalpy of ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_enthalpy_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the specific enthalpy of ice (h_Ih).</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%        ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  enthalpy_ice  =  specific enthalpy of ice                       [ J/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tau</span><span class="p">,</span><span class="w"> </span><span class="n">dzi</span><span class="p">,</span><span class="w"> </span><span class="n">g0</span><span class="p">;</span>
<span class="w">    </span><span class="n">complex</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">r2</span><span class="p">,</span><span class="w"> </span><span class="n">sqtau_t1</span><span class="p">,</span><span class="w"> </span><span class="n">sqtau_t2</span><span class="p">,</span><span class="w"> </span><span class="n">g</span><span class="p">;</span>

<span class="w">    </span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="p">)</span><span class="o">*</span><span class="n">gic</span><span class="p">.</span><span class="n">rec_tt</span><span class="p">;</span>
<span class="w">    </span><span class="n">dzi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">db2pa</span><span class="o">*</span><span class="n">p</span><span class="o">*</span><span class="n">gic</span><span class="p">.</span><span class="n">rec_pt</span><span class="p">;</span>
<span class="w">    </span><span class="n">g0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gic</span><span class="p">.</span><span class="n">g00</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dzi</span><span class="o">*</span><span class="p">(</span><span class="n">gic</span><span class="p">.</span><span class="n">g01</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dzi</span><span class="o">*</span><span class="p">(</span><span class="n">gic</span><span class="p">.</span><span class="n">g02</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dzi</span><span class="o">*</span><span class="p">(</span><span class="n">gic</span><span class="p">.</span><span class="n">g03</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gic</span><span class="p">.</span><span class="n">g04</span><span class="o">*</span><span class="n">dzi</span><span class="p">)));</span>
<span class="w">    </span><span class="n">r2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r20</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dzi</span><span class="o">*</span><span class="p">(</span><span class="n">r21</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">r22</span><span class="o">*</span><span class="n">dzi</span><span class="p">);</span>
<span class="w">    </span><span class="n">sqtau_t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">tau</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">t1</span><span class="o">*</span><span class="n">t1</span><span class="p">);</span>
<span class="w">    </span><span class="n">sqtau_t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tau</span><span class="o">*</span><span class="n">tau</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">t2</span><span class="o">*</span><span class="n">t2</span><span class="p">);</span>
<span class="w">    </span><span class="n">g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">r1</span><span class="o">*</span><span class="n">t1</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sqtau_t1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqtau_t1</span><span class="p">)</span>
<span class="w">         </span><span class="o">+</span><span class="w"> </span><span class="n">r2</span><span class="o">*</span><span class="n">t2</span><span class="o">*</span><span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sqtau_t2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqtau_t2</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">g0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gic</span><span class="p">.</span><span class="n">tt</span><span class="o">*</span><span class="n">real</span><span class="p">(</span><span class="n">g</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">% gsw_latentheat_melting                             latent heat of melting</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_latentheat_melting(SA,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates latent heat, or enthalpy, of melting.  It is defined in terms</span>
<span class="cm">%  of Absolute Salinity, SA, and sea pressure, p, and is valid in the</span>
<span class="cm">%  ranges 0 &lt; SA &lt; 42 g kg^-1 and 0 &lt; p &lt; 10,000 dbar.  This is based on</span>
<span class="cm">%  the IAPWS Releases IAPWS-09 (for pure water), IAPWS-08 (for the saline</span>
<span class="cm">%  compoonent of seawater and IAPWS-06 for ice Ih.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  latentheat_melting  =  latent heat of melting                   [ J/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall &amp; Paul Barker                      [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">% IAPWS, 2008: Release on the IAPWS Formulation 2008 for the Thermodynamic</span>
<span class="cm">%  Properties of Seawater. The International Association for the Properties</span>
<span class="cm">%  of Water and Steam. Berlin, Germany, September 2008.  This Release is</span>
<span class="cm">%  known as IAPWS-09.</span>
<span class="cm">%</span>
<span class="cm">% IAPWS, 2009a: Revised Release on the Equation of State 2006 for H2O Ice</span>
<span class="cm">%  Ih. The International Association for the Properties of Water and Steam.</span>
<span class="cm">%  Doorwerth, The Netherlands, September 2009. This Release is known as</span>
<span class="cm">%  IAPWS-06</span>
<span class="cm">%</span>
<span class="cm">% IAPWS, 2009b: Supplementary Release on a Computationally Efficient</span>
<span class="cm">%  Thermodynamic Formulation for Liquid Water for Oceanographic Use. The</span>
<span class="cm">%  International Association for the Properties of Water and Steam.</span>
<span class="cm">%  Doorwerth, The Netherlands, September 2009.  This Release is known as</span>
<span class="cm">%  IAPWS-09.</span>
<span class="cm">%</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%     See section 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_latentheat_melting</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mf">1000.0</span><span class="o">*</span><span class="p">(</span><span class="n">gsw_chem_potential_water_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
<span class="w">                           </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tf</span><span class="p">)</span>
<span class="w">                           </span><span class="o">*</span><span class="n">gsw_t_deriv_chem_potential_water_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="w">                        </span><span class="o">-</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_t_freezing_first_derivatives         first derivatives of the in-situ</span>
<span class="cm">%                                     temperature at which seawater freezes</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_t_freezing_first_derivatives(SA,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the first derivatives of the in-situ temperature at which</span>
<span class="cm">%  seawater freezes with respect to Absolute Salinity SA and pressure P (in</span>
<span class="cm">%  Pa).  These expressions come from differentiating the expression that</span>
<span class="cm">%  defines the freezing temperature, namely the equality between the</span>
<span class="cm">%  chemical potentials of water in seawater and in ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  tfreezing_SA = the derivative of the in-situ freezing temperature</span>
<span class="cm">%                 (ITS-90) with respect to Absolute Salinity at fixed</span>
<span class="cm">%                 pressure                     [ K/(g/kg) ] i.e. [ K kg/g ]</span>
<span class="cm">%</span>
<span class="cm">%  tfreezing_P  = the derivative of the in-situ freezing temperature</span>
<span class="cm">%                 (ITS-90) with respect to pressure (in Pa) at fixed</span>
<span class="cm">%                 Absolute Salinity                                [ K/Pa ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tfreezing_sa</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tfreezing_p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">rec_denom</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">g_per_kg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">rec_denom</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span>
<span class="w">                    </span><span class="p">(</span><span class="n">g_per_kg</span><span class="o">*</span><span class="n">gsw_t_deriv_chem_potential_water_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
<span class="w">                     </span><span class="o">+</span><span class="w"> </span><span class="n">gsw_entropy_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tfreezing_sa</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="o">*</span><span class="n">tfreezing_sa</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">gsw_dilution_coefficient_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">rec_denom</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="o">*</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_sso</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tfreezing_p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="o">*</span><span class="n">tfreezing_p</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="o">-</span><span class="p">(</span><span class="n">gsw_specvol_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="n">gsw_gibbs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">sa</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
<span class="w">              </span><span class="o">-</span><span class="w"> </span><span class="n">gsw_specvol_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">))</span><span class="o">*</span><span class="n">rec_denom</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_t_freezing_first_derivatives_poly            first derivatives of the</span>
<span class="cm">%                             in-situ temperature at which seawater freezes</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_t_freezing_first_derivatives_poly(SA,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the frist derivatives of the in-situ temperature at which</span>
<span class="cm">%  seawater freezes with respect to Absolute Salinity SA and pressure P (in</span>
<span class="cm">%  Pa).  These expressions come from differentiating the expression that</span>
<span class="cm">%  defines the freezing temperature, namely the equality between the</span>
<span class="cm">%  chemical potentials of water in seawater and in ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  tfreezing_SA = the derivative of the in-situ freezing temperature</span>
<span class="cm">%                 (ITS-90) with respect to Absolute Salinity at fixed</span>
<span class="cm">%                 pressure                     [ K/(g/kg) ] i.e. [ K kg/g ]</span>
<span class="cm">%</span>
<span class="cm">%  tfreezing_P  = the derivative of the in-situ freezing temperature</span>
<span class="cm">%                 (ITS-90) with respect to pressure (in Pa) at fixed</span>
<span class="cm">%                 Absolute Salinity                                [ K/Pa ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_t_freezing_first_derivatives_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tfreezing_sa</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">tfreezing_p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">p_r</span><span class="p">,</span><span class="w"> </span><span class="n">sa_r</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-3</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_sso</span><span class="p">);</span>

<span class="w">    </span><span class="n">sa_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">;</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">sa_r</span><span class="p">);</span>
<span class="w">    </span><span class="n">p_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="mf">1e-4</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tfreezing_sa</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">tfreezing_sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t1</span>
<span class="w">                          </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t5</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="mf">3.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t6</span><span class="o">*</span><span class="n">x</span><span class="p">))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t13</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t19</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t22</span><span class="o">*</span><span class="n">x</span><span class="p">))))</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t17</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t20</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t18</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t21</span><span class="o">*</span><span class="n">x</span><span class="p">)))))</span><span class="o">*</span><span class="mf">1e-2</span>
<span class="w">                           </span><span class="o">+</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="o">*</span><span class="n">c</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tfreezing_p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">tfreezing_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t7</span>
<span class="w">                          </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t13</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t16</span>
<span class="w">                          </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t19</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">t22</span><span class="o">*</span><span class="n">x</span><span class="p">)))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t12</span>
<span class="w">                          </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t17</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t20</span><span class="o">*</span><span class="n">x</span><span class="p">)))</span>
<span class="w">                          </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t9</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t18</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t21</span><span class="o">*</span><span class="n">x</span><span class="p">)))))</span><span class="o">*</span><span class="mf">1e-8</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_t_freezing_poly         in-situ temperature at which seawater freezes</span>
<span class="cm">%                                                                    (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_t_freezing_poly(SA,p,saturation_fraction,polynomial)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the in-situ temperature at which seawater freezes from a</span>
<span class="cm">%  comptationally efficient polynomial.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  t_freezing = in-situ temperature at which seawater freezes.    [ deg C ]</span>
<span class="cm">%               (ITS-90)</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall, Paul Barker and Rainer Feistal    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_t_freezing_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">int</span><span class="w"> </span><span class="n">polynomial</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">p_r</span><span class="p">,</span><span class="w"> </span><span class="n">sa_r</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">sfrac</span><span class="p">,</span><span class="w"> </span><span class="n">return_value</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">direct_poly</span><span class="o">=</span><span class="n">polynomial</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">direct_poly</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">sfrac</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">;</span>
<span class="w">        </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">sfrac</span><span class="p">);</span>
<span class="w">        </span><span class="n">return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_from_ct</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">sa_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">;</span>
<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">sa_r</span><span class="p">);</span>
<span class="w">        </span><span class="n">p_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="mf">1e-4</span><span class="p">;</span>
<span class="w">        </span><span class="n">return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">t0</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t4</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">t6</span><span class="o">*</span><span class="n">x</span><span class="p">)))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t7</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">t9</span><span class="o">*</span><span class="n">p_r</span><span class="p">))</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">t21</span><span class="o">*</span><span class="n">sa_r</span><span class="p">))</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t13</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">t17</span><span class="o">*</span><span class="n">p_r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">t19</span><span class="o">*</span><span class="n">sa_r</span><span class="p">)</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">t18</span><span class="o">*</span><span class="n">p_r</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">t16</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">t20</span><span class="o">*</span><span class="n">p_r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">t22</span><span class="o">*</span><span class="n">sa_r</span><span class="p">)));</span>

<span class="w">        </span><span class="n">return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">return_value</span><span class="w"> </span><span class="o">-</span>
<span class="w">                            </span><span class="n">saturation_fraction</span><span class="o">*</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_sso</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">return_value</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_t_freezing_poly         in-situ temperature at which seawater freezes</span>
<span class="cm">%                                                                    (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_t_freezing_poly(SA,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the in-situ temperature at which seawater freezes from a</span>
<span class="cm">%  comptationally efficient polynomial.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  t_freezing = in-situ temperature at which seawater freezes.    [ deg C ]</span>
<span class="cm">%               (ITS-90)</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall, Paul Barker and Rainer Feistal    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_t_freezing_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">gsw_t_from_ct</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_frazil_properties_potential_poly      Absolute Salinity, Conservative</span>
<span class="cm">%                               Temperature, and the ice mass fraction when</span>
<span class="cm">%              at thermodynamic equilibrium between seawater and ice (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%   gsw_frazil_properties_potential_poly(SA_bulk,h_pot_bulk,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the mass fraction of ice (mass of ice divided by mass of ice</span>
<span class="cm">%  plus seawater), w_Ih_eq, which results from given values of the bulk</span>
<span class="cm">%  Absolute Salinity, SA_bulk, bulk potential enthalpy, h_pot_bulk,</span>
<span class="cm">%  occuring at pressure p.  The final equilibrium values of Absolute</span>
<span class="cm">%  Salinity, SA_eq, and Conservative Temperature, CT_eq, of the</span>
<span class="cm">%  interstitial seawater phase are also returned.  This code assumes that</span>
<span class="cm">%  there is no dissolved air in the seawater (that is, saturation_fraction</span>
<span class="cm">%  is assumed to be zero thoughout the code).</span>
<span class="cm">%</span>
<span class="cm">%  When the mass fraction w_Ih_final is calculated as being a positive</span>
<span class="cm">%  value, the seawater-ice mixture is at thermodynamic equlibrium.</span>
<span class="cm">%</span>
<span class="cm">%  This code returns w_Ih_final = 0 when the input bulk enthalpy, h_bulk,</span>
<span class="cm">%  is sufficiently large (i.e. sufficiently &quot;warm&quot;) so that there is no ice</span>
<span class="cm">%  present in the final state.  In this case the final state consists of</span>
<span class="cm">%  only seawater rather than being an equlibrium mixture of seawater and</span>
<span class="cm">%  ice which occurs when w_Ih_final is positive.  Note that when</span>
<span class="cm">%  w_Ih_final = 0, the final seawater is not at the freezing temperature.</span>
<span class="cm">%</span>
<span class="cm">%  Note that this code uses the polynomial forms of CT_freezing and</span>
<span class="cm">%  pot_enthalpy_ice_freezing.  This code is intended to be used in ocean</span>
<span class="cm">%  models where the model prognostic variables are SA_bulk and h_pot_bulk.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA_bulk     =  bulk Absolute Salinity of the seawater and ice mixture</span>
<span class="cm">%                                                                  [ g/kg ]</span>
<span class="cm">%  h_pot_bulk  =  bulk potential enthalpy of the seawater and ice mixture</span>
<span class="cm">%                                                                  [ J/kg ]</span>
<span class="cm">%  p           =  sea pressure                                  [ dbar ]</span>
<span class="cm">%                  ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_final    =  Absolute Salinity of the seawater in the final state,</span>
<span class="cm">%                 whether or not any ice is present.               [ g/kg ]</span>
<span class="cm">%  CT_final    =  Conservative Temperature of the seawater in the the final</span>
<span class="cm">%                 state, whether or not any ice is present.       [ deg C ]</span>
<span class="cm">%  w_Ih_final  =  mass fraction of ice in the final seawater-ice mixture.</span>
<span class="cm">%                 If this ice mass fraction is positive, the system is at</span>
<span class="cm">%                 thermodynamic equilibrium.  If this ice mass fraction is</span>
<span class="cm">%                 zero there is no ice in the final state which consists</span>
<span class="cm">%                 only of seawater which is warmer than the freezing</span>
<span class="cm">%                 temperature.                                   [unitless]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of ice and sea ice into seawater, and frazil ice formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., and S.J. Wotherspoon, 2014: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  Anonymous, 2014: Modelling the interaction between seawater and frazil</span>
<span class="cm">%   ice.  Manuscript, March 2015.  See Eqns. (8)-(15) of this  manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_frazil_properties_potential_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa_bulk</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct_final</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">w_ih_final</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">iterations</span><span class="p">,</span><span class="w"> </span><span class="n">max_iterations</span><span class="p">;</span>

<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">dfunc_dw_ih</span><span class="p">,</span><span class="w"> </span><span class="n">dfunc_dw_ih_mean_poly</span><span class="p">,</span><span class="w"> </span><span class="n">dpot_h_ihf_dsa</span><span class="p">,</span>
<span class="w">              </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">func0</span><span class="p">,</span><span class="w"> </span><span class="n">h_pot_ihf</span><span class="p">,</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="n">w_ih_old</span><span class="p">,</span><span class="w"> </span><span class="n">w_ih</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">xa</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>

<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">f01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-9.041191886754806e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f02</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">4.169608567309818e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f03</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-9.325971761333677e-3</span><span class="p">,</span>
<span class="w">              </span><span class="n">f04</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">4.699055851002199e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f05</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.086923404061666e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f06</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.057761186019000e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f07</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-7.349302346007727e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f08</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.444842576424337e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f09</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.408425967872030e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f10</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.070981398567760e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.768451760854797e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-4.013688314067293e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f13</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">7.209753205388577e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.807444462285120e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f15</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.362305015808993e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-9.500974920072897e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f17</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.192134856624248</span><span class="p">,</span>
<span class="w">              </span><span class="n">f18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-9.191161283559850e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.008594411490973</span><span class="p">,</span>
<span class="w">              </span><span class="n">f20</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">8.020279271484482e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.930534388853466e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">f22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.026853316399942e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.722731069001690e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f24</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">5.032098120548072e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.354888890484222e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.454090179215001e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f27</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">4.125987229048937e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.533404753585094e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f29</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">3.766063025852511e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.358409746243470e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.242158862056258e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f32</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.102254738058931e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.048635435546108e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.996293091714222e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f35</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.577703068234217e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">f36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.292053030649309e-2</span><span class="p">,</span>
<span class="w">              </span><span class="n">g01</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">3.332286683867741e5</span><span class="p">,</span>
<span class="w">              </span><span class="n">g02</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.416532517833479e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g03</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.021129089258645e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g04</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.356370992641009e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g05</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-8.483432350173174e3</span><span class="p">,</span>
<span class="w">              </span><span class="n">g06</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.279927781684362e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g07</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.506238790315354e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g08</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">4.194030718568807e3</span><span class="p">,</span>
<span class="w">              </span><span class="n">g09</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.146939594885272e5</span><span class="p">,</span>
<span class="w">              </span><span class="n">g10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-7.549939721380912e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g11</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.790535212869292e6</span><span class="p">,</span>
<span class="w">              </span><span class="n">g12</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.078851928118102e5</span><span class="p">,</span>
<span class="w">              </span><span class="n">g13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.062493860205067e7</span><span class="p">,</span>
<span class="w">              </span><span class="n">g14</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.082909703458225e7</span><span class="p">,</span>
<span class="w">              </span><span class="n">g15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.046810820868635e7</span><span class="p">,</span>
<span class="w">              </span><span class="n">g16</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">8.039606992745191e6</span><span class="p">,</span>
<span class="w">              </span><span class="n">g17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.023984705844567e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g18</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.871769638352535e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.444841553038544e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g20</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.261532522236573e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.090579366221046e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.128417003723530e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g23</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">3.222965226084112e3</span><span class="p">,</span>
<span class="w">              </span><span class="n">g24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.226388046175992e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g25</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.506847628109789e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-4.584670946447444e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g27</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.596119496322347e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-6.338852410446789e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">g29</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">8.951570926106525e4</span><span class="p">,</span>
<span class="w">              </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">func0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span>
<span class="w">              </span><span class="o">*</span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa_bulk</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">func0</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="o">/</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">;</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func0</span><span class="o">/</span><span class="mf">3e5</span><span class="p">;</span>
<span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="mf">1e-4</span><span class="p">;</span>
<span class="w">    </span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f01</span>
<span class="w">             </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f02</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f03</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f04</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f05</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f06</span><span class="o">*</span><span class="n">x</span><span class="p">))))</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f07</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f08</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f09</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f11</span><span class="o">*</span><span class="n">x</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f13</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f15</span><span class="o">*</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f17</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f18</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f19</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f20</span><span class="o">*</span><span class="n">x</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">f21</span><span class="o">*</span><span class="n">y</span><span class="p">))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">f22</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f23</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f24</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f25</span><span class="o">*</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f26</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">f27</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f28</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f29</span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f30</span><span class="o">*</span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">f31</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f33</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f34</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f35</span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f36</span><span class="o">*</span><span class="n">y</span><span class="p">))));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_pot_ihf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pot_enthalpy_ice_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">)</span><span class="o">*</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="o">*</span><span class="n">ctf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="n">h_pot_ihf</span><span class="p">;</span>
<span class="w">    </span><span class="n">xa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">;</span>
<span class="w">    </span><span class="n">dfunc_dw_ih_mean_poly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g01</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g02</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g03</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g04</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g05</span><span class="o">*</span><span class="n">xa</span><span class="p">)))</span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g06</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g07</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g08</span><span class="o">*</span><span class="n">xa</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g09</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g10</span><span class="o">*</span><span class="n">xa</span><span class="p">)</span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g12</span><span class="o">*</span><span class="n">xa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g13</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g15</span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">g16</span><span class="o">*</span><span class="n">w_ih</span><span class="p">))))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">g17</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g18</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g19</span><span class="o">*</span><span class="n">xa</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g20</span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g21</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g22</span><span class="o">*</span><span class="n">w_ih</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g23</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g24</span><span class="o">*</span><span class="n">xa</span><span class="o">*</span><span class="n">w_ih</span><span class="p">))</span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">g25</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g26</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g27</span><span class="o">*</span><span class="n">xa</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g28</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g29</span><span class="o">*</span><span class="n">w_ih</span><span class="p">)));</span>

<span class="w">    </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih</span><span class="p">;</span>
<span class="w">    </span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="o">/</span><span class="n">dfunc_dw_ih_mean_poly</span><span class="p">;</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_pot_ihf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pot_enthalpy_ice_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_ct_freezing_first_derivatives_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ctf_sa</span><span class="p">,</span>
<span class="w">                                                        </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_pot_enthalpy_ice_freezing_first_derivatives_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">dpot_h_ihf_dsa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">dfunc_dw_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="o">*</span><span class="n">ctf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_pot_ihf</span><span class="w"> </span><span class="o">-</span>
<span class="w">                      </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="o">*</span><span class="n">ctf_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="n">dpot_h_ihf_dsa</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">w_ih</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.20</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">15.0</span>
<span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">60.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">3000.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">max_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">w_ih</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.85</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">120.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">3500.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">max_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">max_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">max_iterations</span><span class="p">;</span><span class="w"> </span><span class="n">iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iterations</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">            </span><span class="n">h_pot_ihf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pot_enthalpy_ice_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">)</span><span class="o">*</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="o">*</span><span class="n">ctf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="n">h_pot_ihf</span><span class="p">;</span>
<span class="w">        </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih</span><span class="p">;</span>
<span class="w">        </span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="o">/</span><span class="n">dfunc_dw_ih</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="o">/</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>




<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_ct_from_rho                     Conservative Temperature from density</span>
<span class="cm">%                                                        (75-term equation)</span>
<span class="cm">% =========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_ct_from_rho(rho,SA,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the Conservative Temperature of a seawater sample, for given</span>
<span class="cm">%  values of its density, Absolute Salinity and sea pressure (in dbar),</span>
<span class="cm">%  using the computationally-efficient expression for specific volume in</span>
<span class="cm">%  terms of SA, CT and p (Roquet et al., 2015).</span>
<span class="cm">%</span>
<span class="cm">%  Note that the 75-term equation has been fitted in a restricted range of</span>
<span class="cm">%  parameter space, and is most accurate inside the &quot;oceanographic funnel&quot;</span>
<span class="cm">%  described in McDougall et al. (2003).  The GSW library function</span>
<span class="cm">%  &quot;gsw_infunnel(SA,CT,p)&quot; is avaialble to be used if one wants to test if</span>
<span class="cm">%  some of one&#39;s data lies outside this &quot;funnel&quot;.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  rho  =  density of a seawater sample (e.g. 1026 kg/m^3)       [ kg/m^3 ]</span>
<span class="cm">%   Note. This input has not had 1000 kg/m^3 subtracted from it.</span>
<span class="cm">%     That is, it is &#39;density&#39;, not &#39;density anomaly&#39;.</span>
<span class="cm">%  SA   =  Absolute Salinity                                       [ g/kg ]</span>
<span class="cm">%  p    =  sea pressure                                            [ dbar ]</span>
<span class="cm">%          ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  CT  =  Conservative Temperature  (ITS-90)                      [ deg C ]</span>
<span class="cm">%  CT_multiple  =  Conservative Temperature  (ITS-90)             [ deg C ]</span>
<span class="cm">%    Note that at low salinities, in brackish water, there are two possible</span>
<span class="cm">%      Conservative Temperatures for a single density.  This programme will</span>
<span class="cm">%      output both valid solutions.  To see this second solution the user</span>
<span class="cm">%      must call the programme with two outputs (i.e. [CT,CT_multiple]), if</span>
<span class="cm">%      there is only one possible solution and the programme has been</span>
<span class="cm">%      called with two outputs the second variable will be set to NaN.</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall &amp; Paul Barker                      [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., D.R. Jackett, D.G. Wright and R. Feistel, 2003:</span>
<span class="cm">%   Accurate and computationally efficient algorithms for potential</span>
<span class="cm">%   temperature and density of seawater.  J. Atmosph. Ocean. Tech., 20,</span>
<span class="cm">%   pp. 730-741.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling, 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_ct_from_rho</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">rho</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">,</span>
<span class="w">                                 </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct_multiple</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">alpha_freezing</span><span class="p">,</span><span class="w"> </span><span class="n">alpha_mean</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">ct_a</span><span class="p">,</span><span class="w"> </span><span class="n">ct_b</span><span class="p">,</span><span class="w"> </span><span class="n">ct_diff</span><span class="p">,</span>
<span class="w">             </span><span class="n">ct_freezing</span><span class="p">,</span><span class="w"> </span><span class="n">ct_max_rho</span><span class="p">,</span><span class="w"> </span><span class="n">ct_mean</span><span class="p">,</span><span class="w"> </span><span class="n">ct_old</span><span class="p">,</span>
<span class="w">             </span><span class="n">delta_ct</span><span class="p">,</span><span class="w"> </span><span class="n">delta_v</span><span class="p">,</span><span class="w"> </span><span class="n">factor</span><span class="p">,</span><span class="w"> </span><span class="n">factorqa</span><span class="p">,</span><span class="w"> </span><span class="n">factorqb</span><span class="p">,</span>
<span class="w">             </span><span class="n">rho_40</span><span class="p">,</span><span class="w"> </span><span class="n">rho_extreme</span><span class="p">,</span><span class="w"> </span><span class="n">rho_freezing</span><span class="p">,</span><span class="w"> </span><span class="n">rho_max</span><span class="p">,</span><span class="w"> </span><span class="n">rho_mean</span><span class="p">,</span>
<span class="w">             </span><span class="n">rho_old</span><span class="p">,</span><span class="w"> </span><span class="n">sqrt_disc</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">v_ct</span><span class="p">,</span><span class="w"> </span><span class="n">v_lab</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">alpha_limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e-5</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">rec_half_rho_tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-110.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">rho_40</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_rho</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="mf">40.0</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rho</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rho_40</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">ct_max_rho</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_maxdensity</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">rho_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_rho</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct_max_rho</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">rho_extreme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rho_max</span><span class="p">;</span>
<span class="w">    </span><span class="n">ct_freezing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_rho_alpha_beta</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct_freezing</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">rho_freezing</span><span class="p">,</span><span class="o">&amp;</span><span class="n">alpha_freezing</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct_freezing</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ct_max_rho</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">rho_extreme</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rho_freezing</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rho</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">rho_extreme</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">alpha_freezing</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">alpha_limit</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ct_diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">40.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct_freezing</span><span class="p">;</span>
<span class="w">        </span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rho_40</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho_freezing</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rho_freezing</span><span class="o">*</span><span class="n">alpha_freezing</span><span class="o">*</span><span class="n">ct_diff</span><span class="p">;</span>
<span class="w">        </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top</span><span class="o">/</span><span class="p">(</span><span class="n">ct_diff</span><span class="o">*</span><span class="n">ct_diff</span><span class="p">);</span>
<span class="w">        </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">rho_freezing</span><span class="o">*</span><span class="n">alpha_freezing</span><span class="p">;</span>
<span class="w">        </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rho_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho</span><span class="p">;</span>
<span class="w">        </span><span class="n">sqrt_disc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">c</span><span class="p">);</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_freezing</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sqrt_disc</span><span class="p">)</span><span class="o">/</span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ct_diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">40.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct_max_rho</span><span class="p">;</span>
<span class="w">        </span><span class="n">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rho_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rho_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho_40</span><span class="p">);</span>
<span class="w">        </span><span class="n">delta_ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_diff</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">factor</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delta_ct</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">5.0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_max_rho</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">delta_ct</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ct_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_max_rho</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">rec_half_rho_tt</span><span class="o">*</span><span class="p">(</span><span class="n">rho</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho_max</span><span class="p">));</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<span class="w">                    </span><span class="n">number_of_iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">ct_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_a</span><span class="p">;</span>
<span class="w">                </span><span class="n">rho_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_rho</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct_old</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">                </span><span class="n">factorqa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rho_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rho_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho_old</span><span class="p">);</span>
<span class="w">                </span><span class="n">ct_a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_max_rho</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">ct_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct_max_rho</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">factorqa</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ct_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct_a</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">;</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_a</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">ct_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_max_rho</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">rec_half_rho_tt</span><span class="o">*</span><span class="p">(</span><span class="n">rho</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho_max</span><span class="p">));</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">7</span><span class="p">;</span>
<span class="w">                    </span><span class="n">number_of_iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="n">ct_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_b</span><span class="p">;</span>
<span class="w">                </span><span class="n">rho_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_rho</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct_old</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">                </span><span class="n">factorqb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">rho_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rho_max</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">rho_old</span><span class="p">);</span>
<span class="w">                </span><span class="n">ct_b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_max_rho</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">ct_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct_max_rho</span><span class="p">)</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="n">factorqb</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">ct_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct_b</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">                </span><span class="o">*</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">;</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="o">*</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_b</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">v_lab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="n">rho</span><span class="p">;</span>
<span class="w">    </span><span class="n">gsw_rho_alpha_beta</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="o">*</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">rho_mean</span><span class="p">,</span><span class="o">&amp;</span><span class="n">alpha_mean</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">v_ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha_mean</span><span class="o">/</span><span class="n">rho_mean</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">            </span><span class="n">number_of_iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">ct_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">;</span>
<span class="w">        </span><span class="n">delta_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_specvol</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct_old</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">v_lab</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">delta_v</span><span class="o">/</span><span class="n">v_ct</span><span class="p">;</span>
<span class="w">        </span><span class="n">ct_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ct_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_rho_alpha_beta</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">rho_mean</span><span class="p">,</span><span class="o">&amp;</span><span class="n">alpha_mean</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">v_ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha_mean</span><span class="o">/</span><span class="n">rho_mean</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">delta_v</span><span class="o">/</span><span class="n">v_ct</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_multiple</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_ct_freezing_first_derivatives       first derivatives of Conservative</span>
<span class="cm">%                                     Temperature at which seawater freezes</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_ct_freezing_first_derivatives(SA,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the first derivatives of the Conservative Temperature at</span>
<span class="cm">%  which seawater freezes, with respect to Absolute Salinity SA and</span>
<span class="cm">%  pressure P (in Pa).</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, completely unsaturated)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  CTfreezing_SA = the derivative of the Conservative Temperature at</span>
<span class="cm">%                  freezing (ITS-90) with respect to Absolute Salinity at</span>
<span class="cm">%                  fixed pressure              [ K/(g/kg) ] i.e. [ K kg/g ]</span>
<span class="cm">%</span>
<span class="cm">%  CTfreezing_P  = the derivative of the Conservative Temperature at</span>
<span class="cm">%                  freezing (ITS-90) with respect to pressure (in Pa) at</span>
<span class="cm">%                  fixed Absolute Salinity                         [ K/Pa ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                   </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                   </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ctfreezing_sa</span><span class="p">,</span>
<span class="w">                                                   </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ctfreezing_p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tf_sa</span><span class="p">,</span><span class="w"> </span><span class="n">tf_p</span><span class="p">,</span><span class="w"> </span><span class="n">ct_sa_wrt_t</span><span class="p">,</span><span class="w"> </span><span class="n">ct_t_wrt_t</span><span class="p">,</span><span class="w"> </span><span class="n">ct_p_wrt_t</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">;</span>

<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctfreezing_sa</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ctfreezing_p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                    </span><span class="o">&amp;</span><span class="n">tf_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tf_p</span><span class="p">);</span>

<span class="w">        </span><span class="n">gsw_ct_first_derivatives_wrt_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                         </span><span class="o">&amp;</span><span class="n">ct_sa_wrt_t</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ct_t_wrt_t</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ct_p_wrt_t</span><span class="p">);</span>

<span class="w">        </span><span class="o">*</span><span class="n">ctfreezing_sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_sa_wrt_t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ct_t_wrt_t</span><span class="o">*</span><span class="n">tf_sa</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ctfreezing_p</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ct_p_wrt_t</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="n">ct_t_wrt_t</span><span class="o">*</span><span class="n">tf_p</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctfreezing_sa</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ctfreezing_p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                    </span><span class="o">&amp;</span><span class="n">tf_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">        </span><span class="n">gsw_ct_first_derivatives_wrt_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                         </span><span class="o">&amp;</span><span class="n">ct_sa_wrt_t</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ct_t_wrt_t</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">        </span><span class="o">*</span><span class="n">ctfreezing_sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct_sa_wrt_t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ct_t_wrt_t</span><span class="o">*</span><span class="n">tf_sa</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctfreezing_sa</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ctfreezing_p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tf_p</span><span class="p">);</span>

<span class="w">        </span><span class="n">gsw_ct_first_derivatives_wrt_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                         </span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ct_t_wrt_t</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ct_p_wrt_t</span><span class="p">);</span>

<span class="w">        </span><span class="o">*</span><span class="n">ctfreezing_p</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ct_p_wrt_t</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="n">ct_t_wrt_t</span><span class="o">*</span><span class="n">tf_p</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_ct_freezing_first_derivatives_poly               first derivatives of</span>
<span class="cm">%                 Conservative Temperature at which seawater freezes (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_ct_freezing_first_derivatives_poly(SA,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the first derivatives of the Conservative Temperature at</span>
<span class="cm">%  which seawater freezes, with respect to Absolute Salinity SA and</span>
<span class="cm">%  pressure P (in Pa) of the comptationally efficient polynomial fit of the</span>
<span class="cm">%  freezing temperature (McDougall et al., 2014).</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  CTfreezing_SA = the derivative of the Conservative Temperature at</span>
<span class="cm">%                  freezing (ITS-90) with respect to Absolute Salinity at</span>
<span class="cm">%                  fixed pressure              [ K/(g/kg) ] i.e. [ K kg/g ]</span>
<span class="cm">%</span>
<span class="cm">%  CTfreezing_P  = the derivative of the Conservative Temperature at</span>
<span class="cm">%                  freezing (ITS-90) with respect to pressure (in Pa) at</span>
<span class="cm">%                  fixed Absolute Salinity                         [ K/Pa ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall, Paul Barker  [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_ct_freezing_first_derivatives_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ctfreezing_sa</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ctfreezing_p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">p_r</span><span class="p">,</span><span class="w"> </span><span class="n">sa_r</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span>
<span class="w">             </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gfpc</span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">a</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">b</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.4</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">b</span><span class="o">/</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_sso</span><span class="p">,</span>
<span class="w">             </span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">a</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">b</span><span class="o">/</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_sso</span><span class="p">;</span>

<span class="w">    </span><span class="n">sa_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">;</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">sa_r</span><span class="p">);</span>
<span class="w">    </span><span class="n">p_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="mf">1e-4</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctfreezing_sa</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">ctfreezing_sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c1</span>
<span class="w">                          </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c5</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="mf">3.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c6</span><span class="o">*</span><span class="n">x</span><span class="p">))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c13</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c19</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c22</span><span class="o">*</span><span class="n">x</span><span class="p">))))</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c17</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c20</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c18</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c21</span><span class="o">*</span><span class="n">x</span><span class="p">)))))</span><span class="o">*</span><span class="mf">1e-2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="o">*</span><span class="mf">1e-3</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="n">e</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ctfreezing_p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">ctfreezing_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c7</span>
<span class="w">                          </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c13</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c16</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c19</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">c22</span><span class="o">*</span><span class="n">x</span><span class="p">)))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c8</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c17</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c20</span><span class="o">*</span><span class="n">x</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c9</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c15</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c18</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">3.0</span><span class="o">*</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c21</span><span class="o">*</span><span class="n">x</span><span class="p">)))))</span><span class="o">*</span><span class="mf">1e-8</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_CT_freezing_poly                    Conservative Temperature at which</span>
<span class="cm">%                                                   seawater freezes (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_CT_freezing_poly(SA,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the Conservative Temperature at which seawater freezes.</span>
<span class="cm">%  The error of this fit ranges between -5e-4 K and 6e-4 K when compared</span>
<span class="cm">%  with the Conservative Temperature calculated from the exact in-situ</span>
<span class="cm">%  freezing temperature which is found by a Newton-Raphson iteration of the</span>
<span class="cm">%  equality of the chemical potentials of water in seawater and in ice.</span>
<span class="cm">%  Note that the Conservative Temperature freezing temperature can be found</span>
<span class="cm">%  by this exact method using the function gsw_CT_freezing.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, completely unsaturated)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  CT_freezing = Conservative Temperature at freezing of seawater [ deg C ]</span>
<span class="cm">%                That is, the freezing temperature expressed in</span>
<span class="cm">%                terms of Conservative Temperature (ITS-90).</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall, Paul Barker and Rainer Feistal    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">p_r</span><span class="p">,</span><span class="w"> </span><span class="n">sa_r</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">return_value</span><span class="p">;</span>

<span class="w">    </span><span class="n">sa_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="mf">1.0e-2</span><span class="p">;</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">sa_r</span><span class="p">);</span>
<span class="w">    </span><span class="n">p_r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="mf">1.0e-4</span><span class="p">;</span>

<span class="w">    </span><span class="n">return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">c0</span>
<span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">c6</span><span class="o">*</span><span class="n">x</span><span class="p">)))))</span>
<span class="w">                        </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c7</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">c9</span><span class="o">*</span><span class="n">p_r</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c12</span>
<span class="w">                  </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c15</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">c21</span><span class="o">*</span><span class="n">sa_r</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c13</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">c17</span><span class="o">*</span><span class="n">p_r</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">c19</span><span class="o">*</span><span class="n">sa_r</span><span class="p">)</span>
<span class="w">                  </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">c18</span><span class="o">*</span><span class="n">p_r</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_r</span><span class="o">*</span><span class="p">(</span><span class="n">gfpc</span><span class="p">.</span><span class="n">c16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">c20</span><span class="o">*</span><span class="n">p_r</span>
<span class="w">                  </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">c22</span><span class="o">*</span><span class="n">sa_r</span><span class="p">)));</span>

<span class="w">    </span><span class="n">return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">return_value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="o">*</span>
<span class="w">                        </span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">a</span><span class="o">*</span><span class="n">sa</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gfpc</span><span class="p">.</span><span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">/</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_sso</span><span class="p">));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">return_value</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**************************************************************************</span>
<span class="cm">% gsw_frazil_properties_potential           Absolute Salinity, Conservative</span>
<span class="cm">%                               Temperature, and the ice mass fraction when</span>
<span class="cm">%                     at thermodynamic equilibrium between seawater and ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_frazil_properties_potential(SA_bulk,h_pot_bulk,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the mass fraction of ice (mass of ice divided by mass of ice</span>
<span class="cm">%  plus seawater), w_Ih_eq, which results from given values of the bulk</span>
<span class="cm">%  Absolute Salinity, SA_bulk, bulk potential enthalpy, h_pot_bulk,</span>
<span class="cm">%  occuring at pressure p.  The final equilibrium values of Absolute</span>
<span class="cm">%  Salinity, SA_eq, and Conservative Temperature, CT_eq, of the</span>
<span class="cm">%  interstitial seawater phase are also returned.  This code assumes that</span>
<span class="cm">%  there is no dissolved air in the seawater (that is, saturation_fraction</span>
<span class="cm">%  is assumed to be zero thoughout the code).</span>
<span class="cm">%</span>
<span class="cm">%  When the mass fraction w_Ih_final is calculated as being a positive</span>
<span class="cm">%  value, the seawater-ice mixture is at thermodynamic equlibrium.</span>
<span class="cm">%</span>
<span class="cm">%  This code returns w_Ih_final = 0 when the input bulk enthalpy, h_bulk,</span>
<span class="cm">%  is sufficiently large (i.e. sufficiently &quot;warm&quot;) so that there is no ice</span>
<span class="cm">%  present in the final state.  In this case the final state consists of</span>
<span class="cm">%  only seawater rather than being an equlibrium mixture of seawater and</span>
<span class="cm">%  ice which occurs when w_Ih_final is positive.  Note that when</span>
<span class="cm">%  w_Ih_final = 0, the final seawater is not at the freezing temperature.</span>
<span class="cm">%</span>
<span class="cm">%  Note that this code uses the exact forms of CT_freezing and</span>
<span class="cm">%  pot_enthalpy_ice_freezing.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA_bulk     =  bulk Absolute Salinity of the seawater and ice mixture</span>
<span class="cm">%                                                                  [ g/kg ]</span>
<span class="cm">%  h_pot_bulk  =  bulk potential enthalpy of the seawater and ice mixture</span>
<span class="cm">%                                                                  [ J/kg ]</span>
<span class="cm">%  p           =  sea pressure                                  [ dbar ]</span>
<span class="cm">%                  ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_final    =  Absolute Salinity of the seawater in the final state,</span>
<span class="cm">%                 whether or not any ice is present.               [ g/kg ]</span>
<span class="cm">%  CT_final    =  Conservative Temperature of the seawater in the the final</span>
<span class="cm">%                 state, whether or not any ice is present.       [ deg C ]</span>
<span class="cm">%  w_Ih_final  =  mass fraction of ice in the final seawater-ice mixture.</span>
<span class="cm">%                 If this ice mass fraction is positive, the system is at</span>
<span class="cm">%                 thermodynamic equilibrium.  If this ice mass fraction is</span>
<span class="cm">%                 zero there is no ice in the final state which consists</span>
<span class="cm">%                 only of seawater which is warmer than the freezing</span>
<span class="cm">%                 temperature.                                   [unitless]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of ice and sea ice into seawater, and frazil ice formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., and S.J. Wotherspoon, 2014: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  Anonymous, 2014: Modelling the interaction between seawater and frazil</span>
<span class="cm">%   ice.  Manuscript, March 2015.  See Eqns. (8)-(15) of this  manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_frazil_properties_potential</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa_bulk</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct_final</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">w_ih_final</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iterations</span><span class="p">,</span><span class="w"> </span><span class="n">max_iterations</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">dfunc_dw_ih</span><span class="p">,</span><span class="w"> </span><span class="n">dfunc_dw_ih_mean_poly</span><span class="p">,</span>
<span class="w">             </span><span class="n">dpot_h_ihf_dsa</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">func0</span><span class="p">,</span><span class="w"> </span><span class="n">h_pot_ihf</span><span class="p">,</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="n">w_ih_old</span><span class="p">,</span><span class="w"> </span><span class="n">w_ih</span><span class="p">,</span>
<span class="w">             </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">xa</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">f01</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-9.041191886754806e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f02</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">4.169608567309818e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f03</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-9.325971761333677e-3</span><span class="p">,</span>
<span class="w">             </span><span class="n">f04</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">4.699055851002199e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f05</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.086923404061666e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f06</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.057761186019000e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f07</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-7.349302346007727e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f08</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.444842576424337e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f09</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.408425967872030e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f10</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.070981398567760e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f11</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.768451760854797e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f12</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-4.013688314067293e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f13</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">7.209753205388577e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f14</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.807444462285120e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f15</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.362305015808993e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f16</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-9.500974920072897e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f17</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.192134856624248</span><span class="p">,</span>
<span class="w">             </span><span class="n">f18</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-9.191161283559850e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.008594411490973</span><span class="p">,</span>
<span class="w">             </span><span class="n">f20</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">8.020279271484482e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.930534388853466e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">f22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.026853316399942e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f23</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.722731069001690e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f24</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">5.032098120548072e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f25</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.354888890484222e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.454090179215001e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f27</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">4.125987229048937e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.533404753585094e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f29</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">3.766063025852511e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f30</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.358409746243470e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f31</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.242158862056258e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f32</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.102254738058931e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f33</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.048635435546108e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f34</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.996293091714222e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f35</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.577703068234217e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">f36</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.292053030649309e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">g01</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">3.332286683867741e5</span><span class="p">,</span>
<span class="w">             </span><span class="n">g02</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.416532517833479e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g03</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.021129089258645e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g04</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.356370992641009e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g05</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-8.483432350173174e3</span><span class="p">,</span>
<span class="w">             </span><span class="n">g06</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.279927781684362e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g07</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.506238790315354e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g08</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">4.194030718568807e3</span><span class="p">,</span>
<span class="w">             </span><span class="n">g09</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.146939594885272e5</span><span class="p">,</span>
<span class="w">             </span><span class="n">g10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-7.549939721380912e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g11</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.790535212869292e6</span><span class="p">,</span>
<span class="w">             </span><span class="n">g12</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.078851928118102e5</span><span class="p">,</span>
<span class="w">             </span><span class="n">g13</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.062493860205067e7</span><span class="p">,</span>
<span class="w">             </span><span class="n">g14</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.082909703458225e7</span><span class="p">,</span>
<span class="w">             </span><span class="n">g15</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.046810820868635e7</span><span class="p">,</span>
<span class="w">             </span><span class="n">g16</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">8.039606992745191e6</span><span class="p">,</span>
<span class="w">             </span><span class="n">g17</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.023984705844567e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g18</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.871769638352535e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g19</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.444841553038544e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g20</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.261532522236573e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g21</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.090579366221046e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g22</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.128417003723530e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g23</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">3.222965226084112e3</span><span class="p">,</span>
<span class="w">             </span><span class="n">g24</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.226388046175992e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g25</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.506847628109789e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g26</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-4.584670946447444e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g27</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.596119496322347e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g28</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-6.338852410446789e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">g29</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">8.951570926106525e4</span><span class="p">,</span>
<span class="w">             </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">func0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span>
<span class="w">              </span><span class="o">*</span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa_bulk</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">func0</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="o">/</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">;</span>
<span class="w">    </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">func0</span><span class="o">/</span><span class="mf">3e5</span><span class="p">;</span>
<span class="w">    </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="mf">1e-4</span><span class="p">;</span>
<span class="w">    </span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f01</span>
<span class="w">             </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f02</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f03</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f04</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f05</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f06</span><span class="o">*</span><span class="n">x</span><span class="p">))))</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f07</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f08</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f09</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f11</span><span class="o">*</span><span class="n">x</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f12</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f13</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f15</span><span class="o">*</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f16</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f17</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f18</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f19</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f20</span><span class="o">*</span><span class="n">x</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">f21</span><span class="o">*</span><span class="n">y</span><span class="p">))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">f22</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f23</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f24</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f25</span><span class="o">*</span><span class="n">x</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f26</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f27</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f28</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f29</span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f30</span><span class="o">*</span><span class="n">y</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">f31</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="n">f32</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f33</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">f34</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f35</span><span class="o">*</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">f36</span><span class="o">*</span><span class="n">y</span><span class="p">))));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_pot_ihf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pot_enthalpy_ice_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">)</span><span class="o">*</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="o">*</span><span class="n">ctf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="n">h_pot_ihf</span><span class="p">;</span>
<span class="w">    </span><span class="n">xa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="mf">1e-2</span><span class="p">;</span>
<span class="w">    </span><span class="n">dfunc_dw_ih_mean_poly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">g01</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g02</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g03</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g04</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g05</span><span class="o">*</span><span class="n">xa</span><span class="p">)))</span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g06</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g07</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g08</span><span class="o">*</span><span class="n">xa</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g09</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g10</span><span class="o">*</span><span class="n">xa</span><span class="p">)</span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g12</span><span class="o">*</span><span class="n">xa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g13</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g14</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g15</span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">g16</span><span class="o">*</span><span class="n">w_ih</span><span class="p">))))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">g17</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g18</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g19</span><span class="o">*</span><span class="n">xa</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g20</span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g21</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g22</span><span class="o">*</span><span class="n">w_ih</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g23</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g24</span><span class="o">*</span><span class="n">xa</span><span class="o">*</span><span class="n">w_ih</span><span class="p">))</span>
<span class="w">                                    </span><span class="o">+</span><span class="w"> </span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">g25</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xa</span><span class="o">*</span><span class="p">(</span><span class="n">g26</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g27</span><span class="o">*</span><span class="n">xa</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="p">(</span><span class="n">g28</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">g29</span><span class="o">*</span><span class="n">w_ih</span><span class="p">)));</span>

<span class="w">    </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih</span><span class="p">;</span>
<span class="w">    </span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="o">/</span><span class="n">dfunc_dw_ih_mean_poly</span><span class="p">;</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_pot_ihf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pot_enthalpy_ice_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_pot_enthalpy_ice_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dpot_h_ihf_dsa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">dfunc_dw_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="o">*</span><span class="n">ctf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_pot_ihf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span>
<span class="w">                      </span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="o">*</span><span class="n">ctf_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="n">dpot_h_ihf_dsa</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">w_ih</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.20</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">15.0</span>
<span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">60.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">3000.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">max_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">w_ih</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.85</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">120.0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">3500.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">max_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">max_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">max_iterations</span><span class="p">;</span><span class="w"> </span><span class="n">iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iterations</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">            </span><span class="n">h_pot_ihf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pot_enthalpy_ice_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">)</span><span class="o">*</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="o">*</span><span class="n">ctf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="n">h_pot_ihf</span><span class="p">;</span>
<span class="w">        </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih</span><span class="p">;</span>
<span class="w">        </span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="o">/</span><span class="n">dfunc_dw_ih</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_pot_bulk</span><span class="o">/</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_cp0</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_pot_enthalpy_ice_freezing_first_derivatives         first derivatives</span>
<span class="cm">%                        of the potential enthalpy of ice at the conditions</span>
<span class="cm">%                   where ice and seawater are in thermodynamic equilibrium</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_pot_enthalpy_ice_freezing_first_derivatives(SA,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the first derivatives of the potential enthalpy of ice at</span>
<span class="cm">%  which seawater freezes, with respect to Absolute Salinity SA and</span>
<span class="cm">%  pressure P (in Pa).</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  pot_enthalpy_ice_freezing_SA = the derivative of the potential enthalpy</span>
<span class="cm">%                  of ice at freezing (ITS-90) with respect to Absolute</span>
<span class="cm">%                  salinity at fixed pressure  [ K/(g/kg) ] i.e. [ K kg/g ]</span>
<span class="cm">%</span>
<span class="cm">%  pot_enthalpy_ice_freezing_P  = the derivative of the potential enthalpy</span>
<span class="cm">%                  of ice at freezing (ITS-90) with respect to pressure</span>
<span class="cm">%                  (in Pa) at fixed Absolute Salinity              [ K/Pa ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pot_enthalpy_ice_freezing_first_derivatives</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                               </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">pot_enthalpy_ice_freezing_sa</span><span class="p">,</span>
<span class="w">                                                               </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">pot_enthalpy_ice_freezing_p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">cp_ihf</span><span class="p">,</span><span class="w"> </span><span class="n">pt_icef</span><span class="p">,</span><span class="w"> </span><span class="n">ratio_temp</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">tf_p</span><span class="p">,</span><span class="w"> </span><span class="n">tf_sa</span><span class="p">,</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">pt_icef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pt0_from_t_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">ratio_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pt_icef</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tf</span><span class="p">);</span>
<span class="w">    </span><span class="n">cp_ihf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_cp_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pot_enthalpy_ice_freezing_sa</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">            </span><span class="p">(</span><span class="n">pot_enthalpy_ice_freezing_p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                    </span><span class="o">&amp;</span><span class="n">tf_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tf_p</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pot_enthalpy_ice_freezing_sa</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                    </span><span class="o">&amp;</span><span class="n">tf_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pot_enthalpy_ice_freezing_p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                    </span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tf_p</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pot_enthalpy_ice_freezing_sa</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="o">*</span><span class="n">pot_enthalpy_ice_freezing_sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ratio_temp</span><span class="o">*</span><span class="n">cp_ihf</span><span class="o">*</span><span class="n">tf_sa</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pot_enthalpy_ice_freezing_p</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="o">*</span><span class="n">pot_enthalpy_ice_freezing_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ratio_temp</span><span class="o">*</span><span class="n">cp_ihf</span><span class="o">*</span><span class="n">tf_p</span>
<span class="w">                                                 </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pt_icef</span><span class="p">)</span><span class="o">*</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_frazil_properties        Absolute Salinity, Conservative Temperature,</span>
<span class="cm">%                                       and the ice mass fraction from bulk</span>
<span class="cm">%                                       Absolute Salinity and bulk enthalpy</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_frazil_properties(SA_bulk,h_bulk,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the mass fraction of ice (mass of ice divided by mass of ice</span>
<span class="cm">%  plus seawater), w_Ih_final, which results from given values of the bulk</span>
<span class="cm">%  Absolute Salinity, SA_bulk, bulk enthalpy, h_bulk, occuring at pressure</span>
<span class="cm">%  p.  The final values of Absolute Salinity, SA_final, and Conservative</span>
<span class="cm">%  Temperature, CT_final, of the interstitial seawater phase are also</span>
<span class="cm">%  returned.  This code assumes that there is no dissolved air in the</span>
<span class="cm">%  seawater (that is, saturation_fraction is assumed to be zero</span>
<span class="cm">%  throughout the code).</span>
<span class="cm">%</span>
<span class="cm">%  When the mass fraction w_Ih_final is calculated as being a positive</span>
<span class="cm">%  value, the seawater-ice mixture is at thermodynamic equlibrium.</span>
<span class="cm">%</span>
<span class="cm">%  This code returns w_Ih_final = 0 when the input bulk enthalpy, h_bulk,</span>
<span class="cm">%  is sufficiently large (i.e. sufficiently &quot;warm&quot;) so that there is no ice</span>
<span class="cm">%  present in the final state.  In this case the final state consists of</span>
<span class="cm">%  only seawater rather than being an equlibrium mixture of seawater and</span>
<span class="cm">%  ice which occurs when w_Ih_final is positive.  Note that when</span>
<span class="cm">%  w_Ih_final = 0, the final seawater is not at the freezing temperature.</span>
<span class="cm">%</span>
<span class="cm">%  Note that there is another GSW code,</span>
<span class="cm">%  gsw_frazil_properties_potential_poly(SA_bulk,h_pot_bulk,p) which</span>
<span class="cm">%  treats potential enthalpy as the conservative variable, while, in</span>
<span class="cm">%  contrast, the present code treats in situ enthalpy as the conservative</span>
<span class="cm">%  variable during the interaction of seawater and ice Ih.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA_bulk =  bulk Absolute Salinity of the seawater and ice mixture</span>
<span class="cm">%                                                                  [ g/kg ]</span>
<span class="cm">%  h_bulk  =  bulk enthalpy of the seawater and ice mixture        [ J/kg ]</span>
<span class="cm">%  p       =  sea pressure                                         [ dbar ]</span>
<span class="cm">%             ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_final    =  Absolute Salinity of the seawater in the final state,</span>
<span class="cm">%                 whether or not any ice is present.               [ g/kg ]</span>
<span class="cm">%  CT_final    =  Conservative Temperature of the seawater in the the final</span>
<span class="cm">%                 state, whether or not any ice is present.       [ deg C ]</span>
<span class="cm">%  w_Ih_final  =  mass fraction of ice in the final seawater-ice mixture.</span>
<span class="cm">%                 If this ice mass fraction is positive, the system is at</span>
<span class="cm">%                 thermodynamic equilibrium.  If this ice mass fraction is</span>
<span class="cm">%                 zero there is no ice in the final state which consists</span>
<span class="cm">%                 only of seawater which is warmer than the freezing</span>
<span class="cm">%                 temperature.                                   [unitless]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of ice and sea ice into seawater, and frazil ice formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., and S.J. Wotherspoon, 2014: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  Anonymous, 2014: Modelling the interaction between seawater and frazil</span>
<span class="cm">%   ice.  Manuscript, March 2015.  See Eqns. (8) - (15) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_frazil_properties</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa_bulk</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">h_bulk</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct_final</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">w_ih_final</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">cp_ih</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">dfunc_dw_ih</span><span class="p">,</span><span class="w"> </span><span class="n">dfunc_dw_ih_mean_poly</span><span class="p">,</span>
<span class="w">             </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">func0</span><span class="p">,</span><span class="w"> </span><span class="n">hf</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span>
<span class="w">             </span><span class="n">h_ihf</span><span class="p">,</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="n">tf_sa</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">w_ih_mean</span><span class="p">,</span><span class="w"> </span><span class="n">w_ih_old</span><span class="p">,</span><span class="w"> </span><span class="n">w_ih</span><span class="p">,</span>
<span class="w">             </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">             </span><span class="n">num_f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0e-2</span><span class="p">,</span><span class="w"> </span><span class="n">num_f2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">6.9e-7</span><span class="p">,</span><span class="w"> </span><span class="n">num_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.21</span><span class="p">;</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa_bulk</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">func0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_bulk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa_bulk</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">func0</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_from_enthalpy_exact</span><span class="p">(</span><span class="n">sa_bulk</span><span class="p">,</span><span class="n">h_bulk</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">dfunc_dw_ih_mean_poly</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.347814e+05</span>
<span class="w">                                    </span><span class="o">-</span><span class="w"> </span><span class="n">num_f</span><span class="o">*</span><span class="n">func0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">num_f2</span><span class="o">*</span><span class="n">func0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">num_p</span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="w">    </span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_min_d</span><span class="p">(</span><span class="o">-</span><span class="n">func0</span><span class="o">/</span><span class="n">dfunc_dw_ih_mean_poly</span><span class="p">,</span><span class="w"> </span><span class="mf">0.95</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">120.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">hf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ihf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">cp_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_cp_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tf_sa</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">dfunc_dw_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ihf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="o">*</span><span class="n">ctf_sa</span><span class="w"> </span><span class="o">+</span>
<span class="w">                                             </span><span class="n">w_ih</span><span class="o">*</span><span class="n">cp_ih</span><span class="o">*</span><span class="n">tf_sa</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">));</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">            </span><span class="n">number_of_iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">            </span><span class="n">hf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">            </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">            </span><span class="n">h_ihf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_bulk</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">)</span><span class="o">*</span><span class="n">hf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="n">h_ihf</span><span class="p">;</span>
<span class="w">        </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih</span><span class="p">;</span>
<span class="w">        </span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="o">/</span><span class="n">dfunc_dw_ih</span><span class="p">;</span>
<span class="w">        </span><span class="n">w_ih_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih_old</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih_mean</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih_mean</span><span class="p">);</span>
<span class="w">        </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">        </span><span class="n">hf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">        </span><span class="n">h_ihf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="n">cp_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_cp_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tf_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">dfunc_dw_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ihf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="o">*</span><span class="n">ctf_sa</span>
<span class="w">                                                 </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih_mean</span><span class="o">*</span><span class="n">cp_ih</span><span class="o">*</span><span class="n">tf_sa</span><span class="o">/</span>
<span class="w">                                                 </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih_mean</span><span class="p">));</span>
<span class="w">        </span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="o">/</span><span class="n">dfunc_dw_ih</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">w_ih</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.9</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">            </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w_ih</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_bulk</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_from_enthalpy_exact</span><span class="p">(</span><span class="o">*</span><span class="n">sa_final</span><span class="p">,</span><span class="n">h_bulk</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_cp_ice                                  isobaric heat capacity of ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_cp_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the isobaric heat capacity of seawater.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t   =  in-situ temperature (ITS-90)                            [ deg C ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%          ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  cp_ice  =  heat capacity of ice                           [J kg^-1 K^-1]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">% The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_cp_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="p">)</span><span class="o">*</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_frazil_ratios_adiabatic_poly      ratios of SA, CT and P changes when</span>
<span class="cm">%                           frazil ice forms due to the adiabatic change in</span>
<span class="cm">%                          pressure of a mixture of seawater and ice (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_frazil_ratios_adiabatic_poly(SA,p,w_Ih)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratios of SA, CT and P changes when frazil ice forms or</span>
<span class="cm">%  melts in response to an adiabatic change in pressure of a mixture of</span>
<span class="cm">%  seawater and frazil ice crystals.</span>
<span class="cm">%</span>
<span class="cm">%  Note that the first output, dSA_dCT_frazil, is dSA/dCT rather than</span>
<span class="cm">%  dCT/dSA.  This is done so that when SA = 0, the output, dSA/dCT, is zero</span>
<span class="cm">%  whereas dCT/dSA would then be infinite.</span>
<span class="cm">%</span>
<span class="cm">%  Also note that both dSA_dP_frazil and dCT_dP_frazil are the pressure</span>
<span class="cm">%  derivatives with the pressure measured in Pa not dbar.</span>
<span class="cm">%</span>
<span class="cm">%  This function uses the computationally-efficient expression for specific</span>
<span class="cm">%  volume in terms of SA, CT and p (Roquet et al., 2015) and the polynomial</span>
<span class="cm">%  expression for freezing temperature based on Conservative Temperature</span>
<span class="cm">%  (McDougall et al., 2015).</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity of seawater                            [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure of seawater at which melting occurs         [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  w_Ih  =  mass fraction of ice, that is the mass of ice divided by the</span>
<span class="cm">%           sum of the masses of ice and seawater.  That is, the mass of</span>
<span class="cm">%           ice divided by the mass of the final mixed fluid.</span>
<span class="cm">%           w_Ih must be between 0 and 1.                      [ unitless ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  dSA_dCT_frazil =  the ratio of the changes in Absolute Salinity</span>
<span class="cm">%                    to that of Conservative Temperature       [ g/(kg K) ]</span>
<span class="cm">%  dSA_dP_frazil  =  the ratio of the changes in Absolute Salinity</span>
<span class="cm">%                    to that of pressure (in Pa)              [ g/(kg Pa) ]</span>
<span class="cm">%  dCT_dP_frazil  =  the ratio of the changes in Conservative Temperature</span>
<span class="cm">%                    to that of pressure (in Pa)                   [ K/Pa ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqns. (47), (48) and (49) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling., 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_frazil_ratios_adiabatic_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">w_ih</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">dsa_dct_frazil</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">dsa_dp_frazil</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">dct_dp_frazil</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">bracket1</span><span class="p">,</span><span class="w"> </span><span class="n">bracket2</span><span class="p">,</span><span class="w"> </span><span class="n">cp_ih</span><span class="p">,</span><span class="w"> </span><span class="n">gamma_ih</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">part</span><span class="p">,</span>
<span class="w">             </span><span class="n">rec_bracket3</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">wcp</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">,</span><span class="w"> </span><span class="n">tf_sa</span><span class="p">,</span><span class="w"> </span><span class="n">tf_p</span><span class="p">,</span>
<span class="w">             </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_p</span><span class="p">,</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">cp_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_cp_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gamma_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_adiabatic_lapse_rate_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_t_freezing_first_derivatives_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tf_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tf_p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_ct_freezing_first_derivatives_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ctf_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ctf_p</span><span class="p">);</span>
<span class="w">    </span><span class="n">wcp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cp_ih</span><span class="o">*</span><span class="n">w_ih</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">);</span>
<span class="w">    </span><span class="n">part</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tf_p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gamma_ih</span><span class="p">)</span><span class="o">/</span><span class="n">ctf_p</span><span class="p">;</span>
<span class="w">    </span><span class="n">bracket1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wcp</span><span class="o">*</span><span class="n">part</span><span class="p">;</span>
<span class="w">    </span><span class="n">bracket2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wcp</span><span class="o">*</span><span class="p">(</span><span class="n">tf_sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">part</span><span class="o">*</span><span class="n">ctf_sa</span><span class="p">));</span>
<span class="w">    </span><span class="n">rec_bracket3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="o">*</span><span class="n">ctf_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wcp</span><span class="o">*</span><span class="n">tf_sa</span><span class="p">));</span>

<span class="w">    </span><span class="o">*</span><span class="n">dsa_dct_frazil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">bracket1</span><span class="o">/</span><span class="n">bracket2</span><span class="p">);</span>
<span class="w">    </span><span class="o">*</span><span class="n">dsa_dp_frazil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="n">ctf_p</span><span class="o">*</span><span class="n">bracket1</span><span class="o">*</span><span class="n">rec_bracket3</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">dct_dp_frazil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctf_p</span><span class="o">*</span><span class="n">bracket2</span><span class="o">*</span><span class="n">rec_bracket3</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_frazil_ratios_adiabatic    ratios of SA, CT and P changes when frazil</span>
<span class="cm">%                                  ice forms due to the adiabatic change in</span>
<span class="cm">%                                 pressure of a mixture of seawater and ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_frazil_ratios_adiabatic(SA,p,w_Ih)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratios of SA, CT and P changes when frazil ice forms or</span>
<span class="cm">%  melts in response to an adiabatic change in pressure of a mixture of</span>
<span class="cm">%  seawater and frazil ice crystals.</span>
<span class="cm">%</span>
<span class="cm">%  Note that the first output, dSA_dCT_frazil, is dSA/dCT rather than</span>
<span class="cm">%  dCT/dSA.  This is done so that when SA = 0, the output, dSA/dCT, is zero</span>
<span class="cm">%  whereas dCT/dSA would then be infinite.</span>
<span class="cm">%</span>
<span class="cm">%  Also note that both dSA_dP_frazil and dCT_dP_frazil are the pressure</span>
<span class="cm">%  derivatives with the pressure measured in Pa not dbar.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity of seawater                            [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure of seawater at which melting occurs         [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  w_Ih  =  mass fraction of ice, that is the mass of ice divided by the</span>
<span class="cm">%           sum of the masses of ice and seawater.  That is, the mass of</span>
<span class="cm">%           ice divided by the mass of the final mixed fluid.</span>
<span class="cm">%           w_Ih must be between 0 and 1.                      [ unitless ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  dSA_dCT_frazil =  the ratio of the changes in Absolute Salinity</span>
<span class="cm">%                    to that of Conservative Temperature       [ g/(kg K) ]</span>
<span class="cm">%  dSA_dP_frazil  =  the ratio of the changes in Absolute Salinity</span>
<span class="cm">%                    to that of pressure (in Pa)              [ g/(kg Pa) ]</span>
<span class="cm">%  dCT_dP_frazil  =  the ratio of the changes in Conservative Temperature</span>
<span class="cm">%                    to that of pressure (in Pa)                   [ K/Pa ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqns. (47), (48) and (49) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_frazil_ratios_adiabatic</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">w_ih</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">dsa_dct_frazil</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">dsa_dp_frazil</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">dct_dp_frazil</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">bracket1</span><span class="p">,</span><span class="w"> </span><span class="n">bracket2</span><span class="p">,</span><span class="w"> </span><span class="n">cp_ih</span><span class="p">,</span><span class="w"> </span><span class="n">gamma_ih</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">part</span><span class="p">,</span>
<span class="w">             </span><span class="n">rec_bracket3</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">wcp</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">,</span><span class="w"> </span><span class="n">tf_sa</span><span class="p">,</span><span class="w"> </span><span class="n">tf_p</span><span class="p">,</span>
<span class="w">             </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_p</span><span class="p">,</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">cp_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_cp_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gamma_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_adiabatic_lapse_rate_ice</span><span class="p">(</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tf_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tf_p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ctf_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ctf_p</span><span class="p">);</span>
<span class="w">    </span><span class="n">wcp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cp_ih</span><span class="o">*</span><span class="n">w_ih</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">);</span>
<span class="w">    </span><span class="n">part</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tf_p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gamma_ih</span><span class="p">)</span><span class="o">/</span><span class="n">ctf_p</span><span class="p">;</span>
<span class="w">    </span><span class="n">bracket1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wcp</span><span class="o">*</span><span class="n">part</span><span class="p">;</span>
<span class="w">    </span><span class="n">bracket2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wcp</span><span class="o">*</span><span class="p">(</span><span class="n">tf_sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">part</span><span class="o">*</span><span class="n">ctf_sa</span><span class="p">));</span>
<span class="w">    </span><span class="n">rec_bracket3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="o">*</span><span class="n">ctf_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">wcp</span><span class="o">*</span><span class="n">tf_sa</span><span class="p">));</span>

<span class="w">    </span><span class="o">*</span><span class="n">dsa_dct_frazil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">bracket1</span><span class="o">/</span><span class="n">bracket2</span><span class="p">);</span>
<span class="w">    </span><span class="o">*</span><span class="n">dsa_dp_frazil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="n">ctf_p</span><span class="o">*</span><span class="n">bracket1</span><span class="o">*</span><span class="n">rec_bracket3</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">dct_dp_frazil</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctf_p</span><span class="o">*</span><span class="n">bracket2</span><span class="o">*</span><span class="n">rec_bracket3</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_adiabatic_lapse_rate_ice                         adiabatic lapse rate</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  adiabatic_lapse_rate_ice = gsw_adiabatic_lapse_rate_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the adiabatic lapse rate of ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  adiabatic_lapse_rate_ice  =  adiabatic lapse rate               [ K/Pa ]</span>
<span class="cm">%    Note.  The output is in unit of degress Celsius per Pa,</span>
<span class="cm">%      (or equivilently K/Pa) not in units of K/dbar.</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_adiabatic_lapse_rate_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_alpha_wrt_t_ice                  thermal expansion coefficient of ice</span>
<span class="cm">%                                       with respect to in-situ temperature</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_alpha_wrt_t_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the thermal expansion coefficient of ice with respect to</span>
<span class="cm">%  in-situ temperature.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  alpha_wrt_t_ice  =  thermal expansion coefficient of ice with respect</span>
<span class="cm">%                      to in-situ temperature                       [ 1/K ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See Eqn. (2.18.1) of this TEOS-10 manual.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_alpha_wrt_t_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>
<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_chem_potential_water_ice           chemical potential of water in ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_chem_potential_water_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the chemical potential of water in ice from in-situ</span>
<span class="cm">%  temperature and pressure.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  chem_potential_water_ice  =  chemical potential of ice          [ J/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">% The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_chem_potential_water_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_enthalpy_diff            difference of enthalpy between two pressures</span>
<span class="cm">%                                                        (75-term equation)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_enthalpy_diff(SA,CT,p_shallow,p_deep)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the difference of the specific enthalpy of seawater between</span>
<span class="cm">%  two different pressures, p_deep (the deeper pressure) and p_shallow</span>
<span class="cm">%  (the shallower pressure), at the same values of SA and CT.  This</span>
<span class="cm">%  function uses the computationally-efficient expression for specific</span>
<span class="cm">%  volume in terms of SA, CT and p (Roquet et al., 2015).  The output</span>
<span class="cm">%  (enthalpy_diff) is the specific enthalpy evaluated at (SA,CT,p_deep)</span>
<span class="cm">%  minus the specific enthalpy at (SA,CT,p_shallow).</span>
<span class="cm">%</span>
<span class="cm">%  Note that the 75-term equation has been fitted in a restricted range of</span>
<span class="cm">%  parameter space, and is most accurate inside the &quot;oceanographic funnel&quot;</span>
<span class="cm">%  described in McDougall et al. (2003).  The GSW library function</span>
<span class="cm">%  &quot;gsw_infunnel(SA,CT,p)&quot; is avaialble to be used if one wants to test if</span>
<span class="cm">%  some of one&#39;s data lies outside this &quot;funnel&quot;.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA         =  Absolute Salinity                                 [ g/kg ]</span>
<span class="cm">%  CT         =  Conservative Temperature (ITS-90)                [ deg C ]</span>
<span class="cm">%  p_shallow  =  upper sea pressure                                [ dbar ]</span>
<span class="cm">%                ( i.e. shallower absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  p_deep     =  lower sea pressure                                [ dbar ]</span>
<span class="cm">%                ( i.e. deeper absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  enthalpy_diff  =  difference of specific enthalpy            [ J/kg ]</span>
<span class="cm">%                       (deep minus shallow)</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall &amp; Paul Barker.                     [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%    See Eqns. (3.32.2) and (A.30.6) of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., 2003: Potential enthalpy: A conservative oceanic</span>
<span class="cm">%   variable for evaluating heat content and heat fluxes. Journal of</span>
<span class="cm">%   Physical Oceanography, 33, 945-963.</span>
<span class="cm">%    See Eqns. (18) and (22)</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., D.R. Jackett, D.G. Wright and R. Feistel, 2003:</span>
<span class="cm">%   Accurate and computationally efficient algorithms for potential</span>
<span class="cm">%   temperature and density of seawater.  J. Atmosph. Ocean. Tech., 20,</span>
<span class="cm">%   pp. 730-741.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling., 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_enthalpy_diff</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span>
<span class="w">                                    </span><span class="kt">double</span><span class="w"> </span><span class="n">p_shallow</span><span class="p">,</span>
<span class="w">                                    </span><span class="kt">double</span><span class="w"> </span><span class="n">p_deep</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">dynamic_enthalpy_shallow</span><span class="p">,</span><span class="w"> </span><span class="n">dynamic_enthalpy_deep</span><span class="p">,</span>
<span class="w">              </span><span class="n">part_1</span><span class="p">,</span><span class="w"> </span><span class="n">part_2</span><span class="p">,</span><span class="w"> </span><span class="n">part_3</span><span class="p">,</span><span class="w"> </span><span class="n">part_4</span><span class="p">,</span><span class="w"> </span><span class="n">part_5</span><span class="p">,</span><span class="w"> </span><span class="n">xs</span><span class="p">,</span><span class="w"> </span><span class="n">ys</span><span class="p">,</span>
<span class="w">              </span><span class="n">z_deep</span><span class="p">,</span><span class="w"> </span><span class="n">z_shallow</span><span class="p">;</span>

<span class="w">    </span><span class="n">xs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sqrt</span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_sfac</span><span class="o">*</span><span class="n">sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
<span class="w">    </span><span class="n">ys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ct</span><span class="o">*</span><span class="mf">0.025</span><span class="p">;</span>
<span class="w">    </span><span class="n">z_shallow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_shallow</span><span class="o">*</span><span class="mf">1e-4</span><span class="p">;</span>
<span class="w">    </span><span class="n">z_deep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_deep</span><span class="o">*</span><span class="mf">1e-4</span><span class="p">;</span>

<span class="w">    </span><span class="n">part_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h001</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h101</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h201</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h301</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h401</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h501</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h601</span><span class="o">*</span><span class="n">xs</span><span class="p">)))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h011</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h111</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h211</span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h311</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h411</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h511</span><span class="o">*</span><span class="n">xs</span><span class="p">))))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h021</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h121</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h221</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h321</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h421</span><span class="o">*</span><span class="n">xs</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h031</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h131</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h231</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h331</span><span class="o">*</span><span class="n">xs</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h041</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h141</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h241</span><span class="o">*</span><span class="n">xs</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h051</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h151</span><span class="o">*</span><span class="n">xs</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h061</span><span class="o">*</span><span class="n">ys</span><span class="p">)))));</span>

<span class="w">    </span><span class="n">part_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h002</span>
<span class="w">                   </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h102</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h202</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h302</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h402</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h502</span><span class="o">*</span><span class="n">xs</span><span class="p">))))</span>
<span class="w">                   </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h012</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h112</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h212</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h312</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h412</span><span class="o">*</span><span class="n">xs</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h022</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h122</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h222</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h322</span><span class="o">*</span><span class="n">xs</span><span class="p">))</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h032</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h132</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h232</span><span class="o">*</span><span class="n">xs</span><span class="p">)</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h042</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h142</span><span class="o">*</span><span class="n">xs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h052</span><span class="o">*</span><span class="n">ys</span><span class="p">))));</span>

<span class="w">    </span><span class="n">part_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h003</span>
<span class="w">                   </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h103</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h203</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h303</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h403</span><span class="o">*</span><span class="n">xs</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h013</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h113</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h213</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h313</span><span class="o">*</span><span class="n">xs</span><span class="p">))</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h023</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h123</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h223</span><span class="o">*</span><span class="n">xs</span><span class="p">)</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h033</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h133</span><span class="o">*</span><span class="n">xs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h043</span><span class="o">*</span><span class="n">ys</span><span class="p">)));</span>

<span class="w">    </span><span class="n">part_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h004</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">xs</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h104</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h204</span><span class="o">*</span><span class="n">xs</span><span class="p">)</span>
<span class="w">                   </span><span class="o">+</span><span class="w"> </span><span class="n">ys</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h014</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h114</span><span class="o">*</span><span class="n">xs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h024</span><span class="o">*</span><span class="n">ys</span><span class="p">);</span>

<span class="w">    </span><span class="n">part_5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h005</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h105</span><span class="o">*</span><span class="n">xs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h015</span><span class="o">*</span><span class="n">ys</span><span class="p">;</span>

<span class="w">    </span><span class="n">dynamic_enthalpy_shallow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_shallow</span><span class="o">*</span><span class="p">(</span><span class="n">part_1</span>
<span class="w">                                  </span><span class="o">+</span><span class="w"> </span><span class="n">z_shallow</span><span class="o">*</span><span class="p">(</span><span class="n">part_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z_shallow</span><span class="o">*</span><span class="p">(</span><span class="n">part_3</span>
<span class="w">                                  </span><span class="o">+</span><span class="w"> </span><span class="n">z_shallow</span><span class="o">*</span><span class="p">(</span><span class="n">part_4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z_shallow</span><span class="o">*</span><span class="p">(</span><span class="n">part_5</span>
<span class="w">                                            </span><span class="o">+</span><span class="w"> </span><span class="n">z_shallow</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h006</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h007</span><span class="o">*</span><span class="n">z_shallow</span><span class="p">))))));</span>

<span class="w">    </span><span class="n">dynamic_enthalpy_deep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z_deep</span><span class="o">*</span><span class="p">(</span><span class="n">part_1</span>
<span class="w">                               </span><span class="o">+</span><span class="w"> </span><span class="n">z_deep</span><span class="o">*</span><span class="p">(</span><span class="n">part_2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z_deep</span><span class="o">*</span><span class="p">(</span><span class="n">part_3</span>
<span class="w">                                        </span><span class="o">+</span><span class="w"> </span><span class="n">z_deep</span><span class="o">*</span><span class="p">(</span><span class="n">part_4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">z_deep</span><span class="o">*</span><span class="p">(</span><span class="n">part_5</span>
<span class="w">                                        </span><span class="o">+</span><span class="w"> </span><span class="n">z_deep</span><span class="o">*</span><span class="p">(</span><span class="n">gsvco</span><span class="p">.</span><span class="n">h006</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">gsvco</span><span class="p">.</span><span class="n">h007</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">z_deep</span><span class="p">))))));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">dynamic_enthalpy_deep</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dynamic_enthalpy_shallow</span><span class="p">)</span><span class="o">*</span><span class="n">gtc</span><span class="p">.</span><span class="n">db2pa</span><span class="o">*</span><span class="mf">1e4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_Helmholtz_energy_ice                          Helmholtz energy of ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_Helmholtz_energy_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the Helmholtz energy of ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  Helmholtz_energy_ice  =  Helmholtz energy of ice                [ J/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_helmholtz_energy_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">db2pa</span><span class="o">*</span><span class="n">p</span>
<span class="w">             </span><span class="o">+</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_p0</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_ice_fraction_to_freeze_seawater         ice mass fraction, which when</span>
<span class="cm">%                                  melted into seawater, brings the diluted</span>
<span class="cm">%                                      seawater to the freezing temperature</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_ice_fraction_to_freeze_seawater(SA,CT,p,t_Ih)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the mass fraction of ice (mass of ice divided by mass of ice</span>
<span class="cm">%  plus seawater), which, when melted into seawater having (SA,CT,p) causes</span>
<span class="cm">%  the final dilute seawater to be at the freezing temperature.  The other</span>
<span class="cm">%  outputs are the Absolute Salinity and Conservative Temperature of the</span>
<span class="cm">%  final diluted seawater.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA   =  Absolute Salinity of seawater                           [ g/kg ]</span>
<span class="cm">%  CT   =  Conservative Temperature of seawater (ITS-90)          [ deg C ]</span>
<span class="cm">%  p    =  sea pressure                                            [ dbar ]</span>
<span class="cm">%            ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  t_Ih =  in-situ temperature of the ice at pressure p (ITS-90)  [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_freeze = Absolute Salinity of seawater after the mass fraction of</span>
<span class="cm">%              ice, ice_fraction, at temperature t_Ih has melted into the</span>
<span class="cm">%              original seawater, and the final mixture is at the freezing</span>
<span class="cm">%              temperature of seawater.                            [ g/kg ]</span>
<span class="cm">%</span>
<span class="cm">%  CT_freeze = Conservative Temperature of seawater after the mass</span>
<span class="cm">%              fraction, w_Ih, of ice at temperature t_Ih has melted into</span>
<span class="cm">%              the original seawater, and the final mixture is at the</span>
<span class="cm">%              freezing temperature of seawater.                  [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">%  w_Ih      = mass fraction of ice, having in-situ temperature t_Ih,</span>
<span class="cm">%              which, when melted into seawater at (SA,CT,p) leads to the</span>
<span class="cm">%              final diluted seawater being at the freezing temperature.</span>
<span class="cm">%              This output must be between 0 and 1.              [unitless]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., and S.J. Wotherspoon, 2013: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqn. (9) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_ice_fraction_to_freeze_seawater</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span>
<span class="w">                                                   </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">t_ih</span><span class="p">,</span>
<span class="w">                                                   </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">sa_freeze</span><span class="p">,</span>
<span class="w">                                                   </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct_freeze</span><span class="p">,</span>
<span class="w">                                                   </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">w_ih</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">no_iter</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_mean</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_old</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_plus1</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_zero</span><span class="p">,</span>
<span class="w">             </span><span class="n">dfunc_dsaf</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">func_plus1</span><span class="p">,</span><span class="w"> </span><span class="n">func_zero</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span>
<span class="w">             </span><span class="n">saf</span><span class="p">,</span><span class="w"> </span><span class="n">saf_mean</span><span class="p">,</span><span class="w"> </span><span class="n">saf_old</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_sa</span><span class="p">;</span>

<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">sa0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ctf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_freeze</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_freeze</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_ih</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_freeze</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_freeze</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_ih</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf_zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">func_zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa0</span><span class="p">,</span><span class="n">ctf_zero</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf_plus1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="o">+</span><span class="mf">1.0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">func_plus1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="o">+</span><span class="mf">1.0</span><span class="p">,</span><span class="n">ctf_plus1</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">);</span>
<span class="w">    </span><span class="n">saf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">sa</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="n">func_zero</span><span class="o">/</span><span class="p">(</span><span class="n">func_plus1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func_zero</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">saf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">saf</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">saf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ctf_sa</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">dfunc_dsaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="o">*</span><span class="n">ctf_sa</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">no_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">no_iter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">no_iter</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">saf_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saf</span><span class="p">;</span>
<span class="w">        </span><span class="n">ctf_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctf</span><span class="p">;</span>
<span class="w">        </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">saf_old</span><span class="p">,</span><span class="n">ctf_old</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h</span><span class="p">)</span>
<span class="w">                 </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">saf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">);</span>

<span class="w">        </span><span class="n">saf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="o">/</span><span class="n">dfunc_dsaf</span><span class="p">;</span>
<span class="w">        </span><span class="n">saf_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">saf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">saf_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">ctf_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">saf_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">saf_mean</span><span class="p">,</span><span class="n">ctf_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                             </span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>

<span class="w">        </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">saf_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">        </span><span class="n">dfunc_dsaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="o">*</span><span class="n">ctf_sa</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">);</span>
<span class="w">        </span><span class="n">saf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="o">/</span><span class="n">dfunc_dsaf</span><span class="p">;</span>
<span class="w">        </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">saf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">*</span><span class="n">sa_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saf</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">ct_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctf</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">w_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="o">*</span><span class="n">sa_freeze</span><span class="p">,</span><span class="o">*</span><span class="n">ct_freeze</span><span class="p">,</span><span class="n">p</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_internal_energy_ice                   specific internal energy of ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_internal_energy_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the specific internal energy of ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  internal_energy_ice  =  specific internal energy (u)              [J/kg]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_internal_energy_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span>
<span class="w">             </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">db2pa</span><span class="o">*</span><span class="n">p</span>
<span class="w">             </span><span class="o">+</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_p0</span><span class="p">)</span><span class="o">*</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_kappa_const_t_ice                          isothermal compressibility</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_kappa_const_t_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates isothermal compressibility of ice.</span>
<span class="cm">%  Note. This is the compressibility of ice AT CONSTANT IN-SITU</span>
<span class="cm">%    TEMPERATURE</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  kappa_const_t_ice  =  isothermal compressibility                [ 1/Pa ]</span>
<span class="cm">%   Note. The output units are 1/Pa not 1/dbar.</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_kappa_const_t_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="o">-</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_kappa_ice                                  isentropic compressibility</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_kappa_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the isentropic compressibility of ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  kappa_ice  =  isentropic compressibility                        [ 1/Pa ]</span>
<span class="cm">%   Note. The output units are 1/Pa not 1/dbar.</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_kappa_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">gi_tp</span><span class="p">,</span><span class="w"> </span><span class="n">gi_tt</span><span class="p">;</span>

<span class="w">    </span><span class="n">gi_tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gi_tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">((</span><span class="n">gi_tp</span><span class="o">*</span><span class="n">gi_tp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gi_tt</span><span class="o">*</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="o">/</span>
<span class="w">              </span><span class="p">(</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">gi_tt</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_melting_ice_equilibrium_SA_CT_ratio    ratio of SA to CT changes when</span>
<span class="cm">%                             ice melts into a large mass of seawater, with</span>
<span class="cm">%                              both the seawater and ice temperatures being</span>
<span class="cm">%                      almost equal to the equilibrium freezing temperature</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_melting_ice_equilibrium_SA_CT_ratio(SA,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratio of SA to CT changes when ice melts into seawater</span>
<span class="cm">%  with both the seawater and the seaice temperatures being almost equal to</span>
<span class="cm">%  the equilibrium freezing temperature.  It is assumed that a small mass</span>
<span class="cm">%  of ice melts into an infinite mass of seawater.  If indeed the</span>
<span class="cm">%  temperature of the seawater and the ice were both equal to the freezing</span>
<span class="cm">%  temperature, then no melting or freezing would occur; an imbalance</span>
<span class="cm">%  between these three temperatures is needed for freezing or melting to</span>
<span class="cm">%  occur (the three temperatures being (1) the seawater temperature,</span>
<span class="cm">%  (2) the ice temperature, and (3) the freezing temperature.</span>
<span class="cm">%</span>
<span class="cm">%  The output, melting_ice_equilibrium_SA_CT_ratio, is dSA/dCT rather than</span>
<span class="cm">%  dCT/dSA.  This is done so that when SA = 0, the output, dSA/dCT is zero</span>
<span class="cm">%  whereas dCT/dSA would be infinite.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity of seawater                            [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure at which the melting occurs                 [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  melting_ice_equilibrium_SA_CT_ratio = the ratio dSA/dCT of SA to CT</span>
<span class="cm">%                                changes when ice melts into seawater, with</span>
<span class="cm">%                                the seawater and seaice being close to the</span>
<span class="cm">%                                freezing temperature.         [ g/(kg K) ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqn. (16) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_melting_ice_equilibrium_sa_ct_ratio</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">t_seaice</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">t_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_melting_ice_SA_CT_ratio                ratio of SA to CT changes when</span>
<span class="cm">%                                                   ice melts into seawater</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_melting_ice_SA_CT_ratio(SA,CT,p,t_Ih)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratio of SA to CT changes when ice melts into seawater.</span>
<span class="cm">%  It is assumed that a small mass of ice melts into an infinite mass of</span>
<span class="cm">%  seawater.  Because of the infinite mass of seawater, the ice will always</span>
<span class="cm">%  melt.</span>
<span class="cm">%</span>
<span class="cm">%  The output, melting_seaice_SA_CT_ratio, is dSA/dCT rather than dCT/dSA.</span>
<span class="cm">%  This is done so that when SA = 0, the output, dSA/dCT is zero whereas</span>
<span class="cm">%  dCT/dSA would be infinite.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA   =  Absolute Salinity of seawater                           [ g/kg ]</span>
<span class="cm">%  CT   =  Conservative Temperature of seawater (ITS-90)          [ deg C ]</span>
<span class="cm">%  p    =  sea pressure at which the melting occurs                [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  t_Ih =  the in-situ temperature of the ice (ITS-90)            [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  melting_ice_SA_CT_ratio = the ratio of SA to CT changes when ice melts</span>
<span class="cm">%                            into a large mass of seawater</span>
<span class="cm">%                                                          [ g kg^-1 K^-1 ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqn. (13) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_melting_ice_sa_ct_ratio</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="n">t_ih</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ctf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_ih</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_ih</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">));</span>
<span class="p">}</span>



<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_melting_seaice_equilibrium_SA_CT_ratio      ratio of SA to CT changes</span>
<span class="cm">%                         when sea ice melts into a large mass of seawater,</span>
<span class="cm">%                     with both the seawater and sea ice temperatures being</span>
<span class="cm">%                      almost equal to the equilibrium freezing temperature</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_melting_seaice_equilibrium_SA_CT_ratio(SA,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratio of SA to CT changes when sea ice melts into</span>
<span class="cm">%  seawater with both the seawater and the sea ice temperatures being</span>
<span class="cm">%  almost equal to the equilibrium freezing temperature.  It is assumed</span>
<span class="cm">%  that a small mass of seaice melts into an infinite mass of seawater.  If</span>
<span class="cm">%  indeed the temperature of the seawater and the sea ice were both equal</span>
<span class="cm">%  to the freezing temperature, then no melting or freezing would occur; an</span>
<span class="cm">%  imbalance between these three temperatures is needed for freezing or</span>
<span class="cm">%  melting to occur (the three temperatures being (1) the seawater</span>
<span class="cm">%  temperature, (2) the sea ice temperature, and (3) the freezing</span>
<span class="cm">%  temperature.</span>
<span class="cm">%</span>
<span class="cm">%  Note that the output of this function, dSA/dCT is independent of the</span>
<span class="cm">%  sea ice salinity, SA_seaice.  That is, the output applies equally to</span>
<span class="cm">%  pure ice Ih and to sea ice with seaice salinity, SA_seaice.  This result</span>
<span class="cm">%  is proven in McDougall et al. (2014).</span>
<span class="cm">%</span>
<span class="cm">%  The output, melting_seaice_equilibrium_SA_CT_ratio, is dSA/dCT rather</span>
<span class="cm">%  than dCT/dSA.  This is done so that when SA = 0, the output, dSA/dCT is</span>
<span class="cm">%  zero whereas dCT/dSA would be infinite.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity of seawater                            [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure at which the melting occurs                 [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  melting_seaice_equilibrium_SA_CT_ratio = the ratio dSA/dCT of SA to CT</span>
<span class="cm">%                            changes when sea ice melts into seawater, with</span>
<span class="cm">%                            the seawater and sea ice being close to the</span>
<span class="cm">%                            freezing temperature.             [ g/(kg K) ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqn. (29) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_melting_seaice_equilibrium_sa_ct_ratio</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span>
<span class="w">                                                            </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">t_seaice</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">t_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm">% gsw_melting_seaice_equilibrium_SA_CT_ratio_poly</span>
<span class="cm">%   ratio of SA to CT changes when sea ice melts into a large mass of</span>
<span class="cm">%   seawater, with both the seawater and sea ice temperatures being</span>
<span class="cm">%   almost equal to the equilibrium freezing temperature  (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_melting_seaice_equilibrium_SA_CT_ratio(SA,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratio of SA to CT changes when sea ice melts into</span>
<span class="cm">%  seawater with both the seawater and the sea ice temperatures being</span>
<span class="cm">%  almost equal to the equilibrium freezing temperature.  It is assumed</span>
<span class="cm">%  that a small mass of seaice melts into an infinite mass of seawater.  If</span>
<span class="cm">%  indeed the temperature of the seawater and the sea ice were both equal</span>
<span class="cm">%  to the freezing temperature, then no melting or freezing would occur; an</span>
<span class="cm">%  imbalance between these three temperatures is needed for freezing or</span>
<span class="cm">%  melting to occur (the three temperatures being (1) the seawater</span>
<span class="cm">%  temperature, (2) the sea ice temperature, and (3) the freezing</span>
<span class="cm">%  temperature.</span>
<span class="cm">%</span>
<span class="cm">%  Note that the output of this function, dSA/dCT is independent of the</span>
<span class="cm">%  sea ice salinity, SA_seaice.  That is, the output applies equally to</span>
<span class="cm">%  pure ice Ih and to sea ice with seaice salinity, SA_seaice.  This result</span>
<span class="cm">%  is proven in McDougall et al. (2014).</span>
<span class="cm">%</span>
<span class="cm">%  The output, melting_seaice_equilibrium_SA_CT_ratio, is dSA/dCT rather</span>
<span class="cm">%  than dCT/dSA.  This is done so that when SA = 0, the output, dSA/dCT is</span>
<span class="cm">%  zero whereas dCT/dSA would be infinite.</span>
<span class="cm">%</span>
<span class="cm">%  Note that the 75-term equation has been fitted in a restricted range of</span>
<span class="cm">%  parameter space, and is most accurate inside the &quot;oceanographic funnel&quot;</span>
<span class="cm">%  described in McDougall et al. (2003).  The GSW library function</span>
<span class="cm">%  &quot;gsw_infunnel(SA,CT,p)&quot; is avaialble to be used if one wants to test if</span>
<span class="cm">%  some of one&#39;s data lies outside this &quot;funnel&quot;.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity of seawater                            [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure at which the melting occurs                 [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  melting_seaice_equilibrium_SA_CT_ratio = the ratio dSA/dCT of SA to CT</span>
<span class="cm">%                            changes when sea ice melts into seawater, with</span>
<span class="cm">%                            the seawater and sea ice being close to the</span>
<span class="cm">%                            freezing temperature.             [ g/(kg K) ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqn. (29) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling., 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_melting_seaice_equilibrium_sa_ct_ratio_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span>
<span class="w">                                                                  </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">t_seaice</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">t_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="w">  </span><span class="o">*</span><span class="n">h_hat_sa</span><span class="p">));</span>
<span class="p">}</span>



<span class="cm">/****************************************************************************</span>
<span class="cm">% gsw_melting_seaice_into_seawater             the resulting SA and CT when</span>
<span class="cm">%                                           sea ice is melted into seawater</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%   gsw_melting_seaice_into_seawater(SA,CT,p,w_seaice,SA_seaice,t_seaice)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the Absolute Salinity and Conservative Temperature that</span>
<span class="cm">%  results when a given mass of sea ice (or ice) melts and is mixed into a</span>
<span class="cm">%  known mass of seawater (whose properties are (SA,CT,p)).</span>
<span class="cm">%</span>
<span class="cm">%  If the ice contains no salt (e.g. if it is of glacial origin), then the</span>
<span class="cm">%  input &#39;SA_seaice&#39; should be set to zero.</span>
<span class="cm">%</span>
<span class="cm">%  Ice formed at the sea surface (sea ice) typically contains between 2 g/kg</span>
<span class="cm">%  and 12 g/kg of salt (defined as the mass of salt divided by the mass of</span>
<span class="cm">%  ice Ih plus brine) and this programme returns NaN&#39;s if the input</span>
<span class="cm">%  SA_seaice is greater than 15 g/kg.  If the SA_seaice input is not zero,</span>
<span class="cm">%  usually this would imply that the pressure p should be zero, as sea ice</span>
<span class="cm">%  only occurs near the sea surface.  The code does not impose that p = 0</span>
<span class="cm">%  if SA_seaice is non-zero.  Rather, this is left to the user.</span>
<span class="cm">%</span>
<span class="cm">%  The Absolute Salinity, SA_brine, of the brine trapped in little pockets</span>
<span class="cm">%  in the sea ice, is in thermodynamic equilibrium with the ice Ih that</span>
<span class="cm">%  surrounds these pockets.  As the sea ice temperature, t_seaice, may be</span>
<span class="cm">%  less than the freezing temperature, SA_brine is usually greater than the</span>
<span class="cm">%  Absolute Salinity of the seawater at the time and place when and where</span>
<span class="cm">%  the sea ice was formed.  So usually SA_brine will be larger than SA.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity of seawater                            [ g/kg ]</span>
<span class="cm">%  CT  =  Conservative Temperature of seawater (ITS-90)           [ deg C ]</span>
<span class="cm">%  p   =  sea pressure at which the melting occurs                 [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  w_seaice  =  mass fraction of sea ice, that is the mass of sea ice</span>
<span class="cm">%               divided by the sum of the masses of sea ice and seawater.</span>
<span class="cm">%               That is, the mass of sea ice divided by the mass of the</span>
<span class="cm">%               final mixed fluid.  w_seaice must be between 0 and 1.</span>
<span class="cm">%                                                              [ unitless ]</span>
<span class="cm">%  SA_seaice =  Absolute Salinity of sea ice, that is, the mass fraction of</span>
<span class="cm">%               salt in sea ice, expressed in g of salt per kg of sea ice.</span>
<span class="cm">%                                                                  [ g/kg ]</span>
<span class="cm">%  t_seaice  =  the in-situ temperature of the sea ice (or ice) (ITS-90)</span>
<span class="cm">%                                                                 [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_final  =  Absolute Salinity of the mixture of the melted sea ice</span>
<span class="cm">%               (or ice) and the orignal seawater                  [ g/kg ]</span>
<span class="cm">%  CT_final  =  Conservative Temperature of the mixture of the melted</span>
<span class="cm">%               sea ice (or ice) and the orignal seawater         [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%     Eqns. (8) and (9) are the simplifications when SA_seaice = 0.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_melting_seaice_into_seawater</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="n">w_seaice</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="n">t_seaice</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct_final</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_brine</span><span class="p">,</span><span class="w"> </span><span class="n">h_final</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">sa_brine</span><span class="p">,</span><span class="w"> </span><span class="n">tf_sa_seaice</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ctf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">tf_sa_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_seaice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tf_sa_seaice</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">sa_brine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_sa_freezing_from_t</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa_brine</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">cppGSW_ERROR_LIMIT</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">h_brine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_t_exact</span><span class="p">(</span><span class="n">sa_brine</span><span class="p">,</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_seaice</span><span class="o">*</span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">h_brine</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">)</span><span class="o">*</span><span class="n">sa_seaice</span><span class="o">/</span><span class="n">sa_brine</span><span class="p">);</span>
<span class="w">    </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_seaice</span><span class="o">*</span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">);</span>
<span class="w">    </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_from_enthalpy_exact</span><span class="p">(</span><span class="o">*</span><span class="n">sa_final</span><span class="p">,</span><span class="n">h_final</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cppGSW_ERROR_LIMIT</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ct_final</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_melting_seaice_SA_CT_ratio_poly        ratio of SA to CT changes when</span>
<span class="cm">%                                        sea ice melts into seawater (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_melting_seaice_SA_CT_ratio_poly(SA,CT,p,SA_seaice,t_seaice)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratio of SA to CT changes when sea ice melts into</span>
<span class="cm">%  seawater.  It is assumed that a small mass of sea ice melts into an</span>
<span class="cm">%  infinite mass of seawater.  Because of the infinite mass of seawater,</span>
<span class="cm">%  the sea ice will always melt.</span>
<span class="cm">%</span>
<span class="cm">%  Ice formed at the sea surface (sea ice) typically contains between 2 g/kg</span>
<span class="cm">%  and 12 g/kg of salt (defined as the mass of salt divided by the mass of</span>
<span class="cm">%  ice Ih plus brine) and this programme returns NaN&#39;s if the input</span>
<span class="cm">%  SA_seaice is greater than 15 g/kg.  If the SA_seaice input is not zero,</span>
<span class="cm">%  usually this would imply that the pressure p should be zero, as sea ice</span>
<span class="cm">%  only occurs near the sea surface.  The code does not impose that p = 0</span>
<span class="cm">%  if SA_seaice is non-zero.  Rather, this is left to the user.</span>
<span class="cm">%</span>
<span class="cm">%  The Absolute Salinity, SA_brine, of the brine trapped in little pockets</span>
<span class="cm">%  in the sea ice, is in thermodynamic equilibrium with the ice Ih that</span>
<span class="cm">%  surrounds these pockets.  As the seaice temperature, t_seaice, may be</span>
<span class="cm">%  less than the freezing temperature, SA_brine is usually greater than the</span>
<span class="cm">%  Absolute Salinity of the seawater at the time and place when and where</span>
<span class="cm">%  the sea ice was formed.  So usually SA_brine will be larger than SA.</span>
<span class="cm">%</span>
<span class="cm">%  The output, melting_seaice_SA_CT_ratio, is dSA/dCT rather than dCT/dSA.</span>
<span class="cm">%  This is done so that when (SA - seaice_SA) = 0, the output, dSA/dCT is</span>
<span class="cm">%  zero whereas dCT/dSA would be infinite.</span>
<span class="cm">%</span>
<span class="cm">%  Note that the 75-term equation has been fitted in a restricted range of</span>
<span class="cm">%  parameter space, and is most accurate inside the &quot;oceanographic funnel&quot;</span>
<span class="cm">%  described in McDougall et al. (2003).  The GSW library function</span>
<span class="cm">%  &quot;gsw_infunnel(SA,CT,p)&quot; is avaialble to be used if one wants to test if</span>
<span class="cm">%  some of one&#39;s data lies outside this &quot;funnel&quot;.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity of seawater                            [ g/kg ]</span>
<span class="cm">%  CT  =  Conservative Temperature of seawater (ITS-90)           [ deg C ]</span>
<span class="cm">%  p   =  sea pressure at which the melting occurs                 [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  SA_seaice =  Absolute Salinity of sea ice, that is, the mass fraction</span>
<span class="cm">%               of salt in sea ice expressed in g of salt per kg of</span>
<span class="cm">%               sea ice                                            [ g/kg ]</span>
<span class="cm">%  t_seaice =   the in-situ temperature of the sea ice (ITS-90)   [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  melting_seaice_SA_CT_ratio = the ratio dSA/dCT of SA to CT changes when</span>
<span class="cm">%                sea ice melts into a large mass of seawater   [ g/(kg K) ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqn. (31) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling., 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_melting_seaice_sa_ct_ratio_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="n">t_seaice</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">delsa</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_brine</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">sa_brine</span><span class="p">,</span><span class="w"> </span><span class="n">ct_brine</span><span class="p">,</span>
<span class="w">              </span><span class="n">tf_sa_seaice</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">,</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa_seaice</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sa_seaice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">15.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">NAN</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ctf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">tf_sa_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing_poly</span><span class="p">(</span><span class="n">sa_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_seaice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tf_sa_seaice</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa_brine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_sa_freezing_from_t_poly</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa_brine</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cppGSW_ERROR_LIMIT</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">ct_brine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_from_t</span><span class="p">(</span><span class="n">sa_brine</span><span class="p">,</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_brine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy</span><span class="p">(</span><span class="n">sa_brine</span><span class="p">,</span><span class="n">ct_brine</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">delsa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">h_hat_ct</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">delsa</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span>
<span class="w">             </span><span class="o">-</span><span class="w"> </span><span class="n">delsa</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h_hat_sa</span>
<span class="w">             </span><span class="o">-</span><span class="w"> </span><span class="n">sa_seaice</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">h_brine</span>
<span class="w">             </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sa_brine</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_pressure_freezing_CT             pressure of seawater at the freezing</span>
<span class="cm">%                                                               temperature</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_pressure_freezing_CT(SA,CT,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the pressure (in dbar) of seawater at the freezing</span>
<span class="cm">%  temperature.  That is, the output is the pressure at which seawater,</span>
<span class="cm">%  with Absolute Salinity SA, Conservative Temperature CT, and with</span>
<span class="cm">%  saturation_fraction of dissolved air, freezes.  If the input values are</span>
<span class="cm">%  such that there is no value of pressure in the range between 0 dbar and</span>
<span class="cm">%  10,000 dbar for which seawater is at the freezing temperature, the</span>
<span class="cm">%  output, pressure_freezing, is put equal to NaN.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity of seawater                            [ g/kg ]</span>
<span class="cm">%  CT  =  Conservative Temperature (ITS-90)                       [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  pressure_freezing = sea pressure at which the seawater freezes  [ dbar ]</span>
<span class="cm">%        ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See section 3.33 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall T. J. and S. J. Wotherspoon, 2013: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pressure_freezing_ct</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span>
<span class="w">                                          </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">i_iter</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>

<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ct_freezing_p0</span><span class="p">,</span><span class="w"> </span><span class="n">ct_freezing_p10000</span><span class="p">,</span><span class="w"> </span><span class="n">dctf_dp</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span>
<span class="w">              </span><span class="n">pf</span><span class="p">,</span><span class="w"> </span><span class="n">pfm</span><span class="p">,</span><span class="w"> </span><span class="n">pf_old</span><span class="p">,</span><span class="w"> </span><span class="n">ctfreezing_p</span><span class="p">;</span>

<span class="w">    </span><span class="n">ct_freezing_p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ct_freezing_p0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">ct_freezing_p10000</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="mf">1e4</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ct_freezing_p10000</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">pf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">rec_pa2db</span><span class="o">*</span><span class="p">(</span><span class="n">ct_freezing_p0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct</span><span class="p">)</span><span class="o">/</span>
<span class="w">          </span><span class="p">(</span><span class="n">ct_freezing_p0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct_freezing_p10000</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">pf</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                 </span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ctfreezing_p</span><span class="p">);</span>
<span class="w">    </span><span class="n">dctf_dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">rec_pa2db</span><span class="o">*</span><span class="n">ctfreezing_p</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i_iter</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i_iter</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pf_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pf</span><span class="p">;</span>
<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">pf_old</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct</span><span class="p">;</span>
<span class="w">        </span><span class="n">pf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">dctf_dp</span><span class="p">;</span>
<span class="w">        </span><span class="n">pfm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pf_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">pfm</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                     </span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ctfreezing_p</span><span class="p">);</span>
<span class="w">        </span><span class="n">dctf_dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">rec_pa2db</span><span class="o">*</span><span class="n">ctfreezing_p</span><span class="p">;</span>
<span class="w">        </span><span class="n">pf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">dctf_dp</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_sa_p_inrange</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">pf</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pf</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">==========================================================================</span>
<span class="cm">  method: gsw_pt_from_pot_enthalpy_ice_poly_dh (pot_enthalpy_ice)</span>
<span class="cm">==========================================================================</span>
<span class="cm">   This method supplements &#39;gsw_pt_from_pot_enthalpy_ice_poly&#39;</span>
<span class="cm">-------------------------------------------------------------------------</span>
<span class="cm">*****************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pt_from_pot_enthalpy_ice_poly_dh</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.594351081876611e-3</span><span class="p">,</span>
<span class="w">             </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.530155620427630e-8</span><span class="p">,</span>
<span class="w">             </span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.330421169287162e-13</span><span class="p">,</span>
<span class="w">             </span><span class="n">p4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8.139369017110120e-19</span><span class="p">,</span>
<span class="w">             </span><span class="n">p5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.610007265856420e-24</span><span class="p">,</span>
<span class="w">             </span><span class="n">p6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.707103685781641e-30</span><span class="p">,</span>
<span class="w">             </span><span class="n">p7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">7.658041152250651e-37</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">q1</span>
<span class="w">             </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p2</span>
<span class="w">             </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p3</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p4</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p5</span>
<span class="w">                </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p6</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="n">p7</span><span class="p">))))));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_pt_from_pot_enthalpy_ice_poly        potential temperature refered to</span>
<span class="cm">%                         the surface from potential enthalpy of ice (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_pt_from_pot_enthalpy_ice_poly(pot_enthalpy_ice)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the potential temperature of ice (whose reference sea</span>
<span class="cm">%  pressure is zero dbar) from the potential enthalpy of ice.  This is a</span>
<span class="cm">%  compuationally efficient polynomial fit to the potential enthalpy of</span>
<span class="cm">%  ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  pot_enthalpy_ice  =  potential enthalpy of ice                  [ J/kg ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  pt0_ice  =  potential temperature of ice (ITS-90)              [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pt_from_pot_enthalpy_ice_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">q0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.533588268773218e2</span><span class="p">,</span>
<span class="w">             </span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.594351081876611e-3</span><span class="p">,</span>
<span class="w">             </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.765077810213815e-8</span><span class="p">,</span>
<span class="w">             </span><span class="n">q3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">7.768070564290540e-14</span><span class="p">,</span>
<span class="w">             </span><span class="n">q4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.034842254277530e-19</span><span class="p">,</span>
<span class="w">             </span><span class="n">q5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3.220014531712841e-25</span><span class="p">,</span>
<span class="w">             </span><span class="n">q6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.845172809636068e-31</span><span class="p">,</span>
<span class="w">             </span><span class="n">q7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.094005878892950e-37</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">q0</span>
<span class="w">               </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">q1</span>
<span class="w">               </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">q2</span>
<span class="w">               </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">q3</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">q4</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">q5</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="p">(</span><span class="n">q6</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="o">*</span><span class="n">q7</span><span class="p">)))))));</span>
<span class="p">}</span>




<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_pt_from_t_ice                            potential temperature of ice</span>
<span class="cm">% =========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_pt_from_t_ice(t,p,p_ref)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates potential temperature of ice Ih with the general reference</span>
<span class="cm">%  pressure, p_ref, from in-situ temperature, t.</span>
<span class="cm">%</span>
<span class="cm">%  A faster gsw routine exists if p_ref is indeed zero dbar.  This routine</span>
<span class="cm">%  is &quot;gsw_pt0_from_t_ice(t,p)&quot;.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  p_ref  =  reference pressure                                    [ dbar ]</span>
<span class="cm">%  (If reference pressure is not given then it is assumed that reference</span>
<span class="cm">%   pressure is zero).</span>
<span class="cm">%</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  pt_ice  =  potential temperature of ice Ih with reference pressure,</span>
<span class="cm">%             p_ref, on the ITS-90 temperature scale              [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker.                   [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%    See appendix I of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall T. J. and S. J. Wotherspoon, 2014: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pt_from_t_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p_ref</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dentropy</span><span class="p">,</span><span class="w"> </span><span class="n">dentropy_dt</span><span class="p">,</span><span class="w"> </span><span class="n">dp</span><span class="p">,</span>
<span class="w">             </span><span class="n">pt_ice</span><span class="p">,</span><span class="w"> </span><span class="n">pt_ice_old</span><span class="p">,</span><span class="w"> </span><span class="n">ptm_ice</span><span class="p">,</span><span class="w"> </span><span class="n">true_entropy</span><span class="p">,</span>
<span class="w">             </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.259745637898635e-4</span><span class="p">,</span>
<span class="w">             </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.486236778150360e-9</span><span class="p">,</span>
<span class="w">             </span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">6.257869607978536e-12</span><span class="p">,</span>
<span class="w">             </span><span class="n">p4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.253795281359302e-7</span><span class="p">,</span>
<span class="w">             </span><span class="n">p5</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">6.752596995671330e-9</span><span class="p">,</span>
<span class="w">             </span><span class="n">p6</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.082992190070936e-11</span><span class="p">,</span>
<span class="w">             </span><span class="n">q1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.849191185294459e-15</span><span class="p">,</span>
<span class="w">             </span><span class="n">q2</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">9.330347971181604e-11</span><span class="p">,</span>
<span class="w">             </span><span class="n">q3</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">3.415888886921213e-13</span><span class="p">,</span>
<span class="w">             </span><span class="n">q4</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.064901553161811e-12</span><span class="p">,</span>
<span class="w">             </span><span class="n">q5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.454060359158787e-10</span><span class="p">,</span>
<span class="w">             </span><span class="n">q6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.323461372791532e-13</span><span class="p">;</span>

<span class="w">    </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p_ref</span><span class="p">;</span>
<span class="w">    </span><span class="n">pt_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dp</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_ref</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">p4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">p5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p6</span><span class="o">*</span><span class="n">t</span><span class="p">)));</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pt_ice</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="p">)</span><span class="w"> </span><span class="n">pt_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pt_ice</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">-273.0</span><span class="p">)</span><span class="w"> </span><span class="n">pt_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.05</span><span class="p">;</span>
<span class="w">    </span><span class="n">dentropy_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">pt_ice</span><span class="p">,</span><span class="n">p_ref</span><span class="p">);</span>
<span class="w">    </span><span class="n">true_entropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_part_t</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">            </span><span class="n">number_of_iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pt_ice_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_ice</span><span class="p">;</span>
<span class="w">        </span><span class="n">dentropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_part_t</span><span class="p">(</span><span class="n">pt_ice_old</span><span class="p">,</span><span class="n">p_ref</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">true_entropy</span><span class="p">;</span>
<span class="w">        </span><span class="n">pt_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dentropy</span><span class="o">/</span><span class="n">dentropy_dt</span><span class="p">;</span>
<span class="w">        </span><span class="n">ptm_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pt_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pt_ice_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">dentropy_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ptm_ice</span><span class="p">,</span><span class="n">p_ref</span><span class="p">);</span>
<span class="w">        </span><span class="n">pt_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dentropy</span><span class="o">/</span><span class="n">dentropy_dt</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pt_ice</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">-273.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pt_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p_ref</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p_ref</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q3</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="w">                                          </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">q4</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">q5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">q6</span><span class="o">*</span><span class="n">t</span><span class="p">)));</span>
<span class="w">        </span><span class="n">dentropy_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">pt_ice</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span><span class="n">p_ref</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">                </span><span class="n">number_of_iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">pt_ice_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_ice</span><span class="p">;</span>
<span class="w">            </span><span class="n">dentropy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice_part_t</span><span class="p">(</span><span class="n">pt_ice_old</span><span class="p">,</span><span class="n">p_ref</span><span class="p">)</span>
<span class="w">                          </span><span class="o">-</span><span class="w"> </span><span class="n">true_entropy</span><span class="p">;</span>
<span class="w">            </span><span class="n">pt_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dentropy</span><span class="o">/</span><span class="n">dentropy_dt</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptm_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pt_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pt_ice_old</span><span class="p">);</span>
<span class="w">            </span><span class="n">ptm_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptm_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.01</span><span class="p">;</span>
<span class="w">            </span><span class="n">dentropy_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">ptm_ice</span><span class="p">,</span><span class="n">p_ref</span><span class="p">);</span>
<span class="w">            </span><span class="n">pt_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dentropy</span><span class="o">/</span><span class="n">dentropy_dt</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pt_ice</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_rho_ice                                                density of ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_rho_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates in-situ density of ice from in-situ temperature and pressure.</span>
<span class="cm">%  Note that the output, rho_ice, is density, not density anomaly;  that</span>
<span class="cm">%  is, 1000 kg/m^3 is not subracted from it.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t   =  in-situ temperature (ITS-90)                            [ deg C ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  rho_ice  =  in-situ density of ice (not density anomaly)      [ kg/m^3 ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">% The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_rho_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_SA_freezing_from_t               Absolute Salinity of seawater at the</span>
<span class="cm">%                                                      freezing temperature</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_SA_freezing_from_t(t,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the Absolute Salinity of seawater at the freezing temperature.</span>
<span class="cm">%  That is, the output is the Absolute Salinity of seawater, with the</span>
<span class="cm">%  fraction saturation_fraction of dissolved air, that is in equilibrium</span>
<span class="cm">%  with ice at in-situ temperature t and pressure p.  If the input values</span>
<span class="cm">%  are such that there is no positive value of Absolute Salinity for which</span>
<span class="cm">%  seawater is frozen, the output, SA_freezing, is set to NaN.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ Temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%        ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_freezing =  Absolute Salinity of seawater when it freezes, for</span>
<span class="cm">%                 given input values of in situ temperature, pressure and</span>
<span class="cm">%                 air saturation fraction.                         [ g/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See section 3.33 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., and S.J. Wotherspoon, 2013: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_sa_freezing_from_t</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                          </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i_iter</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="n">sa_mean</span><span class="p">,</span><span class="w"> </span><span class="n">sa_old</span><span class="p">,</span><span class="w"> </span><span class="n">t_freezing_zero_sa</span><span class="p">,</span><span class="w"> </span><span class="n">tfreezing_sa</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">sa_cut_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.5</span><span class="p">;</span>
<span class="w">    </span><span class="n">t_freezing_zero_sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">t_freezing_zero_sa</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_sa_freezing_estimate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">sa_cut_off</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_max_d</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                </span><span class="o">&amp;</span><span class="n">tfreezing_sa</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">sa</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sa_cut_off</span><span class="p">)</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t_freezing_zero_sa</span><span class="p">)</span><span class="o">/</span><span class="n">tfreezing_sa</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i_iter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i_iter</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">sa_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="p">;</span>
<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa_old</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">tfreezing_sa</span><span class="p">;</span>
<span class="w">        </span><span class="n">sa_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_t_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                    </span><span class="o">&amp;</span><span class="n">tfreezing_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">tfreezing_sa</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_sa_p_inrange</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_SA_freezing_from_CT              Absolute Salinity of seawater at the</span>
<span class="cm">%                                                            freezing point</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_SA_freezing_from_CT(CT,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the Absolute Salinity of seawater at the freezing temperature.</span>
<span class="cm">%  That is, the output is the Absolute Salinity of seawater, with</span>
<span class="cm">%  Conservative Temperature CT, pressure p and the fraction</span>
<span class="cm">%  saturation_fraction of dissolved air, that is in equilibrium</span>
<span class="cm">%  with ice at the same in situ temperature and pressure.  If the input</span>
<span class="cm">%  values are such that there is no positive value of Absolute Salinity for</span>
<span class="cm">%  which seawater is frozen, the output, SA_freezing, is made a NaN.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  CT  =  Conservative Temperature of seawater (ITS-90)           [ deg C ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction  =  the saturation fraction of dissolved air in</span>
<span class="cm">%                          seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_freezing =  Absolute Salinity of seawater when it freezes, for</span>
<span class="cm">%                 given input values of its Conservative Temperature,</span>
<span class="cm">%                 pressure and air saturation fraction.            [ g/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See section 3.33 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., and S.J. Wotherspoon, 2014: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_sa_freezing_from_ct</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                          </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i_iter</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">ct_freezing_zero_sa</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">ctfreezing_sa</span><span class="p">,</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="n">sa_mean</span><span class="p">,</span><span class="w"> </span><span class="n">sa_old</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">sa_cut_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.5</span><span class="p">;</span>
<span class="w">    </span><span class="n">ct_freezing_zero_sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ct_freezing_zero_sa</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_sa_freezing_estimate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ct</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">sa_cut_off</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_max_d</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                 </span><span class="o">&amp;</span><span class="n">ctfreezing_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">sa</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sa_cut_off</span><span class="p">)</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct_freezing_zero_sa</span><span class="p">)</span><span class="o">/</span><span class="n">ctfreezing_sa</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i_iter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i_iter</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">sa_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="p">;</span>
<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct</span><span class="p">;</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">ctfreezing_sa</span><span class="p">;</span>
<span class="w">        </span><span class="n">sa_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">sa_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">ctfreezing_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">ctfreezing_sa</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_sa_p_inrange</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_SA_freezing_from_t_poly          Absolute Salinity of seawater at the</span>
<span class="cm">%                                                     freezing point (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_SA_freezing_from_t_poly(t,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the Absolute Salinity of seawater at the freezing temperature.</span>
<span class="cm">%  That is, the output is the Absolute Salinity of seawater, with the</span>
<span class="cm">%  fraction saturation_fraction of dissolved air, that is in equilibrium</span>
<span class="cm">%  with ice at in-situ temperature t and pressure p.  If the input values</span>
<span class="cm">%  are such that there is no positive value of Absolute Salinity for which</span>
<span class="cm">%  seawater is frozen, the output, SA_freezing, is put equal to NaN.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t  =  in-situ Temperature (ITS-90)                             [ deg C ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%        ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction = the saturation fraction of dissolved air in</span>
<span class="cm">%                        seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_freezing  =  Absolute Salinity of seawater when it freezes, for</span>
<span class="cm">%                  given input values of in situ temperature, pressure and</span>
<span class="cm">%                  air saturation fraction.                        [ g/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See section 3.33 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall T. J. and S. J. Wotherspoon, 2014: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_sa_freezing_from_t_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i_iter</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">dt_dsa</span><span class="p">,</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="n">sa_old</span><span class="p">,</span><span class="w"> </span><span class="n">sa_mean</span><span class="p">,</span><span class="w"> </span><span class="n">t_freezing</span><span class="p">,</span><span class="w"> </span><span class="n">t_freezing_zero_sa</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">sa_cut_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.5</span><span class="p">;</span>
<span class="w">    </span><span class="n">t_freezing_zero_sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing_poly</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">t_freezing_zero_sa</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_sa_freezing_estimate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">sa_cut_off</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_max_d</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_t_freezing_first_derivatives_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                      </span><span class="o">&amp;</span><span class="n">dt_dsa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">sa</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sa_cut_off</span><span class="p">)</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t_freezing_zero_sa</span><span class="p">)</span><span class="o">/</span><span class="n">dt_dsa</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i_iter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i_iter</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">sa_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="p">;</span>
<span class="w">        </span><span class="n">t_freezing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing_poly</span><span class="p">(</span><span class="n">sa_old</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">t_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="n">dt_dsa</span><span class="p">;</span>
<span class="w">        </span><span class="n">sa_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_t_freezing_first_derivatives_poly</span><span class="p">(</span><span class="n">sa_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                          </span><span class="o">&amp;</span><span class="n">dt_dsa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">t_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="n">dt_dsa</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_sa_p_inrange</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">==========================================================================</span>
<span class="cm">  method: gsw_sa_freezing_estimate (p, saturation_fraction,*ct,*t)</span>
<span class="cm">==========================================================================</span>
<span class="cm">         an estimate of SA from a polynomial in CT and p</span>
<span class="cm">--------------------------------------------------------------------------</span>
<span class="cm">****************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_sa_freezing_estimate</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                          </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">ctsat</span><span class="p">,</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span>
<span class="w">             </span><span class="n">aa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.014289763856964</span><span class="p">,</span>
<span class="w">             </span><span class="n">bb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.057000649899720</span><span class="p">,</span>
<span class="w">             </span><span class="n">p0</span><span class="w">  </span><span class="o">=</span><span class="w">  </span><span class="mf">2.570124672768757e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">p1</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.917742353032266e1</span><span class="p">,</span>
<span class="w">             </span><span class="n">p2</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.413382858617969e-2</span><span class="p">,</span>
<span class="w">             </span><span class="n">p3</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">-5.427484830917552e-1</span><span class="p">,</span>
<span class="w">             </span><span class="n">p4</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">-4.126621135193472e-4</span><span class="p">,</span>
<span class="w">             </span><span class="n">p5</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">-4.176407833276121e-7</span><span class="p">,</span>
<span class="w">             </span><span class="n">p6</span><span class="w">  </span><span class="o">=</span><span class="w">  </span><span class="mf">4.688217641883641e-5</span><span class="p">,</span>
<span class="w">             </span><span class="n">p7</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.039808885885726e-8</span><span class="p">,</span>
<span class="w">             </span><span class="n">p8</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">-4.990118091261456e-11</span><span class="p">,</span>
<span class="w">             </span><span class="n">p9</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="mf">-9.733920711119464e-9</span><span class="p">,</span>
<span class="w">             </span><span class="n">p10</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-7.723324202726337e-12</span><span class="p">,</span>
<span class="w">             </span><span class="n">p11</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">7.121854166249257e-16</span><span class="p">,</span>
<span class="w">             </span><span class="n">p12</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.256474634100811e-12</span><span class="p">,</span>
<span class="w">             </span><span class="n">p13</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.105103897918125e-15</span><span class="p">,</span>
<span class="w">             </span><span class="n">p14</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">8.663811778227171e-19</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_max_d</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="o">*</span><span class="n">ct</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">9e-4</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="mf">0.06</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">        </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_max_d</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">9e-4</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">/</span><span class="mf">0.06</span><span class="p">,</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">        </span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_from_t</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="o">*</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">ctsat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">saturation_fraction</span><span class="p">)</span><span class="o">*</span>
<span class="w">              </span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.4</span><span class="o">-</span><span class="n">aa</span><span class="o">*</span><span class="n">sa</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">+</span><span class="n">bb</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">sa</span><span class="o">/</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_sso</span><span class="p">));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">p0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">p2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p4</span><span class="o">*</span><span class="n">ctsat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">p5</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ctsat</span><span class="o">*</span><span class="p">(</span><span class="n">p7</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p9</span><span class="o">*</span><span class="n">ctsat</span><span class="p">)</span>
<span class="w">            </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">p8</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="n">ctsat</span><span class="o">*</span><span class="p">(</span><span class="n">p10</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p12</span><span class="o">*</span><span class="n">ctsat</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">p11</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p13</span><span class="o">*</span><span class="n">ctsat</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p14</span><span class="o">*</span><span class="n">p</span><span class="p">))))</span>
<span class="w">               </span><span class="o">+</span><span class="w"> </span><span class="n">ctsat</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ctsat</span><span class="o">*</span><span class="p">(</span><span class="n">p3</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p6</span><span class="o">*</span><span class="n">p</span><span class="p">)));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_pot_enthalpy_from_pt_ice_poly          potential enthalpy of ice from</span>
<span class="cm">%                              potential temperature refered to the surface</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_pot_enthalpy_from_pt_ice_poly(pt0_ice)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the potential enthalpy of ice from potential temperature of</span>
<span class="cm">%  ice (whose reference sea pressure is zero dbar).  This is a</span>
<span class="cm">%  compuationally efficient polynomial fit to the potential enthalpy of</span>
<span class="cm">%  ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  pt0_ice  =  potential temperature of ice (ITS-90)              [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  pot_enthalpy_ice  =  potential enthalpy of ice                  [ J/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pot_enthalpy_from_pt_ice_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">pt0_ice</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iteration</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">df_dt</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="p">,</span><span class="w"> </span><span class="n">pot_enthalpy_ice_mid</span><span class="p">,</span>
<span class="w">             </span><span class="n">pot_enthalpy_ice_old</span><span class="p">,</span>
<span class="w">               </span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-3.333601570157700e5</span><span class="p">,</span>
<span class="w">               </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.096693916810367e3</span><span class="p">,</span>
<span class="w">               </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">3.687110754043292</span><span class="p">,</span>
<span class="w">               </span><span class="n">p3</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">4.559401565980682e-4</span><span class="p">,</span>
<span class="w">               </span><span class="n">p4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.516011957758120e-6</span><span class="p">,</span>
<span class="w">               </span><span class="n">p5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.040364574632784e-8</span><span class="p">,</span>
<span class="w">               </span><span class="n">p6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-1.701786588412454e-10</span><span class="p">,</span>
<span class="w">               </span><span class="n">p7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-7.667191301635057e-13</span><span class="p">;</span>

<span class="w">    </span><span class="n">pot_enthalpy_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p0</span>
<span class="w">                         </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span>
<span class="w">                         </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p2</span>
<span class="w">                         </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p3</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p4</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p5</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice</span><span class="o">*</span><span class="p">(</span><span class="n">p6</span>
<span class="w">                                </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice</span><span class="o">*</span><span class="n">p7</span><span class="p">))))));</span>

<span class="w">    </span><span class="n">df_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pt_from_pot_enthalpy_ice_poly_dh</span><span class="p">(</span><span class="n">pot_enthalpy_ice</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">iteration</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">iteration</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pot_enthalpy_ice_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="p">;</span>

<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pt_from_pot_enthalpy_ice_poly</span><span class="p">(</span><span class="n">pot_enthalpy_ice_old</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pt0_ice</span><span class="p">;</span>
<span class="w">        </span><span class="n">pot_enthalpy_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pot_enthalpy_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">df_dt</span><span class="p">;</span>
<span class="w">        </span><span class="n">pot_enthalpy_ice_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pot_enthalpy_ice</span><span class="o">+</span><span class="n">pot_enthalpy_ice_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">df_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pt_from_pot_enthalpy_ice_poly_dh</span><span class="p">(</span><span class="n">pot_enthalpy_ice_mid</span><span class="p">);</span>
<span class="w">        </span><span class="n">pot_enthalpy_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pot_enthalpy_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">df_dt</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pot_enthalpy_ice</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">==========================================================================</span>
<span class="cm">method: gsw_ct_freezing_exact(sa,p,saturation_fraction)</span>
<span class="cm">==========================================================================</span>
<span class="cm">   Calculates the Conservative Temperature at which seawater freezes.  The</span>
<span class="cm">   Conservative Temperature freezing point is calculated from the exact</span>
<span class="cm">   in-situ freezing temperature which is found by a modified Newton-Raphson</span>
<span class="cm">   iteration (McDougall and Wotherspoon, 2013) of the equality of the</span>
<span class="cm">   chemical potentials of water in seawater and in ice.</span>
<span class="cm">   An alternative GSW function, gsw_CT_freezing_poly, it is based on a</span>
<span class="cm">   computationally-efficient polynomial, and is accurate to within -5e-4 K</span>
<span class="cm">   and 6e-4 K, when compared with this function.</span>
<span class="cm">   SA    :  Absolute Salinity               [ g/kg ]</span>
<span class="cm">   p  :  sea pressure                    [ dbar ]</span>
<span class="cm">     ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">   saturation_fraction : the saturation fraction of dissolved air in</span>
<span class="cm">          seawater</span>
<span class="cm">   CT_freezing : Conservative Temperature at freezing of seawater [ deg C ]</span>
<span class="cm">---------------------------------------------------------------------------</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_ct_freezing_exact</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">t_freezing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_ct_from_t</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">t_freezing</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_geo_strf_dyn_height_pc                     dynamic height anomaly for</span>
<span class="cm">%                            piecewise constant profiles (75-term equation)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_geo_strf_dyn_height_pc(SA,CT,delta_p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates dynamic height anomaly as the integral of specific volume</span>
<span class="cm">%  anomaly from the the sea surface pressure (0 Pa) to the pressure p.</span>
<span class="cm">%  This function, gsw_geo_strf_dyn_height_pc, is to used when the</span>
<span class="cm">%  Absolute Salinity and Conservative Temperature are piecewise constant in</span>
<span class="cm">%  the vertical over sucessive pressure intervals of delta_p (such as in</span>
<span class="cm">%  a forward &quot;z-coordinate&quot; ocean model).  &quot;geo_strf_dyn_height_pc&quot; is</span>
<span class="cm">%  the dynamic height anomaly with respect to the sea surface.  That is,</span>
<span class="cm">%  &quot;geo_strf_dyn_height_pc&quot; is the geostrophic streamfunction for the</span>
<span class="cm">%  difference between the horizontal velocity at the pressure concerned, p,</span>
<span class="cm">%  and the horizontal velocity at the sea surface.  Dynamic height anomaly</span>
<span class="cm">%  is the geostrophic streamfunction in an isobaric surface.  The reference</span>
<span class="cm">%  values used for the specific volume anomaly are SA = SSO = 35.16504 g/kg</span>
<span class="cm">%  and CT = 0 deg C.  The output values of geo_strf_dyn_height_pc are</span>
<span class="cm">%  given at the mid-point pressures, p_mid, of each layer in which SA and</span>
<span class="cm">%  CT are vertically piecewice constant (pc).  This function calculates</span>
<span class="cm">%  enthalpy using the computationally-efficient 75-term expression for</span>
<span class="cm">%  specific volume of Roquet et al., (2015).</span>
<span class="cm">%</span>
<span class="cm">%  Note that the 75-term equation has been fitted in a restricted range of</span>
<span class="cm">%  parameter space, and is most accurate inside the &quot;oceanographic funnel&quot;</span>
<span class="cm">%  described in McDougall et al. (2003).  The GSW library function</span>
<span class="cm">%  &quot;gsw_infunnel(SA,CT,p)&quot; is avaialble to be used if one wants to test if</span>
<span class="cm">%  some of one&#39;s data lies outside this &quot;funnel&quot;.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA       =  Absolute Salinity                                   [ g/kg ]</span>
<span class="cm">%  CT       =  Conservative Temperature (ITS-90)                  [ deg C ]</span>
<span class="cm">%  delta_p  =  difference in sea pressure between the deep and     [ dbar ]</span>
<span class="cm">%              shallow extents of each layer in which SA and CT</span>
<span class="cm">%              are vertically constant. delta_p must be positive.</span>
<span class="cm">%</span>
<span class="cm">%  Note. sea pressure is absolute pressure minus 10.1325 dbar.</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  geo_strf_dyn_height_pc =  dynamic height anomaly             [ m^2/s^2 ]</span>
<span class="cm">%  p_mid                  =  mid-point pressure in each layer      [ dbar ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Claire Roberts-Thomson         [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%    See Eqns. (3.32.2) and (A.30.6) of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., D.R. Jackett, D.G. Wright and R. Feistel, 2003:</span>
<span class="cm">%   Accurate and computationally efficient algorithms for potential</span>
<span class="cm">%   temperature and density of seawater.  J. Atmosph. Ocean. Tech., 20,</span>
<span class="cm">%   pp. 730-741.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J. and A. Klocker, 2010: An approximate geostrophic</span>
<span class="cm">%   streamfunction for use in density surfaces. Ocean Modelling, 32,</span>
<span class="cm">%   105-117.</span>
<span class="cm">%    See section 8 of this paper.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling., 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_geo_strf_dyn_height_pc</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">delta_p</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">n_levels</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">geo_strf_dyn_height_pc</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">p_mid</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">np</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">delta_h</span><span class="o">=</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">delta_h_half</span><span class="p">,</span><span class="w"> </span><span class="n">dyn_height_deep</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<span class="w">      </span><span class="o">*</span><span class="n">p_deep</span><span class="o">=</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">p_shallow</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">n_levels</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delta_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">np</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_levels</span><span class="p">;</span>
<span class="w">    </span><span class="n">delta_h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="kt">double</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="p">];</span>
<span class="w">    </span><span class="n">p_deep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">delta_h</span><span class="o">+</span><span class="n">np</span><span class="p">;</span>
<span class="w">    </span><span class="n">p_shallow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_deep</span><span class="o">+</span><span class="n">np</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">np</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">p_deep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="n">delta_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">p_deep</span><span class="p">[</span><span class="n">i</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">delta_p</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">      </span><span class="n">p_shallow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p_deep</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">delta_p</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">      </span><span class="n">delta_h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_diff</span><span class="p">(</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ct</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">p_shallow</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">p_deep</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">np</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">dyn_height_deep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dyn_height_deep</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">delta_h</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">      </span><span class="n">p_mid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">p_shallow</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="n">p_deep</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">      </span><span class="n">delta_h_half</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_diff</span><span class="p">(</span><span class="n">sa</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ct</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">p_mid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">p_deep</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">      </span><span class="n">geo_strf_dyn_height_pc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_sso_0</span><span class="p">(</span><span class="n">p_mid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">+</span>
<span class="w">               </span><span class="n">dyn_height_deep</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">delta_h_half</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delta_h</span><span class="p">)</span><span class="w"> </span><span class="k">delete</span><span class="w"> </span><span class="p">[]</span><span class="n">delta_h</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">geo_strf_dyn_height_pc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_IPV_vs_fNsquared_ratio              ratio of the vertical gradient of</span>
<span class="cm">%                       potential density (with reference pressure, p_ref),</span>
<span class="cm">%                            to the vertical gradient of locally-referenced</span>
<span class="cm">%                                      potential density (75-term equation)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_IPV_vs_fNsquared_ratio(SA,CT,p,p_ref)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratio of the vertical gradient of potential density to</span>
<span class="cm">%  the vertical gradient of locally-referenced potential density.  This</span>
<span class="cm">%  ratio is also the ratio of the planetary Isopycnal Potential Vorticity</span>
<span class="cm">%  (IPV) to f times N^2, hence the name for this variable,</span>
<span class="cm">%  IPV_vs_fNsquared_ratio (see Eqn. (3.20.17) of IOC et al. (2010)).</span>
<span class="cm">%  The reference sea pressure, p_ref, of the potential density surface must</span>
<span class="cm">%  have a constant value.</span>
<span class="cm">%</span>
<span class="cm">%  IPV_vs_fNsquared_ratio is evaluated at the mid pressure between the</span>
<span class="cm">%  individual data points in the vertical.  This function uses the</span>
<span class="cm">%  computationally-efficient 75-term expression for specific volume in</span>
<span class="cm">%  terms of SA, CT and p (Roquet et al., 2015).</span>
<span class="cm">%</span>
<span class="cm">%  Note that this 75-term equation has been fitted in a restricted range of</span>
<span class="cm">%  parameter space, and is most accurate inside the &quot;oceanographic funnel&quot;</span>
<span class="cm">%  described in McDougall et al. (2003).  The GSW library function</span>
<span class="cm">%  &quot;gsw_infunnel(SA,CT,p)&quot; is avaialble to be used if one wants to test if</span>
<span class="cm">%  some of one&#39;s data lies outside this &quot;funnel&quot;.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA    = Absolute Salinity                                       [ g/kg ]</span>
<span class="cm">%  CT    = Conservative Temperature (ITS-90)                      [ deg C ]</span>
<span class="cm">%  p     = sea pressure                                            [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  p_ref = reference sea pressure of the potential density surface</span>
<span class="cm">%         ( i.e. absolute reference pressure - 10.1325 dbar )      [ dbar ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  IPV_vs_fNsquared_ratio = The ratio of the vertical gradient of</span>
<span class="cm">%          potential density referenced to p_ref, to the vertical</span>
<span class="cm">%          gradient of locally-referenced potential density.  It is</span>
<span class="cm">%          output on the same vertical (M-1)xN grid as p_mid.</span>
<span class="cm">%          IPV_vs_fNsquared_ratio is dimensionless.            [ unitless ]</span>
<span class="cm">%  p_mid = mid pressure between the individual points of the p grid.</span>
<span class="cm">%          That is, p_mid is on a (M-1)xN grid.                    [ dbar ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%    See Eqn. (3.20.5) of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., D.R. Jackett, D.G. Wright and R. Feistel, 2003:</span>
<span class="cm">%   Accurate and computationally efficient algorithms for potential</span>
<span class="cm">%   temperature and density of seawater.  J. Atmosph. Ocean. Tech., 20,</span>
<span class="cm">%   pp. 730-741.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling., 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%   The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_ipv_vs_fnsquared_ratio</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span>
<span class="w">                                          </span><span class="kt">double</span><span class="w"> </span><span class="n">p_ref</span><span class="p">,</span><span class="kt">int</span><span class="w"> </span><span class="n">nz</span><span class="p">,</span>
<span class="w">                                          </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ipv_vs_fnsquared_ratio</span><span class="p">,</span>
<span class="w">                                          </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">p_mid</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w">     </span><span class="n">k</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">dsa</span><span class="p">,</span><span class="w"> </span><span class="n">sa_mid</span><span class="p">,</span><span class="w"> </span><span class="n">dct</span><span class="p">,</span><span class="w"> </span><span class="n">ct_mid</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">alpha_mid</span><span class="p">,</span><span class="w"> </span><span class="n">beta_mid</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">alpha_pref</span><span class="p">,</span><span class="w"> </span><span class="n">beta_pref</span><span class="p">,</span><span class="w"> </span><span class="n">numerator</span><span class="p">,</span><span class="w"> </span><span class="n">denominator</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nz</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="o">*</span><span class="n">p_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ipv_vs_fnsquared_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nz</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">dsa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">      </span><span class="n">dct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">      </span><span class="n">sa_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">      </span><span class="n">ct_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ct</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">      </span><span class="n">p_mid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">      </span><span class="n">alpha_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_alpha</span><span class="p">(</span><span class="n">sa_mid</span><span class="p">,</span><span class="n">ct_mid</span><span class="p">,</span><span class="n">p_mid</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
<span class="w">      </span><span class="n">beta_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_beta</span><span class="p">(</span><span class="n">sa_mid</span><span class="p">,</span><span class="n">ct_mid</span><span class="p">,</span><span class="n">p_mid</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
<span class="w">      </span><span class="n">alpha_pref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_alpha</span><span class="p">(</span><span class="n">sa_mid</span><span class="p">,</span><span class="n">ct_mid</span><span class="p">,</span><span class="n">p_ref</span><span class="p">);</span>
<span class="w">      </span><span class="n">beta_pref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_beta</span><span class="p">(</span><span class="n">sa_mid</span><span class="p">,</span><span class="n">ct_mid</span><span class="p">,</span><span class="n">p_ref</span><span class="p">);</span>
<span class="w">      </span><span class="n">numerator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dct</span><span class="o">*</span><span class="n">alpha_pref</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dsa</span><span class="o">*</span><span class="n">beta_pref</span><span class="p">;</span>
<span class="w">      </span><span class="n">denominator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dct</span><span class="o">*</span><span class="n">alpha_mid</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">dsa</span><span class="o">*</span><span class="n">beta_mid</span><span class="p">;</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">denominator</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="n">ipv_vs_fnsquared_ratio</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="n">ipv_vs_fnsquared_ratio</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">numerator</span><span class="o">/</span><span class="n">denominator</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_melting_ice_equilibrium_SA_CT_ratio_poly    ratio of SA to CT changes</span>
<span class="cm">%                        when ice melts into a large mass of seawater, with</span>
<span class="cm">%                       both the seawater and ice temperatures being almost</span>
<span class="cm">%                      equal to the equilibrium freezing temperature (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_melting_ice_equilibrium_SA_CT_ratio_poly(SA,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratio of SA to CT changes when ice melts into seawater</span>
<span class="cm">%  with both the seawater and the seaice temperatures being almost equal to</span>
<span class="cm">%  the equilibrium freezing temperature.  It is assumed that a small mass</span>
<span class="cm">%  of ice melts into an infinite mass of seawater.  If indeed the</span>
<span class="cm">%  temperature of the seawater and the ice were both equal to the freezing</span>
<span class="cm">%  temperature, then no melting or freezing would occur; an imbalance</span>
<span class="cm">%  between these three temperatures is needed for freezing or melting to</span>
<span class="cm">%  occur (the three temperatures being (1) the seawater temperature,</span>
<span class="cm">%  (2) the ice temperature, and (3) the freezing temperature.</span>
<span class="cm">%</span>
<span class="cm">%  The output, melting_ice_equilibrium_SA_CT_ratio, is dSA/dCT rather than</span>
<span class="cm">%  dCT/dSA.  This is done so that when SA = 0, the output, dSA/dCT is zero</span>
<span class="cm">%  whereas dCT/dSA would be infinite.</span>
<span class="cm">%</span>
<span class="cm">%  Note that the 75-term equation has been fitted in a restricted range of</span>
<span class="cm">%  parameter space, and is most accurate inside the &quot;oceanographic funnel&quot;</span>
<span class="cm">%  described in McDougall et al. (2003).  The GSW library function</span>
<span class="cm">%  &quot;gsw_infunnel(SA,CT,p)&quot; is avaialble to be used if one wants to test if</span>
<span class="cm">%  some of one&#39;s data lies outside this &quot;funnel&quot;.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity of seawater                            [ g/kg ]</span>
<span class="cm">%  p   =  sea pressure at which the melting occurs                 [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  melting_ice_equilibrium_SA_CT_ratio = the ratio dSA/dCT of SA to CT</span>
<span class="cm">%                                changes when ice melts into seawater, with</span>
<span class="cm">%                                the seawater and seaice being close to the</span>
<span class="cm">%                                freezing temperature.         [ g/(kg K) ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqn. (16) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling., 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_melting_ice_equilibrium_sa_ct_ratio_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">t_seaice</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">t_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="o">*</span><span class="n">h_hat_ct</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="n">h_hat_sa</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">% gsw_melting_ice_into_seawater             Absolute Salinity, Conservative</span>
<span class="cm">%                  Temperature and final ice mass fraction when ice of mass</span>
<span class="cm">%                fraction w_Ih and temperature t_Ih is melted into seawater</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_melting_ice_into_seawater(SA,CT,p,w_Ih,t_Ih)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the final Absolute Salinity, final Conservative Temperature</span>
<span class="cm">%  and final ice mass fraction that results when a given mass fraction of</span>
<span class="cm">%  ice melts and is mixed into seawater whose properties are (SA,CT,p).</span>
<span class="cm">%  This code takes the seawater to contain no dissolved air.</span>
<span class="cm">%</span>
<span class="cm">%  When the mass fraction w_Ih_final is calculated as being a positive</span>
<span class="cm">%  value, the seawater-ice mixture is at thermodynamic equlibrium.</span>
<span class="cm">%</span>
<span class="cm">%  This code returns w_Ih_final = 0 when the input bulk enthalpy, h_bulk,</span>
<span class="cm">%  is sufficiently large (i.e. sufficiently &quot;warm&quot;) so that there is no ice</span>
<span class="cm">%  present in the final state.  In this case the final state consists of</span>
<span class="cm">%  only seawater rather than being an equlibrium mixture of seawater and</span>
<span class="cm">%  ice which occurs when w_Ih_final is positive.  Note that when</span>
<span class="cm">%  w_Ih_final = 0, the final seawater is not at the freezing temperature.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA   =  Absolute Salinity of seawater                           [ g/kg ]</span>
<span class="cm">%  CT   =  Conservative Temperature of seawater (ITS-90)          [ deg C ]</span>
<span class="cm">%  p    =  sea pressure at which the melting occurs                [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  w_Ih =  mass fraction of ice, that is the mass of ice divided by the</span>
<span class="cm">%          sum of the masses of ice and seawater.  That is, the mass of</span>
<span class="cm">%          ice divided by the mass of the final mixed fluid.</span>
<span class="cm">%          w_Ih must be between 0 and 1.                       [ unitless ]</span>
<span class="cm">%  t_Ih =  the in-situ temperature of the ice (ITS-90)            [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">%  SA, CT, w_Ih and t_Ih must all have the same dimensions.</span>
<span class="cm">%  p may have dimensions 1x1 or Mx1 or 1xN or MxN, where where SA, CT,</span>
<span class="cm">%  w_Ih and t_Ih are MxN.</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_final    =  Absolute Salinity of the seawater in the final state,</span>
<span class="cm">%                 whether or not any ice is present.               [ g/kg ]</span>
<span class="cm">%  CT_final    =  Conservative Temperature of the seawater in the the final</span>
<span class="cm">%                 state, whether or not any ice is present.       [ deg C ]</span>
<span class="cm">%  w_Ih_final  =  mass fraction of ice in the final seawater-ice mixture.</span>
<span class="cm">%                 If this ice mass fraction is positive, the system is at</span>
<span class="cm">%                 thermodynamic equilibrium.  If this ice mass fraction is</span>
<span class="cm">%                 zero there is no ice in the final state which consists</span>
<span class="cm">%                 only of seawater which is warmer than the freezing</span>
<span class="cm">%                 temperature.                                   [unitless]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of ice and sea ice into seawater, and frazil ice formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_melting_ice_into_seawater</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="n">w_ih</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">t_ih</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct_final</span><span class="p">,</span>
<span class="w">                                             </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">w_ih_final</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">h_bulk</span><span class="p">,</span><span class="w"> </span><span class="n">sa_bulk</span><span class="p">,</span><span class="w"> </span><span class="n">tf_ih</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ctf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">      </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">      </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>

<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">tf_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_ih</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tf_ih</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">      </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">      </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>

<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">sa_bulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">)</span><span class="o">*</span><span class="n">sa</span><span class="p">;</span>
<span class="w">    </span><span class="n">h_bulk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">w_ih</span><span class="p">)</span><span class="o">*</span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
<span class="w">           </span><span class="o">+</span><span class="w"> </span><span class="n">w_ih</span><span class="o">*</span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_ih</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="n">gsw_frazil_properties</span><span class="p">(</span><span class="n">sa_bulk</span><span class="p">,</span><span class="n">h_bulk</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">sa_final</span><span class="p">,</span><span class="n">ct_final</span><span class="p">,</span><span class="n">w_ih_final</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cppGSW_ERROR_LIMIT</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="o">*</span><span class="n">sa_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">      </span><span class="o">*</span><span class="n">ct_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">      </span><span class="o">*</span><span class="n">w_ih_final</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">sa_final</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">   </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">% gsw_Nsquared             buoyancy (Brunt-Vaisala) frequency squared (N^2)</span>
<span class="cm">%                                                        (75-term equation)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_Nsquared(SA,CT,p,lat)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the buoyancy frequency squared (N^2)(i.e. the Brunt-Vaisala</span>
<span class="cm">%  frequency squared) at the mid pressure from the equation,</span>
<span class="cm">%</span>
<span class="cm">%           2      2     beta.dSA - alpha.dCT</span>
<span class="cm">%         N   =  g  . -------------------------</span>
<span class="cm">%                         specvol_local.dP</span>
<span class="cm">%</span>
<span class="cm">%  The pressure increment, dP, in the above formula is in Pa, so that it is</span>
<span class="cm">%  10^4 times the pressure increment dp in dbar.</span>
<span class="cm">%</span>
<span class="cm">%  Note. This routine uses specvol from &quot;gsw_specvol&quot;, which is based on</span>
<span class="cm">%  the computationally efficient expression for specific volume in terms of</span>
<span class="cm">%  SA, CT and p (Roquet et al., 2015).</span>
<span class="cm">%</span>
<span class="cm">%  Note that this 75-term equation has been fitted in a restricted range of</span>
<span class="cm">%  parameter space, and is most accurate inside the &quot;oceanographic funnel&quot;</span>
<span class="cm">%  described in McDougall et al. (2003).  The GSW library function</span>
<span class="cm">%  &quot;gsw_infunnel(SA,CT,p)&quot; is avaialble to be used if one wants to test if</span>
<span class="cm">%  some of one&#39;s data lies outside this &quot;funnel&quot;.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity                                        [ g/kg ]</span>
<span class="cm">%  CT  =  Conservative Temperature (ITS-90)                       [ deg C ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  lat  =  latitude in decimal degrees north                [ -90 ... +90 ]</span>
<span class="cm">%  Note. If lat is not supplied, a default gravitational acceleration</span>
<span class="cm">%    of 9.7963 m/s^2 (Griffies, 2004) will be applied.</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  N2     =  Brunt-Vaisala Frequency squared  (M-1xN)             [ 1/s^2 ]</span>
<span class="cm">%  p_mid  =  Mid pressure between p grid      (M-1xN)              [ dbar ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (30th June, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  Griffies, S.M., 2004: Fundamentals of Ocean Climate Models. Princeton,</span>
<span class="cm">%   NJ: Princeton University Press, 518 pp + xxxiv.</span>
<span class="cm">%</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%    See section 3.10 and Eqn. (3.10.2) of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., D.R. Jackett, D.G. Wright and R. Feistel, 2003:</span>
<span class="cm">%   Accurate and computationally efficient algorithms for potential</span>
<span class="cm">%   temperature and density of seawater.  J. Atmosph. Ocean. Tech., 20,</span>
<span class="cm">%   pp. 730-741.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling, 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%   The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_nsquared</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">lat</span><span class="p">,</span>
<span class="w">                           </span><span class="kt">int</span><span class="w"> </span><span class="n">nz</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">n2</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">p_mid</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="kt">int</span><span class="w">     </span><span class="n">k</span><span class="p">;</span>
<span class="w">   </span><span class="kt">double</span><span class="w">  </span><span class="n">p_grav</span><span class="p">,</span><span class="w"> </span><span class="n">n_grav</span><span class="p">,</span><span class="w"> </span><span class="n">grav_local</span><span class="p">,</span><span class="w"> </span><span class="n">dsa</span><span class="p">,</span><span class="w"> </span><span class="n">sa_mid</span><span class="p">,</span><span class="w"> </span><span class="n">dct</span><span class="p">,</span><span class="w"> </span><span class="n">ct_mid</span><span class="p">,</span>
<span class="w">      </span><span class="n">dp</span><span class="p">,</span><span class="w"> </span><span class="n">rho_mid</span><span class="p">,</span><span class="w"> </span><span class="n">alpha_mid</span><span class="p">,</span><span class="w"> </span><span class="n">beta_mid</span><span class="p">;</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nz</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">   </span><span class="n">p_grav</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_grav</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

<span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">nz</span><span class="mi">-1</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">       </span><span class="n">n_grav</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_grav</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">       </span><span class="n">grav_local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">p_grav</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_grav</span><span class="p">);</span>
<span class="w">       </span><span class="n">dsa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
<span class="w">       </span><span class="n">sa_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">       </span><span class="n">dct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
<span class="w">       </span><span class="n">ct_mid</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ct</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ct</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">       </span><span class="n">dp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
<span class="w">       </span><span class="n">p_mid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">       </span><span class="n">rho_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_rho</span><span class="p">(</span><span class="n">sa_mid</span><span class="p">,</span><span class="n">ct_mid</span><span class="p">,</span><span class="n">p_mid</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
<span class="w">       </span><span class="n">alpha_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_alpha</span><span class="p">(</span><span class="n">sa_mid</span><span class="p">,</span><span class="n">ct_mid</span><span class="p">,</span><span class="n">p_mid</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
<span class="w">       </span><span class="n">beta_mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_beta</span><span class="p">(</span><span class="n">sa_mid</span><span class="p">,</span><span class="n">ct_mid</span><span class="p">,</span><span class="n">p_mid</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
<span class="w">       </span><span class="n">n2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">grav_local</span><span class="o">*</span><span class="n">grav_local</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">rho_mid</span><span class="o">/</span><span class="p">(</span><span class="n">gtc</span><span class="p">.</span><span class="n">db2pa</span><span class="o">*</span><span class="n">dp</span><span class="p">))</span><span class="o">*</span>
<span class="w">           </span><span class="p">(</span><span class="n">beta_mid</span><span class="o">*</span><span class="n">dsa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">alpha_mid</span><span class="o">*</span><span class="n">dct</span><span class="p">);</span>

<span class="w">       </span><span class="n">p_grav</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n_grav</span><span class="p">;</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_seaice_fraction_to_freeze_seawater  sea ice mass fraction, which when</span>
<span class="cm">%                                          melted into seawater, brings the</span>
<span class="cm">%                                      seawater to the freezing temperature</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_seaice_fraction_to_freeze_seawater(SA,CT,p,SA_seaice,t_seaice)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the mass fraction of sea ice (mass of sea ice divided by mass</span>
<span class="cm">%  of sea ice plus seawater), which, when melted into seawater having the</span>
<span class="cm">%  properties (SA,CT,p) causes the final seawater to be at the freezing</span>
<span class="cm">%  temperature.  The other outputs are the Absolute Salinity and</span>
<span class="cm">%  Conservative Temperature of the final seawater.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA        =  Absolute Salinity of seawater                      [ g/kg ]</span>
<span class="cm">%  CT        =  Conservative Temperature of seawater (ITS-90)     [ deg C ]</span>
<span class="cm">%  p         =  sea pressure                                       [ dbar ]</span>
<span class="cm">%            ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  SA_seaice =  Absolute Salinity of sea ice, that is, the mass fraction of</span>
<span class="cm">%               salt in sea ice, expressed in g of salt per kg of sea ice.</span>
<span class="cm">%                                                                  [ g/kg ]</span>
<span class="cm">%  t_seaice  =  in-situ temperature of the sea ice at pressure p (ITS-90)</span>
<span class="cm">%                                                                 [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_freeze  =  Absolute Salinity of seawater after the mass fraction of</span>
<span class="cm">%                sea ice, w_seaice, at temperature t_seaice has melted into</span>
<span class="cm">%                the original seawater, and the final mixture is at the</span>
<span class="cm">%                freezing temperature of seawater.                 [ g/kg ]</span>
<span class="cm">%</span>
<span class="cm">%  CT_freeze  =  Conservative Temperature of seawater after the mass</span>
<span class="cm">%                fraction, w_seaice, of sea ice at temperature t_seaice has</span>
<span class="cm">%                melted into the original seawater, and the final mixture</span>
<span class="cm">%                is at the freezing temperature of seawater.      [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">%  w_seaice   =  mass fraction of sea ice, at SA_seaice and t_seaice,</span>
<span class="cm">%                which, when melted into seawater at (SA,CT,p) leads to the</span>
<span class="cm">%                final mixed seawater being at the freezing temperature.</span>
<span class="cm">%                This output is between 0 and 1.                 [unitless]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See sections 3.33 and 3.34 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall T.J. and S.J. Wotherspoon, 2013: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqn. (23) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">void</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_seaice_fraction_to_freeze_seawater</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="n">t_seaice</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">sa_freeze</span><span class="p">,</span>
<span class="w">                                                      </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">ct_freeze</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">w_seaice</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_mean</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_old</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_plus1</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_zero</span><span class="p">,</span>
<span class="w">             </span><span class="n">dfunc_dsaf</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">,</span><span class="w"> </span><span class="n">func_plus1</span><span class="p">,</span><span class="w"> </span><span class="n">func_zero</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_brine</span><span class="p">,</span>
<span class="w">             </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">sa_freezing</span><span class="p">,</span><span class="w"> </span><span class="n">saf</span><span class="p">,</span><span class="w"> </span><span class="n">saf_mean</span><span class="p">,</span><span class="w"> </span><span class="n">saf_old</span><span class="p">,</span>
<span class="w">             </span><span class="n">salt_ratio</span><span class="p">,</span><span class="w"> </span><span class="n">tf_sa_seaice</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">,</span><span class="w"> </span><span class="n">ctf_sa</span><span class="p">,</span>
<span class="w">             </span><span class="n">sa0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ctf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ct_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">w_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">tf_sa_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_seaice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tf_sa_seaice</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ct_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">w_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">sa_freezing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_sa_freezing_from_t</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa_freezing</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cppGSW_ERROR_LIMIT</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="o">*</span><span class="n">sa_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">ct_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">w_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">h_brine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_t_exact</span><span class="p">(</span><span class="n">sa_freezing</span><span class="p">,</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">salt_ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_seaice</span><span class="o">/</span><span class="n">sa_freezing</span><span class="p">;</span>
<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf_plus1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="o">+</span><span class="mf">1.0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">func_plus1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">)</span>
<span class="w">                     </span><span class="o">*</span><span class="p">(</span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="o">+</span><span class="mf">1.0</span><span class="p">,</span><span class="n">ctf_plus1</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
<span class="w">                        </span><span class="o">-</span><span class="w"> </span><span class="n">h</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">salt_ratio</span><span class="o">*</span><span class="p">(</span><span class="n">h_brine</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf_zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">func_zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">)</span>
<span class="w">                    </span><span class="o">*</span><span class="p">(</span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa0</span><span class="p">,</span><span class="n">ctf_zero</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h</span><span class="p">)</span>
<span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="p">((</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">salt_ratio</span><span class="o">*</span><span class="p">(</span><span class="n">h_brine</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">));</span>
<span class="w">    </span><span class="n">saf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="p">(</span><span class="n">sa</span><span class="o">+</span><span class="mf">1.0</span><span class="p">)</span><span class="o">*</span><span class="n">func_zero</span><span class="o">/</span><span class="p">(</span><span class="n">func_plus1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func_zero</span><span class="p">);</span>
<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">saf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">saf</span><span class="p">,</span><span class="n">ctf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">saf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                 </span><span class="o">&amp;</span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">dfunc_dsaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="o">*</span><span class="n">ctf_sa</span><span class="p">)</span>
<span class="w">                     </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">salt_ratio</span><span class="o">*</span><span class="p">(</span><span class="n">h_brine</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<span class="w">            </span><span class="n">number_of_iterations</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">saf_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saf</span><span class="p">;</span>
<span class="w">        </span><span class="n">ctf_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctf</span><span class="p">;</span>
<span class="w">        </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">)</span>
<span class="w">                 </span><span class="o">*</span><span class="p">(</span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">saf_old</span><span class="p">,</span><span class="n">ctf_old</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h</span><span class="p">)</span>
<span class="w">                 </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">saf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">salt_ratio</span><span class="o">*</span><span class="p">(</span><span class="n">h_brine</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">));</span>
<span class="w">        </span><span class="n">saf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="o">/</span><span class="n">dfunc_dsaf</span><span class="p">;</span>
<span class="w">        </span><span class="n">saf_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">saf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">saf_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">ctf_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">saf_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">saf_mean</span><span class="p">,</span><span class="n">ctf_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                             </span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_ct_freezing_first_derivatives</span><span class="p">(</span><span class="n">saf_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">ctf_sa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">dfunc_dsaf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="o">*</span><span class="n">ctf_sa</span><span class="p">)</span>
<span class="w">                         </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">salt_ratio</span><span class="o">*</span><span class="p">(</span><span class="n">h_brine</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">);</span>
<span class="w">        </span><span class="n">saf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">func</span><span class="o">/</span><span class="n">dfunc_dsaf</span><span class="p">;</span>
<span class="w">        </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">saf</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">*</span><span class="n">sa_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">saf</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">ct_freeze</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctf</span><span class="p">;</span>
<span class="w">    </span><span class="o">*</span><span class="n">w_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="o">*</span><span class="n">sa_freeze</span><span class="p">,</span><span class="o">*</span><span class="n">ct_freeze</span><span class="p">,</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="o">/</span>
<span class="w">                    </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">salt_ratio</span><span class="o">*</span><span class="p">(</span><span class="n">h_brine</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_sound_speed_ice                               compression sound speed</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_sound_speed_ice(t,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the compression speed of sound in ice.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  t   =  in-situ temperature (ITS-90)                            [ deg C ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  sound_speed_ice  =  compression speed of sound in ice            [ m/s ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Paul Barker and Trevor McDougall                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_sound_speed_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">gi_tp</span><span class="p">,</span><span class="w"> </span><span class="n">gi_tt</span><span class="p">;</span>

<span class="w">    </span><span class="n">gi_tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gi_tp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">              </span><span class="n">sqrt</span><span class="p">(</span><span class="n">gi_tt</span><span class="o">/</span><span class="p">(</span><span class="n">gi_tp</span><span class="o">*</span><span class="n">gi_tp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gi_tt</span><span class="o">*</span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">p</span><span class="p">))));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_t_from_pt0_ice                             in-situ temperature of ice</span>
<span class="cm">% =========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_t_from_pt0_ice(pt0_ice,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates in-situ temperature from the potential temperature of ice Ih</span>
<span class="cm">%  with reference pressure, p_ref, of 0 dbar (the surface), and the</span>
<span class="cm">%  in-situ pressure.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  pt0_ice  =  potential temperature of ice Ih with reference pressure of</span>
<span class="cm">%              zero dbar (ITS-90)                                 [ deg C ]</span>
<span class="cm">%  p        =  sea pressure                                        [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  t   =  in-situ temperature (ITS-90)                            [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker.                   [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%    See appendix I of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_t_from_pt0_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">pt0_ice</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_pt_from_t_ice</span><span class="p">(</span><span class="n">pt0_ice</span><span class="p">,</span><span class="n">p0</span><span class="p">,</span><span class="n">p</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_melting_ice_SA_CT_ratio_poly           ratio of SA to CT changes when</span>
<span class="cm">%                                            ice melts into seawater (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_melting_ice_SA_CT_ratio_poly(SA,CT,p,t_Ih)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratio of SA to CT changes when ice melts into seawater.</span>
<span class="cm">%  It is assumed that a small mass of ice melts into an infinite mass of</span>
<span class="cm">%  seawater.  Because of the infinite mass of seawater, the ice will always</span>
<span class="cm">%  melt.</span>
<span class="cm">%</span>
<span class="cm">%  The output, melting_seaice_SA_CT_ratio, is dSA/dCT rather than dCT/dSA.</span>
<span class="cm">%  This is done so that when SA = 0, the output, dSA/dCT is zero whereas</span>
<span class="cm">%  dCT/dSA would be infinite.</span>
<span class="cm">%</span>
<span class="cm">%  Note that the 75-term equation has been fitted in a restricted range of</span>
<span class="cm">%  parameter space, and is most accurate inside the &quot;oceanographic funnel&quot;</span>
<span class="cm">%  described in McDougall et al. (2003).  The GSW library function</span>
<span class="cm">%  &quot;gsw_infunnel(SA,CT,p)&quot; is avaialble to be used if one wants to test if</span>
<span class="cm">%  some of one&#39;s data lies outside this &quot;funnel&quot;.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA   =  Absolute Salinity of seawater                           [ g/kg ]</span>
<span class="cm">%  CT   =  Conservative Temperature of seawater (ITS-90)          [ deg C ]</span>
<span class="cm">%  p    =  sea pressure at which the melting occurs                [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  t_Ih =  the in-situ temperature of the ice (ITS-90)            [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  melting_ice_SA_CT_ratio = the ratio of SA to CT changes when ice melts</span>
<span class="cm">%                            into a large mass of seawater</span>
<span class="cm">%                                                          [ g kg^-1 K^-1 ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqn. (13) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  Roquet, F., G. Madec, T.J. McDougall, P.M. Barker, 2015: Accurate</span>
<span class="cm">%   polynomial expressions for the density and specifc volume of seawater</span>
<span class="cm">%   using the TEOS-10 standard. Ocean Modelling., 90, pp. 29-43.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_melting_ice_sa_ct_ratio_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span>
<span class="w">                                                   </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">t_ih</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ctf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing_poly</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_ih</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_ih</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="o">*</span><span class="n">h_hat_ct</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="n">h_hat_sa</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_melting_seaice_SA_CT_ratio             ratio of SA to CT changes when</span>
<span class="cm">%                                               sea ice melts into seawater</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_melting_seaice_SA_CT_ratio(SA,CT,p,SA_seaice,t_seaice)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the ratio of SA to CT changes when sea ice melts into</span>
<span class="cm">%  seawater.  It is assumed that a small mass of sea ice melts into an</span>
<span class="cm">%  infinite mass of seawater.  Because of the infinite mass of seawater,</span>
<span class="cm">%  the sea ice will always melt.</span>
<span class="cm">%</span>
<span class="cm">%  Ice formed at the sea surface (sea ice) typically contains between 2 g/kg</span>
<span class="cm">%  and 12 g/kg of salt (defined as the mass of salt divided by the mass of</span>
<span class="cm">%  ice Ih plus brine) and this programme returns NaN&#39;s if the input</span>
<span class="cm">%  SA_seaice is greater than 15 g/kg.  If the SA_seaice input is not zero,</span>
<span class="cm">%  usually this would imply that the pressure p should be zero, as sea ice</span>
<span class="cm">%  only occurs near the sea surface.  The code does not impose that p = 0</span>
<span class="cm">%  if SA_seaice is non-zero.  Rather, this is left to the user.</span>
<span class="cm">%</span>
<span class="cm">%  The Absolute Salinity, SA_brine, of the brine trapped in little pockets</span>
<span class="cm">%  in the sea ice, is in thermodynamic equilibrium with the ice Ih that</span>
<span class="cm">%  surrounds these pockets.  As the seaice temperature, t_seaice, may be</span>
<span class="cm">%  less than the freezing temperature, SA_brine is usually greater than the</span>
<span class="cm">%  Absolute Salinity of the seawater at the time and place when and where</span>
<span class="cm">%  the sea ice was formed.  So usually SA_brine will be larger than SA.</span>
<span class="cm">%</span>
<span class="cm">%  The output, melting_seaice_SA_CT_ratio, is dSA/dCT rather than dCT/dSA.</span>
<span class="cm">%  This is done so that when (SA - seaice_SA) = 0, the output, dSA/dCT is</span>
<span class="cm">%  zero whereas dCT/dSA would be infinite.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SA  =  Absolute Salinity of seawater                            [ g/kg ]</span>
<span class="cm">%  CT  =  Conservative Temperature of seawater (ITS-90)           [ deg C ]</span>
<span class="cm">%  p   =  sea pressure at which the melting occurs                 [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  SA_seaice =  Absolute Salinity of sea ice, that is, the mass fraction</span>
<span class="cm">%               of salt in sea ice expressed in g of salt per kg of</span>
<span class="cm">%               sea ice                                            [ g/kg ]</span>
<span class="cm">%  t_seaice =   the in-situ temperature of the sea ice (ITS-90)   [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  melting_seaice_SA_CT_ratio = the ratio dSA/dCT of SA to CT changes when</span>
<span class="cm">%                sea ice melts into a large mass of seawater   [ g/(kg K) ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%    See Eqn. (28) of this manuscript.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_melting_seaice_sa_ct_ratio</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">t_seaice</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">ctf</span><span class="p">,</span><span class="w"> </span><span class="n">delsa</span><span class="p">,</span><span class="w"> </span><span class="n">h</span><span class="p">,</span><span class="w"> </span><span class="n">h_brine</span><span class="p">,</span><span class="w"> </span><span class="n">h_ih</span><span class="p">,</span><span class="w"> </span><span class="n">sa_brine</span><span class="p">,</span>
<span class="w">              </span><span class="n">tf_sa_seaice</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_sa</span><span class="p">,</span><span class="w"> </span><span class="n">h_hat_ct</span><span class="p">,</span>
<span class="w">              </span><span class="n">saturation_fraction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa_seaice</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sa_seaice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">15.0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">ctf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>

<span class="w">   </span><span class="cm">/*the seawater ct input is below the freezing temp*/</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ctf</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">tf_sa_seaice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing</span><span class="p">(</span><span class="n">sa_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1e-6</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">t_seaice</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">tf_sa_seaice</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">       </span><span class="cm">/*t_seaice exceeds the freezing sa*/</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">h</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">h_ih</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_ice</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_enthalpy_first_derivatives_ct_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">ct</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_sa</span><span class="p">,</span><span class="o">&amp;</span><span class="n">h_hat_ct</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa_brine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_sa_freezing_from_t</span><span class="p">(</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa_brine</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cppGSW_ERROR_LIMIT</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">h_brine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_enthalpy_t_exact</span><span class="p">(</span><span class="n">sa_brine</span><span class="p">,</span><span class="n">t_seaice</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">delsa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa_seaice</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">h_hat_ct</span><span class="o">*</span><span class="n">delsa</span><span class="w"> </span><span class="o">/</span>
<span class="w">              </span><span class="p">(</span><span class="n">h</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">delsa</span><span class="o">*</span><span class="n">h_hat_sa</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa_seaice</span><span class="o">*</span><span class="p">(</span><span class="n">h_brine</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h_ih</span><span class="p">)</span><span class="o">/</span><span class="n">sa_brine</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">% gsw_deltaSA_from_SP                             Absolute Salinity Anomaly</span>
<span class="cm">%                                                   from Practical Salinity</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  deltaSA = gsw_deltaSA_from_SP(SP,p,long,lat)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates Absolute Salinity Anomaly from Practical Salinity.  Since SP</span>
<span class="cm">%  is non-negative by definition, this function changes any negative input</span>
<span class="cm">%  values of SP to be zero.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  SP   =  Practical Salinity  (PSS-78)                        [ unitless ]</span>
<span class="cm">%  p    =  sea pressure                                            [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%  long =  longitude in decimal degrees                      [ 0 ... +360 ]</span>
<span class="cm">%                                                     or  [ -180 ... +180 ]</span>
<span class="cm">%  lat  =  latitude in decimal degrees north                [ -90 ... +90 ]</span>
<span class="cm">%</span>
<span class="cm">%  p, lat &amp; long may have dimensions 1x1 or Mx1 or 1xN or MxN,</span>
<span class="cm">%  where SP is MxN.</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  deltaSA  =  Absolute Salinity Anomaly                           [ g/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall &amp; Paul Barker                      [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%    See section 2.5 and appendices A.4 and A.5 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., D.R. Jackett, F.J. Millero, R. Pawlowicz and</span>
<span class="cm">%   P.M. Barker, 2012: A global algorithm for estimating Absolute Salinity.</span>
<span class="cm">%   Ocean Science, 8, 1117-1128.</span>
<span class="cm">%   http://www.ocean-sci.net/8/1117/2012/os-8-1117-2012.pdf</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_deltasa_from_sp</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sp</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">lon</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">lat</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_sa_from_sp</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gsw_sr_from_sp</span><span class="p">(</span><span class="n">sp</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">cppGSW_ERROR_LIMIT</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_SA_freezing_from_CT_poly             Absolute Salinity of seawater at</span>
<span class="cm">%                                                 the freezing point (poly)</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_SA_freezing_from_CT_poly(CT,p,saturation_fraction)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the Absolute Salinity of seawater at the freezing temperature.</span>
<span class="cm">%  That is, the output is the Absolute Salinity of seawater, with the</span>
<span class="cm">%  fraction saturation_fraction of dissolved air, that is in equilibrium</span>
<span class="cm">%  with ice at Conservative Temperature CT and pressure p.  If the input</span>
<span class="cm">%  values are such that there is no positive value of Absolute Salinity for</span>
<span class="cm">%  which seawater is frozen, the output, SA_freezing, is put equal to NaN.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  CT  =  Conservative Temperature (ITS-90)                       [ deg C ]</span>
<span class="cm">%  p   =  sea pressure                                             [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OPTIONAL:</span>
<span class="cm">%  saturation_fraction  =  the saturation fraction of dissolved air in</span>
<span class="cm">%                          seawater</span>
<span class="cm">%  (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">%    is 0, air free)</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  SA_freezing =  Absolute Salinity of seawater when it freezes, for</span>
<span class="cm">%                 given input values of Conservative Temperature</span>
<span class="cm">%                 pressure and air saturation fraction.            [ g/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org.</span>
<span class="cm">%    See section 3.33 of this TEOS-10 Manual.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall T. J. and S. J. Wotherspoon, 2014: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_sa_freezing_from_ct_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">ct</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                </span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i_iter</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">ct_freezing</span><span class="p">,</span><span class="w"> </span><span class="n">ct_freezing_zero_sa</span><span class="p">,</span><span class="w"> </span><span class="n">dct_dsa</span><span class="p">,</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="w"> </span><span class="n">sa_old</span><span class="p">,</span><span class="w"> </span><span class="n">sa_mean</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">sa_cut_off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">2.5</span><span class="p">;</span>
<span class="w">    </span><span class="n">ct_freezing_zero_sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">ct_freezing_zero_sa</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_sa_freezing_estimate</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ct</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">-</span><span class="n">sa_cut_off</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="w">    </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_max_d</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="n">gsw_ct_freezing_first_derivatives_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span>
<span class="w">                                                        </span><span class="o">&amp;</span><span class="n">dct_dsa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fabs</span><span class="p">(</span><span class="n">sa</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sa_cut_off</span><span class="p">)</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ct</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct_freezing_zero_sa</span><span class="p">)</span><span class="o">/</span><span class="n">dct_dsa</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i_iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i_iter</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">number_of_iterations</span><span class="p">;</span><span class="w"> </span><span class="n">i_iter</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">sa_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa</span><span class="p">;</span>
<span class="w">        </span><span class="n">ct_freezing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_ct_freezing_poly</span><span class="p">(</span><span class="n">sa_old</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">);</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">ct_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct</span><span class="p">)</span><span class="o">/</span><span class="n">dct_dsa</span><span class="p">;</span>
<span class="w">        </span><span class="n">sa_mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">sa</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">gsw_ct_freezing_first_derivatives_poly</span><span class="p">(</span><span class="n">sa_mean</span><span class="p">,</span><span class="n">p</span><span class="p">,</span>
<span class="w">                                                            </span><span class="n">saturation_fraction</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dct_dsa</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">        </span><span class="n">sa</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sa_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">ct_freezing</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ct</span><span class="p">)</span><span class="o">/</span><span class="n">dct_dsa</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gsw_sa_p_inrange</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">))</span>
<span class="w">   </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">sa</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">cppGSW_INVALID_VALUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_specvol_from_pot_enthalpy_ice                    specific volume from</span>
<span class="cm">%                                                 potential enthalpy of ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  specvol_ice = gsw_specvol_from_pot_enthalpy_ice(pot_enthalpy_ice,p)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the specific volume of ice from the potential enthalpy</span>
<span class="cm">%  of ice.  The reference sea pressure of the potential enthalpy is zero</span>
<span class="cm">%  dbar.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  pot_enthalpy_ice  =  potential enthalpy of ice                  [ J/kg ]</span>
<span class="cm">%  p  =  sea pressure                                              [ dbar ]</span>
<span class="cm">%         ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  specvol_ice  =  specific volume                               [ m^3/kg ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall T. J. and S. J. Wotherspoon, 2014: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_specvol_from_pot_enthalpy_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pt_from_pot_enthalpy_ice</span><span class="p">(</span><span class="n">pot_enthalpy_ice</span><span class="p">);</span>

<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">t_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_from_pt0_ice</span><span class="p">(</span><span class="n">pt0_ice</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>

<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">gsw_specvol_ice</span><span class="p">(</span><span class="n">t_ice</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************</span>
<span class="cm">% gsw_pt_from_pot_enthalpy_ice      potential temperature of ice refered to</span>
<span class="cm">%                                the surface from potential enthalpy of ice</span>
<span class="cm">%==========================================================================</span>
<span class="cm">%</span>
<span class="cm">% USAGE:</span>
<span class="cm">%  gsw_pt_from_pot_enthalpy_ice(pot_enthalpy_ice)</span>
<span class="cm">%</span>
<span class="cm">% DESCRIPTION:</span>
<span class="cm">%  Calculates the potential temperature of ice from the potential enthalpy</span>
<span class="cm">%  of ice.  The reference sea pressure of both the potential temperature</span>
<span class="cm">%  and the potential enthalpy is zero dbar.</span>
<span class="cm">%</span>
<span class="cm">% INPUT:</span>
<span class="cm">%  pot_enthalpy_ice  =  potential enthalpy of ice                  [ J/kg ]</span>
<span class="cm">%</span>
<span class="cm">% OUTPUT:</span>
<span class="cm">%  pt0_ice  =  potential temperature of ice (ITS-90)              [ deg C ]</span>
<span class="cm">%</span>
<span class="cm">% AUTHOR:</span>
<span class="cm">%  Trevor McDougall and Paul Barker                    [ help@teos-10.org ]</span>
<span class="cm">%</span>
<span class="cm">% VERSION NUMBER: 3.06.12 (25th May, 2020)</span>
<span class="cm">%</span>
<span class="cm">% REFERENCES:</span>
<span class="cm">%  IOC, SCOR and IAPSO, 2010: The international thermodynamic equation of</span>
<span class="cm">%   seawater - 2010: Calculation and use of thermodynamic properties.</span>
<span class="cm">%   Intergovernmental Oceanographic Commission, Manuals and Guides No. 56,</span>
<span class="cm">%   UNESCO (English), 196 pp.  Available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%  McDougall, T.J., P.M. Barker, R. Feistel and B.K. Galton-Fenzi, 2014:</span>
<span class="cm">%   Melting of Ice and Sea Ice into Seawater and Frazil Ice Formation.</span>
<span class="cm">%   Journal of Physical Oceanography, 44, 1751-1775.</span>
<span class="cm">%</span>
<span class="cm">%  McDougall T. J. and S. J. Wotherspoon, 2014: A simple modification of</span>
<span class="cm">%   Newton&#39;s method to achieve convergence of order 1 + sqrt(2).  Applied</span>
<span class="cm">%   Mathematics Letters, 29, 20-25.</span>
<span class="cm">%</span>
<span class="cm">%  The software is available from http://www.TEOS-10.org</span>
<span class="cm">%</span>
<span class="cm">%==========================================================================</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pt_from_pot_enthalpy_ice</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">iteration</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">df_dt</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">mod_pot_enthalpy_ice</span><span class="p">,</span><span class="w"> </span><span class="n">pt0_cold_ice</span><span class="p">,</span><span class="w"> </span><span class="n">recip_df_dt</span><span class="p">,</span>
<span class="w">             </span><span class="n">pt0_cold_ice_old</span><span class="p">,</span><span class="w"> </span><span class="n">pt0_ice</span><span class="p">,</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="p">,</span><span class="w"> </span><span class="n">ptm_cold_ice</span><span class="p">,</span><span class="w"> </span><span class="n">ptm_ice</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">h00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-6.320202333358860e5</span><span class="p">,</span><span class="w"> </span><span class="cm">/*gsw_enthalpy_ice(-gtc.gsw_t0,0)*/</span>
<span class="w">              </span><span class="n">p0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="n">mod_pot_enthalpy_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_max_d</span><span class="p">(</span><span class="n">pot_enthalpy_ice</span><span class="p">,</span><span class="n">h00</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mod_pot_enthalpy_ice</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">-5.1e5</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pt_from_pot_enthalpy_ice_poly</span><span class="p">(</span><span class="n">mod_pot_enthalpy_ice</span><span class="p">);</span>
<span class="w">        </span><span class="n">recip_df_dt</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">gsw_pt_from_pot_enthalpy_ice_poly_dh</span><span class="p">(</span><span class="n">mod_pot_enthalpy_ice</span><span class="p">);</span>
<span class="w">        </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice</span><span class="p">;</span>
<span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pot_enthalpy_from_pt_ice</span><span class="p">(</span><span class="n">pt0_ice_old</span><span class="p">)</span>
<span class="w">             </span><span class="o">-</span><span class="w"> </span><span class="n">mod_pot_enthalpy_ice</span><span class="p">;</span>
<span class="w">        </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">*</span><span class="n">recip_df_dt</span><span class="p">;</span>
<span class="w">        </span><span class="n">ptm_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="p">);</span>
<span class="w">        </span><span class="n">recip_df_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="o">/</span><span class="n">gsw_cp_ice</span><span class="p">(</span><span class="n">ptm_ice</span><span class="p">,</span><span class="n">p0</span><span class="p">);</span>
<span class="w">        </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">*</span><span class="n">recip_df_dt</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">pt0_cold_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pt0_cold_ice_poly</span><span class="p">(</span><span class="n">mod_pot_enthalpy_ice</span><span class="p">);</span>
<span class="w">        </span><span class="n">df_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_cp_ice</span><span class="p">(</span><span class="n">pt0_cold_ice</span><span class="o">+</span><span class="mf">0.02</span><span class="p">,</span><span class="n">p0</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">iteration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">iteration</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"> </span><span class="n">iteration</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">pt0_cold_ice_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_cold_ice</span><span class="p">;</span>
<span class="w">            </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_pot_enthalpy_from_pt_ice</span><span class="p">(</span><span class="n">pt0_cold_ice_old</span><span class="p">)</span>
<span class="w">                 </span><span class="o">-</span><span class="w"> </span><span class="n">mod_pot_enthalpy_ice</span><span class="p">;</span>
<span class="w">            </span><span class="n">pt0_cold_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_cold_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">df_dt</span><span class="p">;</span>
<span class="w">            </span><span class="n">ptm_cold_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">pt0_cold_ice</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pt0_cold_ice_old</span><span class="p">);</span>
<span class="w">            </span><span class="n">df_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_cp_ice</span><span class="p">(</span><span class="n">ptm_cold_ice</span><span class="o">+</span><span class="mf">0.02</span><span class="p">,</span><span class="n">p0</span><span class="p">);</span>
<span class="w">            </span><span class="n">pt0_cold_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_cold_ice_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">df_dt</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">pt0_ice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pt0_cold_ice</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">pt0_ice</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">==========================================================================</span>
<span class="cm">method: gsw_t_freezing_exact (sa,p,saturation_fraction)</span>
<span class="cm">==========================================================================</span>
<span class="cm">   Calculates the in-situ temperature at which seawater freezes. The</span>
<span class="cm">   in-situ temperature freezing point is calculated from the exact</span>
<span class="cm">   in-situ freezing temperature which is found by a modified Newton-Raphson</span>
<span class="cm">   iteration (McDougall and Wotherspoon, 2013) of the equality of the</span>
<span class="cm">   chemical potentials of water in seawater and in ice.</span>
<span class="cm">   An alternative GSW function, gsw_t_freezing_poly, it is based on a</span>
<span class="cm">   computationally-efficient polynomial, and is accurate to within -5e-4 K</span>
<span class="cm">   and 6e-4 K, when compared with this function.</span>
<span class="cm">   SA    :  Absolute Salinity               [ g/kg ]</span>
<span class="cm">   p  :  sea pressure                    [ dbar ]</span>
<span class="cm">     ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">   saturation_fraction : the saturation fraction of dissolved air in</span>
<span class="cm">          seawater</span>
<span class="cm">   (i.e., saturation_fraction must be between 0 and 1, and the default</span>
<span class="cm">     is 1, completely saturated)</span>
<span class="cm">   t_freezing : in-situ temperature at which seawater freezes.    [ deg C ]</span>
<span class="cm">---------------------------------------------------------------------------</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_t_freezing_exact</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">df_dt</span><span class="p">,</span><span class="w"> </span><span class="n">tf</span><span class="p">,</span><span class="w"> </span><span class="n">tfm</span><span class="p">,</span><span class="w"> </span><span class="n">tf_old</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">return_value</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">polynomial</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gsw_t_freezing_poly</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">saturation_fraction</span><span class="p">,</span><span class="n">polynomial</span><span class="p">);</span>
<span class="w">    </span><span class="n">df_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e3</span><span class="o">*</span><span class="n">gsw_t_deriv_chem_potential_water_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span>
<span class="w">    </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tf</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">tf_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="p">;</span>
<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e3</span><span class="o">*</span><span class="n">gsw_chem_potential_water_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf_old</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span>
<span class="w">    </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tf_old</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">df_dt</span><span class="p">;</span>
<span class="w">    </span><span class="n">tfm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">tf</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">tf_old</span><span class="p">);</span>
<span class="w">    </span><span class="n">df_dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e3</span><span class="o">*</span><span class="n">gsw_t_deriv_chem_potential_water_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tfm</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span>
<span class="w">    </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tfm</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">df_dt</span><span class="p">;</span>
<span class="w">    </span><span class="n">tf_old</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="p">;</span>
<span class="w">    </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1e3</span><span class="o">*</span><span class="n">gsw_chem_potential_water_t_exact</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span><span class="n">tf_old</span><span class="p">,</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">-</span>
<span class="w">    </span><span class="n">gsw_gibbs_ice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">tf_old</span><span class="p">,</span><span class="n">p</span><span class="p">);</span>
<span class="w">    </span><span class="n">tf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf_old</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">df_dt</span><span class="p">;</span>
<span class="w">    </span><span class="n">return_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tf</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">saturation_fraction</span><span class="o">*</span><span class="p">(</span><span class="mf">1e-3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.4</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">sa</span><span class="o">/</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_sso</span><span class="p">));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">return_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">==========================================================================</span>
<span class="cm">  method: gsw_sa_p_inrange (sa, p)</span>
<span class="cm">==========================================================================</span>
<span class="cm">   Check for any values that are out of the TEOS-10 range ...</span>
<span class="cm">   SA    :  Absolute Salinity               [ g/kg ]</span>
<span class="cm">   p  :  sea pressure                    [ dbar ]</span>
<span class="cm">     ( i.e. absolute pressure - 10.1325 dbar )</span>
<span class="cm">---------------------------------------------------------------------------</span>
<span class="cm">***************************************************************************/</span>
<span class="kt">int</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_sa_p_inrange</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">sa</span><span class="p">,</span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">10000.0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">sa</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">120.0</span><span class="w"> </span><span class="o">||</span>
<span class="w">            </span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sa</span><span class="o">*</span><span class="mf">71.428571428571402</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">13571.42857142857</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************************************</span>
<span class="cm">==========================================================================</span>
<span class="cm">  method: gsw_pt0_cold_ice_poly (pot_enthalpy_ice)</span>
<span class="cm">==========================================================================</span>
<span class="cm">   Calculates an initial estimate of pt0_ice when it is less than about</span>
<span class="cm">   -100 deg C.</span>
<span class="cm">   pot_enthalpy_ice  :  potential enthalpy of ice        [ J/kg ]</span>
<span class="cm">   pt0_cold_ice_poly  :  initial estimate of potential temperatur</span>
<span class="cm">          of very cold ice in dgress C (not K)     [ deg C ]</span>
<span class="cm">--------------------------------------------------------------------------</span>
<span class="cm">*************************************************************************/</span>
<span class="kt">double</span><span class="w"> </span><span class="n">TeosIce</span><span class="o">::</span><span class="n">gsw_pt0_cold_ice_poly</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">pot_enthalpy_ice</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w">  </span><span class="n">log_abs_theta0</span><span class="p">,</span><span class="w"> </span><span class="n">log_h_diff</span><span class="p">,</span>
<span class="w">              </span><span class="n">h00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-6.320202333358860e5</span><span class="p">,</span>
<span class="w">              </span><span class="n">s0</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">1.493103204647916</span><span class="p">,</span>
<span class="w">              </span><span class="n">s1</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.372788609320607e-1</span><span class="p">,</span>
<span class="w">              </span><span class="n">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.014996002119374e-3</span><span class="p">,</span>
<span class="w">              </span><span class="n">s3</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.640600197732682e-6</span><span class="p">,</span>
<span class="w">              </span><span class="n">s4</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">3.134706016844293e-5</span><span class="p">,</span>
<span class="w">              </span><span class="n">s5</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">2.733592344937913e-6</span><span class="p">,</span>
<span class="w">              </span><span class="n">s6</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">4.726828010223258e-8</span><span class="p">,</span>
<span class="w">              </span><span class="n">s7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-2.735193883189589e-9</span><span class="p">,</span>
<span class="w">              </span><span class="n">s8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">-8.547714991377670e-11</span><span class="p">;</span>

<span class="w">    </span><span class="n">log_h_diff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">pot_enthalpy_ice</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">h00</span><span class="p">);</span>

<span class="w">    </span><span class="n">log_abs_theta0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s0</span>
<span class="w">                      </span><span class="o">+</span><span class="w"> </span><span class="n">log_h_diff</span><span class="o">*</span><span class="p">(</span><span class="n">s1</span>
<span class="w">                      </span><span class="o">+</span><span class="w"> </span><span class="n">log_h_diff</span><span class="o">*</span><span class="p">(</span><span class="n">s2</span>
<span class="w">                      </span><span class="o">+</span><span class="w"> </span><span class="n">log_h_diff</span><span class="o">*</span><span class="p">(</span><span class="n">s3</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">log_h_diff</span><span class="o">*</span><span class="p">(</span><span class="n">s4</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">log_h_diff</span><span class="o">*</span><span class="p">(</span><span class="n">s5</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">log_h_diff</span><span class="o">*</span><span class="p">(</span><span class="n">s6</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">log_h_diff</span><span class="o">*</span><span class="p">(</span><span class="n">s7</span>
<span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">log_h_diff</span><span class="o">*</span><span class="n">s8</span><span class="p">)))))));</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">exp</span><span class="p">(</span><span class="n">log_abs_theta0</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">gtc</span><span class="p">.</span><span class="n">gsw_t0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Seabot2 Team, ENSTA.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>